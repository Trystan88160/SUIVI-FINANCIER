<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Financier</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Outfit:wght@300;500;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <style>
:root{--bg-primary:#e8f0f7;--bg-secondary:#f5f9fc;--bg-card:#ffffff;--text-primary:#1e3a5f;--text-secondary:#4a6785;--text-tertiary:#7891ab;--accent-primary:#3f51b5;--accent-secondary:#5c6bc0;--accent-gradient-start:#3f51b5;--accent-gradient-end:#7c4dff;--success:#00c853;--warning:#ff9800;--danger:#f44336;--border-color:#d4e2ed;--shadow-light:rgba(174,195,217,0.4);--shadow-dark:rgba(255,255,255,0.9);--heatmap-rgb:63,81,181}[data-theme=dark]{--bg-primary:#1e2a3a;--bg-secondary:#131f2d;--bg-card:#2a3f55;--text-primary:#e0f2fe;--text-secondary:#a5c8e4;--text-tertiary:#7aaac8;--accent-primary:#a855f7;--accent-secondary:#67e8f9;--accent-gradient-start:#a855f7;--accent-gradient-end:#38bdf8;--border-color:rgba(56,189,248,0.25);--success:#00c853;--warning:#ff9800;--danger:#f44336;--shadow-light:rgba(0,0,0,0.4);--shadow-dark:rgba(56,189,248,0.08);--heatmap-rgb:168,85,247}*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:linear-gradient(135deg,#e0eafc 0%,#cfdef3 100%);color:var(--text-primary);line-height:1.6;transition:background .3s,color .3s;overflow-x:hidden}#zoom-wrapper{width:100%;transform-origin:top left;will-change:transform}.container{max-width:1400px;margin:0 auto;padding:2rem}.header{background:var(--bg-card);padding:2rem 3rem;border-radius:20px;margin-bottom:2rem;box-shadow:16px 16px 32px var(--shadow-light),-16px -16px 32px var(--shadow-dark);display:flex;justify-content:space-between;align-items:center}.header h1{font-size:2.5rem;font-weight:700;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent;font-family:'Outfit',sans-serif}.header-controls{display:flex;gap:1rem}.header-controls{display:flex;gap:1rem;align-items:center}.backup-reminder{padding:.5rem 1rem;background:var(--warning);color:var(--text-primary);border-radius:4px;font-size:.875rem;animation:pulse 2s infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}.nav-tabs{display:flex;gap:.5rem;margin-bottom:2rem;background:var(--bg-card);padding:.5rem;border-radius:16px;box-shadow:12px 12px 24px var(--shadow-light),-12px -12px 24px var(--shadow-dark);border-bottom:none;overflow-x:auto}.nav-tab{padding:.75rem 1.5rem;background:transparent;border:none;color:var(--text-secondary);cursor:pointer;font-family:'Inter',sans-serif;font-size:.9rem;font-weight:600;text-transform:uppercase;letter-spacing:.05em;transition:all .3s;white-space:nowrap;border-radius:12px}.nav-tab:hover{color:var(--text-primary)}.nav-tab.active{background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));color:#fff;box-shadow:4px 4px 8px rgba(63,81,181,0.3),-4px -4px 8px rgba(255,255,255,0.5)}.tab-content{display:none;animation:fadeIn .3s ease-in}.tab-content.active{display:block}@keyframes fadeIn{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}.card{background:var(--bg-card);border:none;padding:2rem;margin-bottom:2rem;box-shadow:16px 16px 32px var(--shadow-light),-16px -16px 32px var(--shadow-dark);transition:all .3s;border-radius:20px}.card:hover{box-shadow:20px 20px 40px var(--shadow-light),-20px -20px 40px var(--shadow-dark);transform:translateY(-2px)}.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}.card-title{font-size:1.5rem;font-weight:700;letter-spacing:-.01em;font-family:'Outfit',sans-serif;color:var(--text-primary)}.grid{display:grid;gap:1.5rem}.grid-2{grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}.grid-3{grid-template-columns:repeat(auto-fit,minmax(250px,1fr))}.grid-4{grid-template-columns:repeat(auto-fit,minmax(200px,1fr))}.stat-card{background:var(--bg-card);border:none;padding:2rem;text-align:center;border-radius:20px;box-shadow:16px 16px 32px var(--shadow-light),-16px -16px 32px var(--shadow-dark);transition:all .3s}.stat-card.warning{border-left:4px solid var(--warning)}.stat-card.danger{border-left:4px solid var(--danger)}
.stat-card:hover{transform:translateY(-5px);box-shadow:20px 20px 40px var(--shadow-light),-20px -20px 40px var(--shadow-dark)}.stat-label{font-family:'Inter',sans-serif;font-size:.75rem;text-transform:uppercase;letter-spacing:.1em;color:var(--text-tertiary);margin-bottom:.75rem;font-weight:600}.stat-value{font-size:2.5rem;font-weight:700;color:var(--text-primary);margin-bottom:.5rem;font-family:'Outfit',sans-serif}.stat-card-main .stat-value{background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat-value.accent{background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent}.stat-change{font-family:'Inter',sans-serif;font-size:.9rem;font-weight:600;margin-top:.5rem}.stat-change.positive{color:var(--success)}.stat-change.negative{color:var(--danger)}.form-group{margin-bottom:1.5rem}.form-label{display:block;font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-secondary);margin-bottom:.5rem}.form-input,.form-select{width:100%;padding:.75rem;background:var(--bg-secondary);border:1px solid var(--border-color);color:var(--text-primary);font-family:'Crimson Pro',serif;font-size:1rem;transition:border-color .2s,background .2s;border-radius:12px}.form-input:focus,.form-select:focus{outline:0;border-color:var(--accent-primary);background:var(--bg-card)}.btn{padding:.75rem 1.5rem;background:var(--bg-card);color:var(--accent-primary);border:none;cursor:pointer;font-family:'DM Mono',monospace;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em;transition:all .3s;border-radius:12px;box-shadow:8px 8px 16px var(--shadow-light),-8px -8px 16px var(--shadow-dark);font-weight:600}.btn:hover{box-shadow:4px 4px 8px var(--shadow-light),-4px -4px 8px var(--shadow-dark);transform:translateY(-2px)}.btn-primary{background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));color:#fff;box-shadow:8px 8px 16px rgba(63,81,181,0.3),-8px -8px 16px rgba(255,255,255,0.8)}.btn-secondary{background:var(--bg-secondary);color:var(--text-primary)}.btn-secondary:hover{background:var(--border-color)}.btn-small{padding:.5rem 1rem;font-size:.75rem}.btn-icon{width:36px;height:36px;padding:0;display:flex;align-items:center;justify-content:center}.btn-gear{position:absolute;top:1rem;right:1rem;background:var(--bg-tertiary);border:1px solid var(--border-color);width:32px;height:32px;display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all .2s;font-size:1rem}.btn-gear:hover{background:var(--border-color);transform:rotate(90deg)}.table-container{overflow-x:auto}.table{width:100%;border-collapse:collapse}.table td,.table th{padding:1rem;text-align:left;border-bottom:1px solid var(--border-color)}.table th{font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;color:var(--text-tertiary);font-weight:500}.table tbody tr:hover{background:var(--bg-tertiary)}.table-input{width:100%;padding:.5rem;background:0 0;border:1px solid transparent;color:var(--text-primary);font-family:'Crimson Pro',serif}.table-input:focus{background:var(--bg-tertiary);border-color:var(--accent-primary);outline:0}.settings-panel{position:fixed;top:0;right:-400px;width:400px;height:100vh;background:var(--bg-secondary);border-left:1px solid var(--border-color);padding:2rem;overflow-y:auto;transition:right .3s;z-index:1000;box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}.settings-panel.open{right:0}.settings-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:2rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);display:none;z-index:999}.overlay.active{display:block}.modal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--bg-secondary);border:1px solid var(--border-color);padding:2rem;max-width:500px;width:90%;z-index:1001;box-shadow:0 20px 25px -5px rgba(0,0,0,.1);display:none}.modal.active{display:block;animation:modalSlide .3s ease-out}@keyframes modalSlide{from{opacity:0;transform:translate(-50%,-45%)}to{opacity:1;transform:translate(-50%,-50%)}}.modal-header{margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:1px solid var(--border-color)}.modal-title{font-size:1.5rem;font-weight:400}.modal-body{margin-bottom:1.5rem;line-height:1.8}.modal-footer{display:flex;gap:1rem;justify-content:flex-end}.chart-container{position:relative;height:400px;margin:1.5rem 0;padding:1.5rem;background:var(--bg-secondary);border-radius:16px;box-shadow:inset 8px 8px 16px rgba(174,195,217,0.3),inset -8px -8px 16px rgba(255,255,255,0.7)}.chart-container canvas{max-height:100%}.toggle{position:relative;display:inline-block;width:50px;height:24px}.toggle input{opacity:0;width:0;height:0}.toggle-slider{position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:var(--border-color);transition:.3s;border-radius:24px}.toggle-slider:before{position:absolute;content:"";height:18px;width:18px;left:3px;bottom:3px;background-color:#fff;transition:.3s;border-radius:50%}.toggle input:checked+.toggle-slider{background-color:var(--accent-primary)}.toggle input:checked+.toggle-slider:before{transform:translateX(26px)}.category-tag{display:inline-block;padding:.25rem .75rem;font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;border-radius:2px;background:var(--bg-tertiary);color:var(--text-secondary)}.progress-bar{width:100%;height:12px;background:var(--bg-secondary);border-radius:10px;overflow:hidden;margin:1rem 0;box-shadow:inset 4px 4px 8px var(--shadow-light),inset -4px -4px 8px var(--shadow-dark)}.progress-fill{height:100%;background:linear-gradient(90deg,var(--accent-gradient-start),var(--accent-gradient-end));transition:width .3s;border-radius:10px}.progress-fill.warning{background:linear-gradient(90deg,#ff9800,#ffb74d)}.progress-fill.danger{background:linear-gradient(90deg,#f44336,#e57373)}.card-tabs{display:flex;gap:.5rem;margin-bottom:1rem;border-bottom:1px solid var(--border-color)}.card-tab{padding:.5rem 1rem;background:0 0;border:none;border-bottom:2px solid transparent;color:var(--text-secondary);cursor:pointer;font-family:'DM Mono',monospace;font-size:.75rem;text-transform:uppercase;letter-spacing:.05em;transition:all .2s}.card-tab:hover{color:var(--text-primary)}.card-tab.active{color:var(--accent-primary);border-bottom-color:var(--accent-primary)}.period-selector{display:flex;gap:.5rem;margin-bottom:1rem;flex-wrap:wrap}.period-btn{padding:.5rem 1rem;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-secondary);cursor:pointer;font-family:'DM Mono',monospace;font-size:.75rem;transition:all .2s}.period-btn:hover{background:var(--border-color)}.period-btn.active{background:var(--accent-primary);color:#fff;border-color:var(--accent-primary)}.notification{position:fixed;top:20px;right:20px;padding:1rem 1.5rem;background:var(--bg-secondary);border:1px solid var(--border-color);box-shadow:0 10px 15px -3px rgba(0,0,0,.1);max-width:400px;z-index:2000;animation:slideIn .3s ease-out}@keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}.notification.success{border-left:4px solid var(--success)}.notification.error{border-left:4px solid var(--danger)}.notification.warning{border-left:4px solid var(--warning)}.notification.info{border-left:4px solid var(--info)}.empty-state{text-align:center;padding:3rem 1rem;color:var(--text-tertiary)}.empty-state-icon{font-size:3rem;margin-bottom:1rem}.action-buttons{display:flex;gap:.5rem;flex-wrap:wrap}.upload-area{border:2px dashed var(--border-color);padding:2rem;text-align:center;cursor:pointer;transition:border-color .2s}.upload-area:hover{border-color:var(--accent-primary)}.upload-area.dragover{border-color:var(--accent-primary);background:var(--bg-tertiary)}.budget-item{display:flex;align-items:center;gap:1rem;padding:.75rem;background:var(--bg-tertiary);margin-bottom:.5rem;border-radius:4px}.budget-item input{flex:1;min-width:0}.budget-item button{flex-shrink:0}.filter-bar{display:flex;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap;align-items:center}.filter-bar>*{flex:1;min-width:150px}.input-modal{display:none}.input-modal.active{display:block}.show-more-btn{width:100%;padding:1rem;background:var(--bg-tertiary);border:1px solid var(--border-color);color:var(--text-secondary);cursor:pointer;font-family:'DM Mono',monospace;font-size:.875rem;text-transform:uppercase;letter-spacing:.05em;transition:all .2s;margin-top:1rem}.show-more-btn:hover{background:var(--border-color)}@media (max-width:768px){.container{padding:1rem}.header h1{font-size:1.75rem}.grid-2,.grid-3,.grid-4{grid-template-columns:1fr}.settings-panel{width:100%;right:-100%}.nav-tabs{display:flex;gap:.5rem;margin-bottom:2rem;background:var(--bg-card);padding:.5rem;border-radius:16px;box-shadow:12px 12px 24px var(--shadow-light),-12px -12px 24px var(--shadow-dark);border-bottom:none;overflow-x:auto}.chart-container{height:250px}.modal{width:95%;padding:1.5rem}}
    
body[data-theme=dark] {
    background: linear-gradient(135deg, #1e2a3a 0%, #131f2d 60%, #1a2535 100%) !important;
}
body[data-theme=dark] .stat-card {
    background: #2a3f55;
    border: 1px solid rgba(56, 189, 248, 0.25);
    box-shadow: 8px 8px 16px rgba(0,0,0,0.3), 0 0 12px rgba(56,189,248,0.08);
}
body[data-theme=dark] .stat-value {
    background: linear-gradient(135deg, #4ade80 0%, #67e8f9 50%, #a855f7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
body[data-theme=dark] .stat-value.accent {
    background: linear-gradient(135deg, #4ade80 0%, #67e8f9 50%, #a855f7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
body[data-theme=dark] .card {
    background: #2a3f55;
    border: 1px solid rgba(56,189,248,0.2);
    box-shadow: 16px 16px 32px rgba(0,0,0,0.3), 0 0 15px rgba(56,189,248,0.07);
}
body[data-theme=dark] .card:hover {
    box-shadow: 20px 20px 40px rgba(0,0,0,0.4), 0 0 25px rgba(56,189,248,0.12);
}
body[data-theme=dark] .chart-container {
    background: rgba(19,31,45,0.7);
    box-shadow: inset 4px 4px 12px rgba(0,0,0,0.3), inset -4px -4px 12px rgba(56,189,248,0.04);
}
body[data-theme=dark] .btn {
    background: #2a3f55;
    color: #67e8f9;
    border: 1px solid rgba(56,189,248,0.3);
    box-shadow: 6px 6px 12px rgba(0,0,0,0.3), -3px -3px 8px rgba(56,189,248,0.05);
}
body[data-theme=dark] .btn-primary {
    background: linear-gradient(135deg, #4ade80 0%, #67e8f9 100%);
    color: #0a1628;
    font-weight: 700;
    border: none;
    box-shadow: 0 4px 15px rgba(74,222,128,0.3);
}
body[data-theme=dark] .btn-secondary {
    background: #1e2a3a;
    color: #a5c8e4;
    border: 1px solid rgba(56,189,248,0.2);
}
body[data-theme=dark] .btn-secondary:hover {
    background: #2a3f55;
    color: #67e8f9;
}
body[data-theme=dark] .zoom-btn {
    background: #2a3f55;
    color: #67e8f9;
    border: 1px solid rgba(56,189,248,0.2);
}
body[data-theme=dark] .btn:hover {
    box-shadow: 
        4px 4px 8px rgba(0, 0, 0, 0.5),
        0 0 20px rgba(168, 85, 247, 0.4);
}
/* btn-secondary handled above */
bodybody[data-theme=dark] .nav-tabs {
    background: #1e2a3a;
    border: 1px solid rgba(56,189,248,0.2);
    box-shadow: 12px 12px 24px rgba(0,0,0,0.3);
}
body[data-theme=dark] .nav-tab.active {
    background: linear-gradient(135deg, #4ade80 0%, #67e8f9 50%, #a855f7 100%);
    color: white;
    box-shadow: 4px 4px 8px rgba(0,0,0,0.3), 0 0 12px rgba(74,222,128,0.3);
}
body[data-theme=dark] .header {
    background: #2a3f55;
    border: 1px solid rgba(56,189,248,0.2);
    box-shadow: 16px 16px 32px rgba(0,0,0,0.3);
}
body[data-theme=dark] .header h1 {
    background: linear-gradient(135deg, #4ade80 0%, #67e8f9 50%, #a855f7 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
body[data-theme=dark] .progress-fill {
    background: linear-gradient(90deg, #a855f7 0%, #60a5fa 50%, #38bdf8 100%);
}
body[data-theme=dark] .form-input,
body[data-theme=dark] .form-select {
    background: rgba(10, 10, 10, 0.5);
    border: 1px solid rgba(138, 43, 226, 0.3);
    color: var(--text-primary);
}
body[data-theme=dark] .form-input:focus,
body[data-theme=dark] .form-select:focus {
    border-color: #a855f7;
    box-shadow: 0 0 15px rgba(168, 85, 247, 0.3);
}
body[data-theme=dark] .table {
    color: var(--text-primary);
}
body[data-theme=dark] .table tbody tr:hover {
    background: rgba(138, 43, 226, 0.1);
}
.grid-stats{margin-bottom:2rem!important}

/* COULEURS GRAPHIQUES MODE SOMBRE - SUNSET */
body[data-theme=dark] canvas { filter: none; }
.emoji-picker-wrap{position:relative;display:flex;gap:0.5rem;align-items:center}
.emoji-preview-btn{width:44px;height:44px;font-size:1.4rem;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;flex-shrink:0;transition:all .2s;box-shadow:4px 4px 8px var(--shadow-light),-4px -4px 8px var(--shadow-dark)}
.emoji-preview-btn:hover{transform:scale(1.1)}
.emoji-picker-popup{position:fixed;z-index:3000;background:var(--bg-secondary);border:1px solid var(--border-color);border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,0.2);width:320px;padding:0.75rem;display:none;max-height:380px;flex-direction:column;gap:0.5rem}
.emoji-picker-popup.open{display:flex}
.emoji-picker-search{width:100%;padding:0.5rem 0.75rem;background:var(--bg-primary);border:1px solid var(--border-color);border-radius:10px;color:var(--text-primary);font-size:0.85rem;outline:none}
.emoji-picker-search:focus{border-color:var(--accent-primary)}
.emoji-cat-tabs{display:flex;gap:0.25rem;flex-wrap:nowrap;overflow-x:auto;padding-bottom:0.25rem}
.emoji-cat-btn{background:none;border:none;font-size:1.1rem;cursor:pointer;padding:0.3rem 0.4rem;border-radius:8px;opacity:0.5;transition:all .15s;flex-shrink:0}
.emoji-cat-btn:hover,.emoji-cat-btn.active{opacity:1;background:var(--bg-tertiary)}
.emoji-grid{display:grid;grid-template-columns:repeat(8,1fr);gap:2px;overflow-y:auto;flex:1}
.emoji-btn{background:none;border:none;font-size:1.3rem;cursor:pointer;padding:0.25rem;border-radius:8px;transition:all .1s;line-height:1}
.emoji-btn:hover{background:var(--bg-tertiary);transform:scale(1.2)}
</style>
</head>
<body>
<div class="overlay" id="overlay"></div>

<!-- Modal de confirmation -->
<div class="modal" id="confirmModal">
    <div class="modal-header">
        <h2 class="modal-title" id="confirmTitle">Confirmation</h2>
    </div>
    <div class="modal-body" id="confirmBody">
        ÃŠtes-vous sÃ»r de vouloir continuer ?
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.closeModal()">Annuler</button>
        <button class="btn" id="confirmBtn" onclick="app.confirmAction()">Confirmer</button>
    </div>
</div>

<!-- Modal d'input -->
<div class="modal input-modal" id="inputModal">
    <div class="modal-header">
        <h2 class="modal-title" id="inputTitle">Saisie</h2>
    </div>
    <div class="modal-body">
        <div class="form-group">
            <label class="form-label" id="inputLabel">Nom</label>
            <input type="text" class="form-input" id="inputField" placeholder="">
        </div>
        <div class="form-group" id="inputField2Container" style="display:none">
            <label class="form-label" id="inputLabel2">Budget</label>
            <input type="number" class="form-input" id="inputField2" placeholder="0" step="10">
        </div>
    </div>
    <div class="modal-footer">
        <button class="btn btn-secondary" onclick="app.closeInputModal()">Annuler</button>
        <button class="btn" onclick="app.submitInput()">Valider</button>
    </div>
</div>

<div id="zoom-wrapper"><div class="container">
<div class="header">
<h1>Suivi Financier</h1>
<div class="header-controls">
<div id="backup-alert"></div>
<div style="display:flex;align-items:center;gap:0.75rem">
    <span style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-tertiary)">Taille</span>
    <div class="zoom-controls" style="display:flex;gap:0.25rem;align-items:center;background:var(--bg-secondary);border-radius:12px;padding:0.25rem;box-shadow:inset 4px 4px 8px var(--shadow-light),inset -4px -4px 8px var(--shadow-dark)">
        <button class="btn btn-small zoom-btn" onclick="app.setZoom(80)" id="zoom-80" title="TrÃ¨s compact">XS</button>
        <button class="btn btn-small zoom-btn" onclick="app.setZoom(90)" id="zoom-90" title="Compact">S</button>
        <button class="btn btn-small zoom-btn" onclick="app.setZoom(100)" id="zoom-100" title="Normal" style="background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));color:white">M</button>
        <button class="btn btn-small zoom-btn" onclick="app.setZoom(110)" id="zoom-110" title="Confortable">L</button>
    </div>
</div>
<button class="btn btn-small" onclick="app.backupData()">ğŸ’¾ Sauvegarder</button>
<div id="sync-indicator" title="Synchronisation cloud" style="display:flex;align-items:center;gap:0.35rem;font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--text-tertiary);padding:0.4rem 0.75rem;background:var(--bg-secondary);border-radius:10px;box-shadow:4px 4px 8px var(--shadow-light),-4px -4px 8px var(--shadow-dark)">
  <span id="sync-dot" style="width:7px;height:7px;border-radius:50%;background:var(--text-tertiary);transition:background .3s"></span>
  <span id="sync-label">cloud</span>
</div>
<button class="btn btn-secondary btn-icon" onclick="app.toggleSettings()">âš™</button>
</div>
</div>

<div class="nav-tabs">
<button class="nav-tab active" onclick="app.switchTab('dashboard')">ğŸ  Dashboard</button>
<button class="nav-tab" onclick="app.switchTab('depenses')">ğŸ’¸ DÃ©penses</button>
<button class="nav-tab" onclick="app.switchTab('pea')">ğŸ“ˆ PEA</button>
<button class="nav-tab" onclick="app.switchTab('patrimoine')">ğŸ¦ Patrimoine</button>
<button class="nav-tab" onclick="app.switchTab('objectifs')">ğŸ¯ Objectifs</button>
<button class="nav-tab" onclick="app.switchTab('bilan')">ğŸ“‹ Bilan</button>
<button class="nav-tab" style="opacity:0.5;font-size:0.7rem" onclick="app.toggleAvance()">Â·Â·Â· AvancÃ©</button>
</div>

<!-- Dashboard -->
<div id="tab-dashboard" class="tab-content active">
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
<div class="stat-label">Patrimoine Net</div>
<div class="stat-value accent" id="d-patrimoine">0 â‚¬</div>
<div class="stat-change" id="d-patrimoine-ch">â€”</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">DÃ©penses Mois</div>
<div class="stat-value" id="d-depenses">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">PEA Performance</div>
<div class="stat-value accent" id="d-pea">0%</div>
<div class="stat-change" id="d-pea-gain">â€”</div>
</div>
</div>

<!-- 1. Alertes intelligentes -->
<div class="card" id="alertes-card">
<div class="card-header"><h2 class="card-title">ğŸ”” Alertes Intelligentes</h2></div>
<div id="alertes-container"><div class="empty-state"><div class="empty-state-icon">âœ…</div><div>Aucune anomalie dÃ©tectÃ©e</div></div></div>
</div>

<!-- 2. Vue rapide -->
<div class="card">
<div class="card-header"><h2 class="card-title">âš¡ Vue Rapide</h2></div>
<div class="grid grid-3" id="vue-rapide-grid" style="gap:0.75rem"></div>
</div>

<!-- 3. Ã‰volution patrimoine + RÃ©partition -->
<div class="grid grid-2">
<div class="card">
<div class="card-header"><h2 class="card-title">Ã‰volution Patrimoine</h2></div>
<div class="chart-container"><canvas id="chart-patrimoine"></canvas></div>
</div>
<div class="card">
<div class="card-header"><h2 class="card-title">RÃ©partition</h2><button class="btn btn-small btn-secondary" onclick="app.ouvrirCouleursCategoriesDonut()" title="Personnaliser les couleurs">ğŸ¨ Couleurs</button></div>
<div class="chart-container"><canvas id="chart-repartition"></canvas></div>
</div>
</div>

<!-- 4. DÃ©penses rÃ©el vs budget -->
<div class="card">
<div class="card-header"><h2 class="card-title">DÃ©penses : RÃ©el vs Budget</h2></div>
<div class="chart-container"><canvas id="chart-depenses-budget"></canvas></div>
</div>

<!-- 5. Heatmap annuelle -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸŒ¡ Heatmap annuelle</h2>
  <span style="font-size:0.78rem;color:var(--text-tertiary)" id="heatmap-annee"></span>
</div>
<div style="display:grid;grid-template-columns:repeat(12,1fr);gap:3px;margin-bottom:4px" id="heatmap-months-labels"></div>
<div style="display:grid;grid-template-columns:repeat(12,1fr);gap:3px" id="heatmap-grid"></div>
<div style="display:flex;align-items:center;gap:0.6rem;margin-top:0.75rem;justify-content:flex-end">
  <span style="font-family:'DM Mono',monospace;font-size:0.55rem;color:var(--text-tertiary)">Peu</span>
  <div style="width:60px;height:5px;border-radius:100px;background:linear-gradient(90deg,rgba(var(--heatmap-rgb),0.1),rgba(var(--heatmap-rgb),1))"></div>
  <span style="font-family:'DM Mono',monospace;font-size:0.55rem;color:var(--text-tertiary)">Beaucoup</span>
</div>
<div id="heatmap-legend" style="margin-top:0.4rem;font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--text-tertiary);text-align:center"></div>
</div>
</div>

<!-- DÃ©penses -->
<div id="tab-depenses" class="tab-content">
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
<div class="stat-label">DÃ©pensÃ© ce mois</div>
<div class="stat-value" id="s-depenses-mois">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Budget restant</div>
<div class="stat-value" id="s-budget-restant">0 â‚¬</div>
<div class="progress-bar"><div class="progress-fill" id="s-progress-global"></div></div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Budget total</div>
<div class="stat-value accent" id="s-budget-total">0 â‚¬</div>
</div>
</div>

<!-- 1. Ajouter une dÃ©pense -->
<div class="card" style="position:relative">
<div class="btn-gear" onclick="app.toggleBudgetsPanel()">âš™</div>
<div class="card-header"><h2 class="card-title">Ajouter une dÃ©pense</h2></div>
<div id="budgets-panel" style="display:none;margin-bottom:1.5rem;padding:1.5rem;background:var(--bg-tertiary);border-radius:4px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
<strong>Budgets par catÃ©gorie</strong>
<button class="btn btn-small" onclick="app.openAddCategoryModal()">+ CatÃ©gorie</button>
</div>
<div id="budgets-container"></div>
<div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border-color)">
<strong>Budget total allouÃ© : <span id="budget-total-alloue">0 â‚¬</span></strong>
</div>
</div>
<div class="grid grid-2">
<div class="form-group">
<label class="form-label">CatÃ©gorie</label>
<select class="form-select" id="dep-cat"></select>
</div>
<div class="form-group">
<label class="form-label">Montant (â‚¬)</label>
<input type="number" class="form-input" id="dep-montant" placeholder="0.00" step="0.01">
</div>
<div class="form-group">
<label class="form-label">Date</label>
<input type="date" class="form-input" id="dep-date">
</div>
<div class="form-group">
<label class="form-label">Note</label>
<input type="text" class="form-input" id="dep-note" placeholder="Description...">
</div>
</div>
<button class="btn" onclick="app.ajouterDepense()">+ Ajouter</button>
</div>

<!-- 2. Ã‰tat des catÃ©gories -->
<div class="card">
<div class="card-header"><h2 class="card-title">Ã‰tat des catÃ©gories</h2></div>
<div class="grid grid-3" id="stats-categories"></div>
</div>

<!-- 2b. PrÃ©diction fin de mois -->
<div class="card" id="prediction-card">
<div class="card-header">
  <h2 class="card-title">ğŸ”® PrÃ©diction fin de mois</h2>
  <span id="pred-badge" style="font-size:0.75rem;padding:0.2rem 0.75rem;border-radius:100px;font-family:'DM Mono',monospace"></span>
</div>
<div class="grid grid-3 grid-stats" style="margin-bottom:1rem">
  <div class="stat-card stat-card-main"><div class="stat-label">DÃ©pensÃ© (j actuel)</div><div class="stat-value accent" id="pred-actuel">0 â‚¬</div></div>
  <div class="stat-card stat-card-main"><div class="stat-label">ProjetÃ© (fin mois)</div><div class="stat-value" id="pred-projete">0 â‚¬</div></div>
  <div class="stat-card stat-card-main"><div class="stat-label">Budget</div><div class="stat-value" id="pred-budget">0 â‚¬</div></div>
</div>
<div style="margin-bottom:0.5rem;font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--text-tertiary)">Progression rÃ©elle</div>
<div style="height:24px;border-radius:10px;overflow:hidden;background:var(--bg-secondary);box-shadow:inset 2px 2px 6px var(--shadow-light);position:relative;margin-bottom:0.4rem">
  <div id="pred-bar-reel" style="height:100%;background:linear-gradient(90deg,var(--accent-gradient-start),var(--accent-gradient-end));border-radius:10px;transition:width .5s;display:flex;align-items:center;padding-left:0.5rem"><span id="pred-bar-reel-label" style="font-size:0.65rem;color:white;font-family:'DM Mono',monospace;white-space:nowrap"></span></div>
</div>
<div style="margin-bottom:0.5rem;font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--text-tertiary)">Projection fin de mois</div>
<div style="height:24px;border-radius:10px;overflow:hidden;background:var(--bg-secondary);box-shadow:inset 2px 2px 6px var(--shadow-light);position:relative">
  <div id="pred-bar-proj" style="height:100%;border-radius:10px;transition:width .5s;display:flex;align-items:center;padding-left:0.5rem"><span id="pred-bar-proj-label" style="font-size:0.65rem;color:white;font-family:'DM Mono',monospace;white-space:nowrap"></span></div>
</div>
<div id="pred-message" style="margin-top:0.75rem;padding:0.75rem;border-radius:12px;font-size:0.85rem;display:none"></div>
</div>

<!-- 2c. Comparaison mois vs mois -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ“Š Comparaison mois Ã  mois</h2>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <span style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text-tertiary)">RÃ©f.</span>
    <select class="form-select" id="comp-mois-a" style="padding:0.4rem 0.6rem;font-size:0.8rem;width:auto" onchange="app.refreshComparaison()"></select>
    <span style="color:var(--text-tertiary)">â†’</span>
    <select class="form-select" id="comp-mois-b" style="padding:0.4rem 0.6rem;font-size:0.8rem;width:auto" onchange="app.refreshComparaison()"></select>
    <span style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--text-tertiary)">Actuel</span>
  </div>
</div>
<div id="comparaison-container"><div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>Ajoute des dÃ©penses sur 2 mois diffÃ©rents pour comparer</div></div></div>
</div>

<!-- 3. RÃ¨gle 50/30/20 -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ“Š RÃ¨gle 50 / 30 / 20</h2>
  <span style="font-size:0.8rem;color:var(--text-tertiary)">Besoins Â· Envies Â· Ã‰pargne</span>
</div>
<div style="margin-bottom:0.5rem;font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em">IdÃ©al</div>
<div style="height:28px;border-radius:8px;overflow:hidden;display:flex;gap:2px;margin-bottom:0.5rem">
  <div style="width:50%;background:rgba(63,81,181,0.25);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--accent-primary);font-weight:600">50%</div>
  <div style="width:30%;background:rgba(92,107,192,0.25);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--accent-secondary);font-weight:600">30%</div>
  <div style="width:20%;background:rgba(0,200,83,0.2);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--success);font-weight:600">20%</div>
</div>
<div style="margin-bottom:0.5rem;font-size:0.72rem;font-family:'DM Mono',monospace;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:0.06em">Ce mois</div>
<div style="height:28px;border-radius:8px;overflow:hidden;display:flex;gap:2px;margin-bottom:0.75rem" id="bar-503020"></div>
<div class="grid grid-3" id="comparaison-503020" style="gap:0.75rem;text-align:center"></div>
</div>

<!-- 4. RÃ©currences -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ”„ DÃ©penses RÃ©currentes</h2>
  <button class="btn btn-small" onclick="app.ouvrirAjoutRecurrence()">+ Ajouter</button>
</div>
<div id="recurrences-list"><div class="empty-state"><div class="empty-state-icon">ğŸ”„</div><div>Aucune rÃ©currence dÃ©finie</div></div></div>
<div style="margin-top:1rem;padding:0.75rem;background:var(--bg-secondary);border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)" id="recurrences-total-wrap">
  <span style="color:var(--text-secondary);font-size:0.85rem">Total mensuel rÃ©currences</span>
  <span class="stat-value" id="recurrences-total" style="font-size:1.2rem">0 â‚¬</span>
</div>
</div>

<!-- 5. Analyse -->
<div class="card">
<div class="card-header"><h2 class="card-title">Analyse des dÃ©penses</h2></div>
<div class="filter-bar">
<div class="form-group" style="margin:0">
<label class="form-label">PÃ©riode</label>
<select class="form-select" id="analyse-periode" onchange="app.analyseDepenses()">
<option value="mois">Mois en cours</option>
<option value="mois-choisi">Choisir un mois</option>
<option value="annee">AnnÃ©e en cours</option>
<option value="annee-choisie">Choisir une annÃ©e</option>
<option value="plage">Plage de dates</option>
</select>
</div>
<div class="form-group" style="margin:0;display:none" id="filter-mois-choisi">
<label class="form-label">Mois</label>
<input type="month" class="form-input" id="analyse-mois" onchange="app.analyseDepenses()">
</div>
<div class="form-group" style="margin:0;display:none" id="filter-annee-choisie">
<label class="form-label">AnnÃ©e</label>
<input type="number" class="form-input" id="analyse-annee" placeholder="2025" onchange="app.analyseDepenses()">
</div>
<div class="form-group" style="margin:0;display:none" id="filter-plage-debut">
<label class="form-label">Du</label>
<input type="date" class="form-input" id="analyse-debut" onchange="app.analyseDepenses()">
</div>
<div class="form-group" style="margin:0;display:none" id="filter-plage-fin">
<label class="form-label">Au</label>
<input type="date" class="form-input" id="analyse-fin" onchange="app.analyseDepenses()">
</div>
<div class="form-group" style="margin:0">
<label class="form-label">CatÃ©gorie</label>
<select class="form-select" id="analyse-categorie" onchange="app.analyseDepenses()">
<option value="toutes">Toutes</option>
</select>
</div>
</div>
<div id="analyse-results"></div>
</div>

<!-- 6. Historique -->
<div class="card">
<div class="card-header"><h2 class="card-title">Historique</h2></div>
<div class="table-container">
<table class="table">
<thead><tr><th>Date</th><th>CatÃ©gorie</th><th>Montant</th><th>Note</th><th>Actions</th></tr></thead>
<tbody id="table-depenses"></tbody>
</table>
</div>
<button class="show-more-btn" id="show-more-depenses" onclick="app.toggleShowMore('depenses')" style="display:none">Afficher plus</button>
</div>
</div> <!-- fin tab-depenses -->

<!-- PEA -->
<div id="tab-pea" class="tab-content">
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
<div class="stat-label">Valeur PEA</div>
<div class="stat-value accent" id="pea-valeur">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Total Investi</div>
<div class="stat-value" id="pea-investi">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Gain/Perte</div>
<div class="stat-value accent" id="pea-gain">0 â‚¬</div>
<div class="stat-change" id="pea-perf">0%</div>
</div>
</div>

<!-- 1. Mise Ã  jour -->
<div class="card">
<div class="card-header"><h2 class="card-title">Mise Ã  jour PEA</h2></div>
<div class="card-tabs">
<button class="card-tab active" onclick="app.switchPEAMode('manuel')">Manuel</button>
<button class="card-tab" onclick="app.switchPEAMode('import')">Import CSV</button>
</div>
<div id="pea-manuel">
<div class="grid grid-2">
<div class="form-group">
<label class="form-label">Date</label>
<input type="date" class="form-input" id="pea-date">
</div>
<div class="form-group">
<label class="form-label">Valeur (â‚¬)</label>
<input type="number" class="form-input" id="pea-val" placeholder="0.00" step="0.01">
</div>
<div class="form-group">
<label class="form-label">Investi (â‚¬)</label>
<input type="number" class="form-input" id="pea-inv" placeholder="0.00" step="0.01">
</div>
<div class="form-group">
<label class="form-label">Note</label>
<input type="text" class="form-input" id="pea-note">
</div>
</div>
<button class="btn" onclick="app.ajouterPEA()">+ Enregistrer</button>
</div>
<div id="pea-import" style="display:none">
<div class="upload-area" onclick="document.getElementById('pea-file').click()">
<div style="font-size:2rem;margin-bottom:1rem">ğŸ“„</div>
<div class="stat-label">CSV: Date, Valeur, Investi</div>
</div>
<input type="file" id="pea-file" accept=".csv" style="display:none" onchange="app.importPEA(event)">
</div>
</div>

<!-- 2. Lignes du portefeuille & Plus-values -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ“‹ Lignes du Portefeuille & Plus-values</h2>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <button class="btn btn-small btn-secondary" id="btn-actualiser-pea" onclick="app.actualiserCoursPEA()" title="Actualisation automatique via Google Sheets">
      <span id="actualiser-icon">ğŸ”„</span> Actualiser les cours
    </button>
    <button class="btn btn-small" onclick="app.ouvrirAjoutLignePEA()">+ Ligne</button>
  </div>
</div>
<div class="table-container">
<table class="table" id="table-lignes-pea">
<thead><tr><th>Titre</th><th>ISIN</th><th>Parts</th><th>PRU</th><th>Valeur act.</th><th>Investi</th><th>+/âˆ’</th><th></th></tr></thead>
<tbody id="tbody-lignes-pea"><tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ğŸ“ˆ</div><div>Ajouter vos lignes PEA</div></td></tr></tbody>
</table>
</div>
<div style="margin-top:0.75rem;padding:0.75rem;background:var(--bg-secondary);border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)">
  <span style="color:var(--text-secondary);font-size:0.85rem">Plus-value latente totale</span>
  <span class="stat-value accent" id="pv-latente-total" style="font-size:1.2rem">0 â‚¬</span>
</div>
</div>

<!-- 3. Allocation cible vs rÃ©elle -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ¯ Allocation Cible vs RÃ©elle</h2>
  <button class="btn btn-small btn-secondary" onclick="app.ouvrirAllocationCible()">âš™ Configurer</button>
</div>
<div id="allocation-container"><div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>Configurer l'allocation cible</div></div></div>
</div>

<!-- 4. Graphique Ã©volution -->
<div class="card">
<div class="card-header"><h2 class="card-title">Ã‰volution PEA : Valeur vs Investi</h2></div>
<div class="chart-container"><canvas id="chart-pea"></canvas></div>
</div>

<!-- 5. Historique -->
<div class="card">
<div class="card-header"><h2 class="card-title">Historique PEA</h2></div>
<div class="table-container">
<table class="table">
<thead><tr><th>Date</th><th>Valeur</th><th>Investi</th><th>Gain/Perte</th><th>Note</th><th></th></tr></thead>
<tbody id="table-pea"></tbody>
</table>
</div>
<button class="show-more-btn" id="show-more-pea" onclick="app.toggleShowMore('pea')" style="display:none">Afficher plus</button>
</div>
</div>

<!-- Patrimoine -->
<div id="tab-patrimoine" class="tab-content">
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
<div class="stat-label">Total</div>
<div class="stat-value accent" id="pat-total">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Ã‰pargne sÃ©curisÃ©e</div>
<div class="stat-value" id="pat-securise">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Investissements</div>
<div class="stat-value" id="pat-invest">0 â‚¬</div>
</div>
</div>

<!-- 1. Mise Ã  jour -->
<div class="card" style="position:relative">
<div class="btn-gear" onclick="app.toggleComptesPanel()">âš™</div>
<div class="card-header"><h2 class="card-title">Mise Ã  jour</h2></div>
<div id="comptes-panel" style="display:none;margin-bottom:1.5rem;padding:1.5rem;background:var(--bg-tertiary);border-radius:4px">
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem">
<strong>GÃ©rer les comptes</strong>
<button class="btn btn-small" onclick="app.openAddCompteModal()">+ Compte</button>
</div>
<div id="comptes-patrimoine-container"></div>
</div>
<div class="grid grid-2">
<div class="form-group">
<label class="form-label">Mois</label>
<input type="month" class="form-input" id="pat-mois">
</div>
<div id="pat-inputs"></div>
</div>
<button class="btn" onclick="app.ajouterPatrimoine()">+ Enregistrer</button>
</div>

<!-- 2. Ã‰volution graphique -->
<div class="card">
<div class="card-header"><h2 class="card-title">Ã‰volution du Patrimoine</h2></div>
<div class="chart-container"><canvas id="chart-pat-evol"></canvas></div>
</div>

<!-- 3. Projection retraite -->
<div class="card">
<div class="card-header"><h2 class="card-title">ğŸ‘´ Projection Retraite</h2></div>
<div class="grid grid-2">
  <div class="form-group">
    <label class="form-label">Ã‚ge actuel</label>
    <input type="number" class="form-input" id="ret-age" placeholder="28" min="18" max="65">
  </div>
  <div class="form-group">
    <label class="form-label">Ã‚ge cible retraite</label>
    <input type="number" class="form-input" id="ret-age-cible" placeholder="65" min="40" max="80">
  </div>
  <div class="form-group">
    <label class="form-label">Ã‰pargne mensuelle (â‚¬)</label>
    <input type="number" class="form-input" id="ret-epargne" placeholder="500" step="50">
  </div>
  <div class="form-group">
    <label class="form-label">Rendement annuel moyen (%)</label>
    <input type="number" class="form-input" id="ret-taux" placeholder="6" step="0.5">
  </div>
</div>
<button class="btn" onclick="app.calculerRetraite()">ğŸ“Š Calculer</button>
<div id="retraite-results" style="display:none;margin-top:1.5rem">
  <div class="grid grid-3 grid-stats" style="margin-bottom:1rem">
    <div class="stat-card stat-card-main"><div class="stat-label">Projection optimiste (+2%)</div><div class="stat-value accent" id="ret-optimiste">0 â‚¬</div></div>
    <div class="stat-card stat-card-main"><div class="stat-label">Projection rÃ©aliste</div><div class="stat-value" id="ret-realiste">0 â‚¬</div></div>
    <div class="stat-card stat-card-main"><div class="stat-label">Projection basse (âˆ’2%)</div><div class="stat-value" id="ret-basse">0 â‚¬</div></div>
  </div>
  <div style="padding:1rem;background:var(--bg-secondary);border-radius:12px;border:1px solid var(--border-color);" id="ret-conseil"></div>
</div>
</div>

<!-- 4. Historique -->
<div class="card">
<div class="card-header"><h2 class="card-title">Historique Patrimoine</h2></div>
<div class="table-container">
<table class="table">
<thead>
<tr>
<th>Mois</th>
<th id="pat-table-headers"></th>
<th>Total</th>
<th></th>
</tr>
</thead>
<tbody id="table-patrimoine"></tbody>
</table>
</div>
<button class="show-more-btn" id="show-more-patrimoine" onclick="app.toggleShowMore('patrimoine')" style="display:none">Afficher plus</button>
</div>

<!-- 5. Inflation personnelle -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ“ Ton inflation personnelle</h2>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <select class="form-select" id="infl-annee-a" style="padding:0.4rem 0.6rem;font-size:0.8rem;width:auto" onchange="app.refreshInflation()"></select>
    <span style="color:var(--text-tertiary);font-size:0.8rem">vs</span>
    <select class="form-select" id="infl-annee-b" style="padding:0.4rem 0.6rem;font-size:0.8rem;width:auto" onchange="app.refreshInflation()"></select>
  </div>
</div>
<div id="inflation-container"><div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>Ajoute des dÃ©penses sur 2 annÃ©es diffÃ©rentes pour calculer ton inflation perso</div></div></div>
</div>
</div>

<!-- Objectifs -->
<div id="tab-objectifs" class="tab-content">
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
  <div class="stat-label">Objectifs actifs</div>
  <div class="stat-value accent" id="obj-count">0</div>
</div>
<div class="stat-card stat-card-main">
  <div class="stat-label">Total Ã  atteindre</div>
  <div class="stat-value" id="obj-total-cible">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
  <div class="stat-label">Ã‰pargne mensuelle nÃ©cessaire</div>
  <div class="stat-value accent" id="obj-mensuel-total">0 â‚¬</div>
</div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title">ğŸ¯ Mes Objectifs</h2><button class="btn btn-small" onclick="app.ouvrirAjoutObjectif()">+ Nouvel objectif</button></div>
<div id="objectifs-list"><div class="empty-state"><div class="empty-state-icon">ğŸ¯</div><div>Aucun objectif dÃ©fini. Ajoutez votre premier objectif !</div></div></div>
</div>

<div class="card" id="objectifs-calcul-card" style="display:none">
<div class="card-header"><h2 class="card-title">ğŸ’¡ Calcul mensuel automatique</h2></div>
<div id="objectifs-calcul"></div>
<div style="margin-top:1rem;padding:1rem;background:var(--bg-secondary);border-radius:12px;border:1px solid var(--border-color)">
  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>
      <div style="font-size:0.75rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);font-family:'DM Mono',monospace">Total Ã  Ã©pargner / mois</div>
      <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:0.2rem">Pour atteindre tous vos objectifs Ã  temps</div>
    </div>
    <div class="stat-value accent" id="obj-grand-total" style="font-size:1.4rem">0 â‚¬</div>
  </div>
</div>
</div>

<!-- Simulateur Et Si -->
<div class="card">
<div class="card-header"><h2 class="card-title">ğŸ² Simulateur "Et siâ€¦"</h2></div>
<div class="grid grid-2">
  <div>
    <div class="form-group" style="margin-bottom:1rem">
      <label class="form-label">Si j'Ã©pargnaisâ€¦ par mois</label>
      <div style="display:flex;align-items:center;gap:1rem">
        <input type="range" id="sim-epargne" min="50" max="2000" value="300" step="50" style="flex:1;accent-color:var(--accent-primary)" oninput="app.refreshSimulateur()">
        <span id="sim-epargne-val" style="font-family:'DM Mono',monospace;font-size:1rem;font-weight:600;color:var(--accent-primary);min-width:60px">300 â‚¬</span>
      </div>
    </div>
    <div class="form-group" style="margin-bottom:1rem">
      <label class="form-label">Rendement annuel</label>
      <div style="display:flex;align-items:center;gap:1rem">
        <input type="range" id="sim-taux" min="1" max="12" value="6" step="0.5" style="flex:1;accent-color:var(--accent-primary)" oninput="app.refreshSimulateur()">
        <span id="sim-taux-val" style="font-family:'DM Mono',monospace;font-size:1rem;font-weight:600;color:var(--accent-primary);min-width:40px">6%</span>
      </div>
    </div>
    <div style="display:flex;gap:0.5rem;flex-wrap:wrap">
      <button class="btn btn-small btn-secondary" onclick="app.simSetHorizon(5)" id="sim-5">5 ans</button>
      <button class="btn btn-small" onclick="app.simSetHorizon(10)" id="sim-10">10 ans</button>
      <button class="btn btn-small btn-secondary" onclick="app.simSetHorizon(20)" id="sim-20">20 ans</button>
      <button class="btn btn-small btn-secondary" onclick="app.simSetHorizon(30)" id="sim-30">30 ans</button>
    </div>
  </div>
  <div style="display:flex;flex-direction:column;gap:0.75rem">
    <div class="stat-card stat-card-main" style="padding:1rem">
      <div class="stat-label">Capital final</div>
      <div class="stat-value accent" id="sim-result-capital" style="font-size:1.8rem">0 â‚¬</div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.75rem">
      <div style="background:var(--bg-secondary);border-radius:12px;padding:0.75rem;text-align:center;border:1px solid var(--border-color)">
        <div class="stat-label">VersÃ©</div>
        <div style="font-family:'Outfit',sans-serif;font-size:1rem;font-weight:700;color:var(--text-primary)" id="sim-result-verse">0 â‚¬</div>
      </div>
      <div style="background:var(--bg-secondary);border-radius:12px;padding:0.75rem;text-align:center;border:1px solid var(--border-color)">
        <div class="stat-label">IntÃ©rÃªts</div>
        <div style="font-family:'Outfit',sans-serif;font-size:1rem;font-weight:700;color:var(--success)" id="sim-result-interets">0 â‚¬</div>
      </div>
    </div>
    <div id="sim-conseil" style="font-size:0.8rem;color:var(--text-secondary);line-height:1.6;padding:0.75rem;background:var(--bg-secondary);border-radius:12px;border:1px solid var(--border-color)"></div>
  </div>
</div>
</div>
</div>

<!-- Bilan -->
<div id="tab-bilan" class="tab-content">

<!-- Rapport mensuel -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ“„ Rapport mensuel</h2>
  <div style="display:flex;gap:0.5rem;align-items:center">
    <select class="form-select" id="rapport-mois" style="padding:0.4rem 0.6rem;font-size:0.8rem;width:auto"></select>
    <button class="btn btn-small" onclick="app.genererRapport()">GÃ©nÃ©rer</button>
    <button class="btn btn-small btn-secondary" onclick="app.imprimerRapport()" id="btn-imprimer" style="display:none">ğŸ–¨ Imprimer</button>
  </div>
</div>
<div id="rapport-container"><div class="empty-state"><div class="empty-state-icon">ğŸ“„</div><div>SÃ©lectionne un mois et gÃ©nÃ¨re ton rapport</div></div></div>
</div>

<!-- Bilan annuel -->
<div class="card">
<div class="card-header">
  <h2 class="card-title">ğŸ… Bilan annuel</h2>
  <select class="form-select" id="bilan-annee" style="padding:0.4rem 0.6rem;font-size:0.8rem;width:auto" onchange="app.refreshBilanAnnuel()"></select>
</div>
<div id="bilan-annuel-container"><div class="empty-state"><div class="empty-state-icon">ğŸ…</div><div>Pas encore assez de donnÃ©es pour cette annÃ©e</div></div></div>
</div>

<!-- Notes mensuelles -->
<div class="card">
<div class="card-header"><h2 class="card-title">ğŸ“ Notes Mensuelles</h2></div>
<div class="grid grid-2" style="margin-bottom:1.5rem">
  <div class="form-group" style="margin:0">
    <label class="form-label">Mois</label>
    <input type="month" class="form-input" id="note-mois">
  </div>
  <div class="form-group" style="margin:0">
    <label class="form-label">Tag</label>
    <select class="form-select" id="note-tag">
      <option value="GÃ©nÃ©ral">GÃ©nÃ©ral</option>
      <option value="DÃ©pense exceptionnelle">DÃ©pense exceptionnelle</option>
      <option value="Revenu exceptionnel">Revenu exceptionnel</option>
      <option value="Ã‰vÃ©nement important">Ã‰vÃ©nement important</option>
      <option value="Objectif atteint">Objectif atteint ğŸ‰</option>
    </select>
  </div>
</div>
<div class="form-group">
  <label class="form-label">Note</label>
  <textarea class="form-input" id="note-texte" placeholder="DÃ©crivez ce mois..." style="min-height:80px;resize:vertical"></textarea>
</div>
<button class="btn" onclick="app.ajouterNote()">+ Enregistrer</button>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title">Historique des notes</h2></div>
<div id="notes-list"><div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>Aucune note enregistrÃ©e</div></div></div>
</div>
</div>

<!-- PrÃ©visions PEA ULTIMATE -->
<div id="tab-previsions" class="tab-content">
<div class="card">
<div class="card-header">
<h2 class="card-title">Gestion des ScÃ©narios</h2>
</div>
<div style="display:flex;gap:1rem;margin-bottom:1rem;align-items:center">
<select class="form-select" id="select-scenario" style="flex:1" onchange="app.chargerScenario()">
<option value="">-- Nouveau scÃ©nario --</option>
</select>
<button class="btn btn-small" onclick="app.sauvegarderScenario()">ğŸ’¾ Sauvegarder</button>
<button class="btn btn-small btn-secondary" onclick="app.supprimerScenario()">ğŸ—‘ï¸ Supprimer</button>
</div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title">ParamÃ¨tres de PrÃ©vision PEA</h2></div>
<div class="grid grid-2">
<div class="form-group">
<label class="form-label">Nom du scÃ©nario</label>
<input type="text" class="form-input" id="prev-scenario-nom" placeholder="Mon scÃ©nario">
</div>
<div class="form-group">
<label class="form-label">Valeur actuelle (â‚¬)</label>
<input type="number" class="form-input" id="prev-pea-actuel" placeholder="0" step="0.01">
</div>
<div class="form-group">
<label class="form-label">Versement mensuel (â‚¬)</label>
<input type="number" class="form-input" id="prev-pea-mensuel" placeholder="400" step="10">
</div>
<div class="form-group">
<label class="form-label">Rendement annuel objectif (%)</label>
<input type="number" class="form-input" id="prev-pea-taux" placeholder="8" step="0.1">
</div>
<div class="form-group">
<label class="form-label">Projection (annÃ©es)</label>
<input type="number" class="form-input" id="prev-pea-annees" placeholder="10" min="1" max="50">
</div>
</div>
<button class="btn" onclick="app.calculerPrevisionsPEA()">ğŸ“Š Calculer les PrÃ©visions</button>
</div>

<div id="prev-pea-results" style="display:none">
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
<div class="stat-label">Objectif final</div>
<div class="stat-value" id="prev-pea-final">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Total Ã  verser</div>
<div class="stat-value" id="prev-pea-verse">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Gains espÃ©rÃ©s</div>
<div class="stat-value" id="prev-pea-gains">0 â‚¬</div>
</div>
</div>

<div class="card">
<div class="card-header">
<h2 class="card-title">Projection vs RÃ©alitÃ©</h2>
<div style="display:flex;gap:0.5rem">
<button class="btn btn-small" id="btn-vue-annee" onclick="app.switchVuePrevision('annee')">Vue Annuelle</button>
<button class="btn btn-small btn-secondary" id="btn-vue-mois" onclick="app.switchVuePrevision('mois')">Vue Mensuelle</button>
</div>
</div>
<div class="chart-container"><canvas id="chart-prev-compare"></canvas></div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title">Projection basÃ©e sur vos performances rÃ©elles</h2></div>
<div class="grid grid-3 grid-stats">
<div class="stat-card stat-card-main">
<div class="stat-label">Performance moyenne</div>
<div class="stat-value" id="perf-moyenne">0%</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Projection rÃ©aliste</div>
<div class="stat-value" id="proj-realiste">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Ã‰cart vs Objectif</div>
<div class="stat-value" id="ecart-objectif">0 â‚¬</div>
</div>
</div>
<div class="chart-container"><canvas id="chart-proj-realiste"></canvas></div>
</div>
</div>
</div>

<!-- Calculateur AVEC MODÃˆLES -->
<div id="tab-calculateur" class="tab-content">
<div class="card">
<div class="card-header">
<h2 class="card-title">Mes ModÃ¨les</h2>
</div>
<div style="display:flex;gap:1rem;margin-bottom:1rem;align-items:center">
<select class="form-select" id="select-modele" style="flex:1" onchange="app.chargerModele()">
<option value="">-- Nouveau modÃ¨le --</option>
</select>
<button class="btn btn-small" onclick="app.sauvegarderModele()">ğŸ’¾ Sauvegarder</button>
<button class="btn btn-small btn-secondary" onclick="app.supprimerModele()">ğŸ—‘ï¸ Supprimer</button>
</div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title">Calculateur d'actions</h2></div>
<div class="grid grid-2">
<div class="form-group">
<label class="form-label">Nom du modÃ¨le</label>
<input type="text" class="form-input" id="calc-nom-modele" placeholder="Mon portefeuille">
</div>
<div class="form-group">
<label class="form-label">Budget (â‚¬)</label>
<input type="number" class="form-input" id="calc-budget" placeholder="1300" step="0.01" onchange="app.calculer()">
</div>
<div class="form-group">
<label class="form-label">Lignes</label>
<input type="number" class="form-input" id="calc-lignes" value="3" min="1" max="10" onchange="app.genererLignes()">
</div>
</div>

<div class="table-container">
<table class="table">
<thead><tr><th>Action</th><th>Alloc %</th><th>Budget</th><th>Cours</th><th>QtÃ©</th><th>Investi</th><th>Reste</th></tr></thead>
<tbody id="calc-body"></tbody>
</table>
</div>

<div class="grid grid-3 grid-stats" style="margin-top:1.5rem">
<div class="stat-card stat-card-main">
<div class="stat-label">Budget</div>
<div class="stat-value" id="calc-total">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Investi</div>
<div class="stat-value" id="calc-investi">0 â‚¬</div>
</div>
<div class="stat-card stat-card-main">
<div class="stat-label">Reste</div>
<div class="stat-value" id="calc-reste">0 â‚¬</div>
</div>
</div>
</div>

<div class="card">
<div class="card-header"><h2 class="card-title">Allocations prÃ©dÃ©finies</h2></div>
<div class="action-buttons">
<button class="btn btn-secondary" onclick="app.allocation('conservateur')">Conservateur 60/30/10</button>
<button class="btn btn-secondary" onclick="app.allocation('equilibre')">Ã‰quilibrÃ© 50/30/20</button>
<button class="btn btn-secondary" onclick="app.allocation('dynamique')">Dynamique 40/40/20</button>
<button class="btn btn-secondary" onclick="app.allocation('agressif')">Agressif 30/30/40</button>
</div>
</div>
</div>
</div>
</div> <!-- fin zoom-wrapper -->

<!-- Emoji Picker global -->
<div class="emoji-picker-popup" id="emojiPicker">
    <input class="emoji-picker-search" id="emoji-search" placeholder="ğŸ” Rechercher..." oninput="app.emojiSearch(this.value)">
    <div class="emoji-cat-tabs" id="emoji-cat-tabs"></div>
    <div class="emoji-grid" id="emoji-grid"></div>
</div>

<!-- Panneau AvancÃ© (PrÃ©visions + Calculateur) -->
<div class="settings-panel" id="avance-panel">
<div class="settings-header">
<h2 class="card-title">âš™ Outils AvancÃ©s</h2>
<button class="btn btn-icon btn-secondary" onclick="app.toggleAvance()">âœ•</button>
</div>
<p style="font-size:0.85rem;color:var(--text-tertiary);margin-bottom:1.5rem">Outils moins frÃ©quents â€” PrÃ©visions PEA et Calculateur d'allocation.</p>
<button class="btn" style="width:100%;margin-bottom:0.75rem" onclick="app.toggleAvance();app.switchTab('previsions')">ğŸ“Š PrÃ©visions PEA</button>
<button class="btn btn-secondary" style="width:100%" onclick="app.toggleAvance();app.switchTab('calculateur')">ğŸ§® Calculateur d'actions</button>
</div>

<!-- Settings -->
<div class="settings-panel" id="settings">
<div class="settings-header">
<h2 class="card-title">ParamÃ¨tres</h2>
<button class="btn btn-icon btn-secondary" onclick="app.toggleSettings()">âœ•</button>
</div>

<div class="form-group">
<label class="form-label">ğŸ“Š Google Sheets â€” URL CSV publiÃ©</label>
<input type="text" class="form-input" id="set-gsheets-url" placeholder="https://docs.google.com/spreadsheets/d/.../export?format=csv" style="font-family:'DM Mono',monospace;font-size:0.72rem">
<div style="font-size:0.72rem;color:var(--text-tertiary);margin-top:0.4rem;line-height:1.6">
  Clique sur <strong style="color:var(--accent-primary);cursor:pointer" onclick="app.ouvrirGuideGSheets()">ğŸ“– Voir le guide de configuration</strong> pour crÃ©er ton Google Sheet en 3 minutes.
</div>
</div>

<div class="form-group">
<label class="form-label">ğŸ’° Salaire net mensuel (â‚¬)</label>
<input type="number" class="form-input" id="set-salaire" placeholder="Ex : 2400" step="50">
<div style="font-size:0.72rem;color:var(--text-tertiary);margin-top:0.4rem">UtilisÃ© pour le Score financier, les Alertes et la RÃ¨gle 50/30/20</div>
</div>

<div class="form-group">
<label class="form-label">ThÃ¨me</label>
<select class="form-select" id="set-theme" onchange="app.changeTheme()">
<option value="light">Clair</option>
<option value="dark">Sombre</option>
<option value="auto">Automatique</option>
</select>
</div>

<button class="btn" onclick="app.saveSettings()">Sauvegarder</button>

<hr style="margin:2rem 0;border:none;border-top:1px solid var(--border-color)">

<div class="form-group">
<label class="form-label">Restaurer depuis Excel</label>
<input type="file" class="form-input" id="import-excel" accept=".xlsx">
<button class="btn btn-secondary btn-small" style="margin-top:.5rem" onclick="app.importExcel()">Restaurer</button>
</div>

<button class="btn btn-secondary" onclick="app.confirmReset()">RÃ©initialiser toutes les donnÃ©es</button>
</div>

<script>
const app = {
    data: {
        depenses: [],
        suiviPEA: [],
        patrimoine: [],
        budgets: {
            BAR: 50,
            CIGARETTE: 20,
            VETEMENT: 100,
            LOISIR: 200,
            MANGER: 300,
            CARBU: 150,
            AUTRE: 50
        },
        comptes: ['Livret A', 'Livret Jeune', 'PEA', 'CTO'],
        modeles: [],
        scenarios: [],
        objectifs: [],
        recurrences: [],
        notes: [],
        lignesPEA: [],
        allocationCible: {},
        parametres: {
            theme: 'auto',
            lastBackup: null,
            googleSheetsUrl: '',
            salaire: 0
        }
    },
    charts: {},
    confirmCallback: null,
    inputCallback: null,
    showMoreState: {
        depenses: false,
        pea: false,
        patrimoine: false
    },
    
    init() {
        this.load();
        this.initDates();
        this.applyTheme();
        if (this.data.parametres.zoom) this.setZoom(this.data.parametres.zoom);
        this.genererLignes();
        this.updateBudgetsUI();
        this.updateComptesUI();
        this.updateCategoriesSelects();
        this.updateModelesSelect();
        this.updateScenariosSelect();
        this.checkBackupReminder();
        this.refresh();
        document.getElementById('overlay').onclick = () => {
            ['settings','avance-panel'].forEach(id => {
                const el = document.getElementById(id);
                if (el?.classList.contains('open')) el.classList.remove('open');
            });
            if (document.getElementById('confirmModal').classList.contains('active')) this.closeModal();
            if (document.getElementById('inputModal').classList.contains('active')) this.closeInputModal();
            document.getElementById('overlay').classList.remove('active');
        };
        document.getElementById('analyse-periode').onchange = () => this.toggleAnalyseFilters();
        this.initEmojiPicker();
        this.refreshObjectifs();
        this.refreshNotes();
        this.refreshRecurrences();
        this.refreshLignesPEA();
        this.refreshHeatmap();
        if (this.data.objectifs.length === 0) this.chargerDonneesExemple();
    },

    chargerDonneesExemple() {
        // DonnÃ©es exemple pour rendre l'app visuelle dÃ¨s le dÃ©part
        const now = new Date();
        const m = (d) => `${now.getFullYear()}-${String(now.getMonth()+1+d).padStart(2,'0')}`;

        this.data.objectifs = [
            { id: 1, nom: 'Voyage au Japon', emoji: 'âœˆï¸', cible: 3500, actuel: 2100, dateTarget: m(4) },
            { id: 2, nom: 'Voiture', emoji: 'ğŸš—', cible: 8000, actuel: 800, dateTarget: m(10) },
            { id: 3, nom: 'Apport immobilier', emoji: 'ğŸ ', cible: 30000, actuel: 12400, dateTarget: m(24) }
        ];
        this.data.recurrences = [
            { id: 1, nom: 'Loyer', emoji: 'ğŸ ', montant: 850, jour: 1, freq: 'mensuel', actif: true },
            { id: 2, nom: 'Netflix + Spotify', emoji: 'ğŸ“º', montant: 23, jour: 15, freq: 'mensuel', actif: true },
            { id: 3, nom: 'Forfait mobile', emoji: 'ğŸ“±', montant: 19, jour: 20, freq: 'mensuel', actif: true }
        ];
        this.data.notes = [
            { id: 1, mois: m(-1), texte: 'Prime de fin d\'annÃ©e reÃ§ue â€” +1 200 â‚¬ versÃ©s directement sur PEA.', tag: 'Revenu exceptionnel' },
            { id: 2, mois: m(-2), texte: 'DÃ©mÃ©nagement â€” frais de transport + dÃ©pÃ´t de garantie. Budget shopping dÃ©passÃ©.', tag: 'DÃ©pense exceptionnelle' }
        ];
        this.data.lignesPEA = [
            { id: 1, nom: 'MSCI World', ticker: 'CW8', parts: 42, pru: 95.40, valeurActuelle: 108.95 },
            { id: 2, nom: 'S&P 500', ticker: '500', parts: 18, pru: 98.20, valeurActuelle: 105.20 },
            { id: 3, nom: 'Emerging Mkt', ticker: 'AEEM', parts: 30, pru: 31.50, valeurActuelle: 28.90 }
        ];
        this.data.allocationCible = { 'MSCI World': 60, 'S&P 500': 25, 'Emerging Mkt': 15 };
        this.save();
        this.refreshObjectifs();
        this.refreshNotes();
        this.refreshRecurrences();
        this.refreshLignesPEA();
        this.refreshAllocationPEA();
    },
    
    formatCurrency(amount) {
        return amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ' ') + ' â‚¬';
    },
    
    // â”€â”€ Supabase config â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    _sb: {
        url: 'https://qtjpckemaqxhiavmzmfj.supabase.co',
        key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF0anBja2VtYXF4aGlhdm16bWZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxMDQyNDQsImV4cCI6MjA4NzY4MDI0NH0.LfG_FEuQ2n05WzA_qPjI1_IKBEiY6USzkuo-7HK2D9U',
        table: 'suivi_data',
        id: 1
    },

    async _sbFetch(method, body) {
        const { url, key, table } = this._sb;
        // UPSERT via POST avec Prefer: resolution=merge-duplicates â€” plus fiable que PATCH
        const isUpsert = method === 'UPSERT';
        const actualMethod = isUpsert ? 'POST' : method;
        const endpoint = isUpsert
            ? `${url}/rest/v1/${table}`
            : `${url}/rest/v1/${table}?id=eq.1`;

        const headers = {
            'apikey': key,
            'Authorization': `Bearer ${key}`,
            'Content-Type': 'application/json',
        };
        if (isUpsert)        headers['Prefer'] = 'resolution=merge-duplicates,return=minimal';
        if (method === 'GET') headers['Prefer'] = 'return=representation';

        const r = await fetch(endpoint, {
            method: actualMethod,
            headers,
            body: body ? JSON.stringify(body) : undefined
        });

        if (!r.ok) {
            const errText = await r.text();
            throw new Error(`Supabase ${method} ${r.status}: ${errText}`);
        }
        return method === 'GET' ? r.json() : null;
    },

    load() {
        // Charge depuis localStorage en premier (instantanÃ©)
        const saved = localStorage.getItem('suiviFinancier');
        if (saved) {
            try {
                const loaded = JSON.parse(saved);
                this._applyLoaded(loaded);
            } catch (e) { console.error('localStorage load error:', e); }
        }
        // Puis sync depuis Supabase en arriÃ¨re-plan (source de vÃ©ritÃ©)
        this._loadFromSupabase();
    },

    async _loadFromSupabase() {
        try {
            const rows = await this._sbFetch('GET');
            if (!rows || rows.length === 0) {
                await this._syncToSupabase();
                return;
            }
            const loaded = rows[0].data;
            if (!loaded || Object.keys(loaded).length === 0) {
                await this._syncToSupabase();
                return;
            }

            const sbTime    = new Date(rows[0].updated_at).getTime();
            const localTime = parseInt(localStorage.getItem('suiviFinancierTime') || '0');

            if (sbTime > localTime) {
                // Supabase plus rÃ©cent â†’ applique directement sans reload
                this._applyLoaded(loaded);
                localStorage.setItem('suiviFinancier', JSON.stringify(loaded));
                localStorage.setItem('suiviFinancierTime', sbTime.toString());

                // Reconstruit tout l'UI comme un init complet
                this.applyTheme();
                this.genererLignes();
                this.updateBudgetsUI();
                this.updateComptesUI();
                this.updateCategoriesSelects();
                this.updateModelesSelect();
                this.updateScenariosSelect();
                this.refresh();

                this.notify('â˜ï¸ DonnÃ©es chargÃ©es depuis le cloud', 'success');
            }
        } catch(e) {
            console.warn('Supabase load failed (mode hors-ligne):', e.message);
        }
    },

    _applyLoaded(loaded) {
        this.data = {
            depenses:       loaded.depenses       || [],
            suiviPEA:       loaded.suiviPEA       || [],
            patrimoine:     loaded.patrimoine      || [],
            budgets:        loaded.budgets         || this.data.budgets,
            comptes:        loaded.comptes         || this.data.comptes,
            modeles:        loaded.modeles         || [],
            scenarios:      loaded.scenarios       || [],
            objectifs:      loaded.objectifs       || [],
            recurrences:    loaded.recurrences     || [],
            notes:          loaded.notes           || [],
            lignesPEA:      loaded.lignesPEA       || [],
            allocationCible:loaded.allocationCible || {},
            parametres:     loaded.parametres      || this.data.parametres
        };
        if (!this.data.parametres.theme)  this.data.parametres.theme  = 'auto';
        if (!this.data.parametres.salaire) this.data.parametres.salaire = 0;
        const elTheme   = document.getElementById('set-theme');
        const elSalaire = document.getElementById('set-salaire');
        const elGs      = document.getElementById('set-gsheets-url');
        if (elTheme)   elTheme.value   = this.data.parametres.theme;
        if (elSalaire) elSalaire.value = this.data.parametres.salaire || '';
        if (elGs)      elGs.value      = this.data.parametres.googleSheetsUrl || '';
    },

    save() {
        // Sauvegarde locale instantanÃ©e
        try {
            localStorage.setItem('suiviFinancier', JSON.stringify(this.data));
            localStorage.setItem('suiviFinancierTime', Date.now().toString());
            this._lastChange = Date.now();
        } catch(e) { console.error('localStorage save error:', e); }
        // Sync Supabase en arriÃ¨re-plan (ne bloque pas l'UI)
        this._syncToSupabase();
    },

    async _syncToSupabase() {
        const dot   = document.getElementById('sync-dot');
        const label = document.getElementById('sync-label');
        if (dot)   dot.style.background = 'var(--warning)';
        if (label) label.textContent    = 'syncâ€¦';
        try {
            // UPSERT : crÃ©e ou met Ã  jour la ligne id=1
            await this._sbFetch('UPSERT', {
                id: 1,
                data: this.data,
                updated_at: new Date().toISOString()
            });
            if (dot)   dot.style.background = 'var(--success)';
            if (label) label.textContent    = 'sauvÃ© âœ“';
            setTimeout(() => {
                if (dot)   dot.style.background = 'var(--text-tertiary)';
                if (label) label.textContent    = 'cloud';
            }, 2500);
        } catch(e) {
            if (dot)   dot.style.background = 'var(--danger)';
            if (label) label.textContent    = 'erreur';
            console.error('Supabase sync error:', e.message);
            // Affiche l'erreur dans l'UI pour diagnostiquer
            this.notify(`â˜ï¸ Sync Ã©chouÃ©e : ${e.message}`, 'error');
        }
    },
    
    checkBackupReminder() {
        const lastBackup = this.data.parametres.lastBackup;
        if (!lastBackup) {
            // backup reminder supprimÃ©
            return;
        }
        
        const daysSinceBackup = (Date.now() - lastBackup) / (1000 * 60 * 60 * 24);
        if (daysSinceBackup >= 7) {
            // backup reminder supprimÃ©
        }
    },
    
    backupData() {
        this.data.parametres.lastBackup = Date.now();
        this._lastChange = null;
        this.save();
        const wb = XLSX.utils.book_new();
        
        const depenses = this.data.depenses.map(d => ({
            Date: d.date,
            CatÃ©gorie: d.categorie,
            Montant: d.montant,
            Note: d.note,
            ID: d.id
        }));
        const wsDepenses = XLSX.utils.json_to_sheet(depenses);
        XLSX.utils.book_append_sheet(wb, wsDepenses, "DÃ©penses");
        
        const pea = this.data.suiviPEA.map(p => ({
            Date: p.date,
            Valeur: p.valeur,
            Investi: p.investi,
            GainPerte: p.gainPerte,
            Performance: p.performance,
            Note: p.note,
            ID: p.id
        }));
        const wsPEA = XLSX.utils.json_to_sheet(pea);
        XLSX.utils.book_append_sheet(wb, wsPEA, "PEA");
        
        const patrimoine = this.data.patrimoine.map(p => {
            const obj = { Mois: p.mois, ID: p.id };
            this.data.comptes.forEach(compte => {
                obj[compte] = p[compte] || 0;
            });
            obj.Total = p.total;
            return obj;
        });
        const wsPatrimoine = XLSX.utils.json_to_sheet(patrimoine);
        XLSX.utils.book_append_sheet(wb, wsPatrimoine, "Patrimoine");
        
        const budgets = Object.keys(this.data.budgets).map(cat => ({
            CatÃ©gorie: cat,
            Budget: this.data.budgets[cat]
        }));
        const wsBudgets = XLSX.utils.json_to_sheet(budgets);
        XLSX.utils.book_append_sheet(wb, wsBudgets, "Budgets");
        
        const comptes = this.data.comptes.map((c, i) => ({ Ordre: i + 1, Compte: c }));
        const wsComptes = XLSX.utils.json_to_sheet(comptes);
        XLSX.utils.book_append_sheet(wb, wsComptes, "Comptes");
        
        const modeles = this.data.modeles.map(m => ({
            ID: m.id,
            Nom: m.nom,
            Lignes: JSON.stringify(m.lignes)
        }));
        if (modeles.length > 0) {
            const wsModeles = XLSX.utils.json_to_sheet(modeles);
            XLSX.utils.book_append_sheet(wb, wsModeles, "ModÃ¨les");
        }
        
        const scenarios = this.data.scenarios.map(s => ({
            ID: s.id,
            Nom: s.nom,
            Actuel: s.actuel,
            Mensuel: s.mensuel,
            Taux: s.taux,
            AnnÃ©es: s.annees
        }));
        if (scenarios.length > 0) {
            const wsScenarios = XLSX.utils.json_to_sheet(scenarios);
            XLSX.utils.book_append_sheet(wb, wsScenarios, "ScÃ©narios");
        }

        // â”€â”€ Nouvelles feuilles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (this.data.objectifs.length > 0) {
            const wsObj = XLSX.utils.json_to_sheet(this.data.objectifs.map(o => ({
                ID: o.id, Nom: o.nom, Emoji: o.emoji,
                Cible: o.cible, Actuel: o.actuel, DateCible: o.dateTarget || ''
            })));
            XLSX.utils.book_append_sheet(wb, wsObj, "Objectifs");
        }

        if (this.data.notes.length > 0) {
            const wsNotes = XLSX.utils.json_to_sheet(this.data.notes.map(n => ({
                ID: n.id, Mois: n.mois, Tag: n.tag, Texte: n.texte
            })));
            XLSX.utils.book_append_sheet(wb, wsNotes, "Notes");
        }

        if (this.data.recurrences.length > 0) {
            const wsRec = XLSX.utils.json_to_sheet(this.data.recurrences.map(r => ({
                ID: r.id, Nom: r.nom, Emoji: r.emoji,
                Montant: r.montant, Jour: r.jour, Freq: r.freq, Actif: r.actif ? 1 : 0
            })));
            XLSX.utils.book_append_sheet(wb, wsRec, "RÃ©currences");
        }

        if (this.data.lignesPEA.length > 0) {
            const wsLignes = XLSX.utils.json_to_sheet(this.data.lignesPEA.map(l => ({
                ID: l.id, Nom: l.nom, ISIN: l.isin || '', Ticker: l.ticker || '',
                Parts: l.parts, PRU: l.pru, ValeurActuelle: l.valeurActuelle || l.pru
            })));
            XLSX.utils.book_append_sheet(wb, wsLignes, "LignesPEA");
        }

        if (Object.keys(this.data.allocationCible).length > 0) {
            const wsAlloc = XLSX.utils.json_to_sheet(
                Object.entries(this.data.allocationCible).map(([nom, pct]) => ({ Nom: nom, Cible: pct }))
            );
            XLSX.utils.book_append_sheet(wb, wsAlloc, "AllocationCible");
        }

        // ParamÃ¨tres (salaire inclus)
        const wsParams = XLSX.utils.json_to_sheet([{
            Theme: this.data.parametres.theme || 'auto',
            Salaire: this.data.parametres.salaire || 0
        }]);
        XLSX.utils.book_append_sheet(wb, wsParams, "ParamÃ¨tres");

        // Couleurs donut
        if (this.data.categorieColors && Object.keys(this.data.categorieColors).length > 0) {
            const wsColors = XLSX.utils.json_to_sheet(
                Object.entries(this.data.categorieColors).map(([compte, couleur]) => ({ Compte: compte, Couleur: couleur }))
            );
            XLSX.utils.book_append_sheet(wb, wsColors, "CouleurDonut");
        }
        
        XLSX.writeFile(wb, 'suivi-financier-backup-' + new Date().toISOString().split('T')[0] + '.xlsx');
        
        this.data.parametres.lastBackup = Date.now();
        this.save();
        this.checkBackupReminder();
        this.notify('ğŸ’¾ Sauvegarde rÃ©ussie', 'success');
    },
    
    importExcel() {
        const file = document.getElementById('import-excel').files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const workbook = XLSX.read(e.target.result, { type: 'binary' });
                
                if (workbook.SheetNames.includes('DÃ©penses')) {
                    const ws = workbook.Sheets['DÃ©penses'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.depenses = data.map(d => ({
                        id: d.ID || Date.now() + Math.random(),
                        categorie: d.CatÃ©gorie,
                        montant: d.Montant,
                        date: d.Date,
                        note: d.Note
                    }));
                }
                
                if (workbook.SheetNames.includes('PEA')) {
                    const ws = workbook.Sheets['PEA'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.suiviPEA = data.map(p => ({
                        id: p.ID || Date.now() + Math.random(),
                        date: p.Date,
                        valeur: p.Valeur,
                        investi: p.Investi,
                        gainPerte: p.GainPerte,
                        performance: p.Performance,
                        note: p.Note
                    }));
                }
                
                if (workbook.SheetNames.includes('Patrimoine')) {
                    const ws = workbook.Sheets['Patrimoine'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.patrimoine = data.map(p => {
                        const obj = {
                            id: p.ID || Date.now() + Math.random(),
                            mois: p.Mois,
                            total: p.Total
                        };
                        this.data.comptes.forEach(compte => {
                            if (p[compte] !== undefined) obj[compte] = p[compte];
                        });
                        return obj;
                    });
                }
                
                if (workbook.SheetNames.includes('Budgets')) {
                    const ws = workbook.Sheets['Budgets'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.budgets = {};
                    data.forEach(b => {
                        this.data.budgets[b.CatÃ©gorie] = b.Budget;
                    });
                }
                
                if (workbook.SheetNames.includes('Comptes')) {
                    const ws = workbook.Sheets['Comptes'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.comptes = data.sort((a, b) => a.Ordre - b.Ordre).map(c => c.Compte);
                }
                
                if (workbook.SheetNames.includes('ModÃ¨les')) {
                    const ws = workbook.Sheets['ModÃ¨les'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.modeles = data.map(m => ({
                        id: m.ID,
                        nom: m.Nom,
                        lignes: JSON.parse(m.Lignes || '[]')
                    }));
                }
                
                if (workbook.SheetNames.includes('ScÃ©narios')) {
                    const ws = workbook.Sheets['ScÃ©narios'];
                    const data = XLSX.utils.sheet_to_json(ws);
                    this.data.scenarios = data.map(s => ({
                        id: s.ID,
                        nom: s.Nom,
                        actuel: s.Actuel,
                        mensuel: s.Mensuel,
                        taux: s.Taux,
                        annees: s.AnnÃ©es
                    }));
                }

                // â”€â”€ Nouvelles feuilles (ignorÃ©es si absent = ancien export) â”€â”€
                if (workbook.SheetNames.includes('Objectifs')) {
                    const ws = workbook.Sheets['Objectifs'];
                    this.data.objectifs = XLSX.utils.sheet_to_json(ws).map(o => ({
                        id: o.ID, nom: o.Nom, emoji: o.Emoji || 'ğŸ¯',
                        cible: o.Cible, actuel: o.Actuel, dateTarget: o.DateCible || ''
                    }));
                }

                if (workbook.SheetNames.includes('Notes')) {
                    const ws = workbook.Sheets['Notes'];
                    this.data.notes = XLSX.utils.sheet_to_json(ws).map(n => ({
                        id: n.ID, mois: n.Mois, tag: n.Tag, texte: n.Texte
                    }));
                }

                if (workbook.SheetNames.includes('RÃ©currences')) {
                    const ws = workbook.Sheets['RÃ©currences'];
                    this.data.recurrences = XLSX.utils.sheet_to_json(ws).map(r => ({
                        id: r.ID, nom: r.Nom, emoji: r.Emoji || 'ğŸ’³',
                        montant: r.Montant, jour: r.Jour, freq: r.Freq, actif: r.Actif === 1
                    }));
                }

                if (workbook.SheetNames.includes('LignesPEA')) {
                    const ws = workbook.Sheets['LignesPEA'];
                    this.data.lignesPEA = XLSX.utils.sheet_to_json(ws).map(l => ({
                        id: l.ID, nom: l.Nom, isin: l.ISIN || '', ticker: l.Ticker || '',
                        parts: l.Parts, pru: l.PRU, valeurActuelle: l.ValeurActuelle || l.PRU
                    }));
                }

                if (workbook.SheetNames.includes('AllocationCible')) {
                    const ws = workbook.Sheets['AllocationCible'];
                    this.data.allocationCible = {};
                    XLSX.utils.sheet_to_json(ws).forEach(r => {
                        this.data.allocationCible[r.Nom] = r.Cible;
                    });
                }

                if (workbook.SheetNames.includes('ParamÃ¨tres')) {
                    const ws = workbook.Sheets['ParamÃ¨tres'];
                    const rows = XLSX.utils.sheet_to_json(ws);
                    if (rows.length > 0) {
                        if (rows[0].Salaire !== undefined) this.data.parametres.salaire = rows[0].Salaire;
                        if (rows[0].Theme) this.data.parametres.theme = rows[0].Theme;
                    }
                }

                if (workbook.SheetNames.includes('CouleurDonut')) {
                    const ws = workbook.Sheets['CouleurDonut'];
                    this.data.categorieColors = {};
                    XLSX.utils.sheet_to_json(ws).forEach(r => {
                        if (r.Compte && r.Couleur) this.data.categorieColors[r.Compte] = r.Couleur;
                    });
                }
                
                this.save();
                this.updateBudgetsUI();
                this.updateComptesUI();
                this.updateCategoriesSelects();
                this.notify('Restauration rÃ©ussie', 'success');
                location.reload();
            } catch (err) {
                this.notify('Erreur lors de l\'import', 'error');
                console.error(err);
            }
        };
        reader.readAsBinaryString(file);
    },
    
    initDates() {
        const today = new Date().toISOString().split('T')[0];
        const month = today.slice(0, 7);
        document.getElementById('dep-date').value = today;
        document.getElementById('pea-date').value = today;
        document.getElementById('pat-mois').value = month;
        document.getElementById('analyse-mois').value = month;
        document.getElementById('analyse-annee').value = new Date().getFullYear();
        document.getElementById('note-mois').value = month;
    },
    
    switchTab(name) {
        document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
        const tab = document.getElementById('tab-' + name);
        if (tab) tab.classList.add('active');
        // Active le bouton nav correct
        document.querySelectorAll('.nav-tab').forEach(t => {
            if (t.getAttribute('onclick') && t.getAttribute('onclick').includes("'" + name + "'")) t.classList.add('active');
        });
        if (name === 'dashboard') { this.refreshDashboard(); this.refreshHeatmap(); }
        if (name === 'depenses') { this.analyseDepenses(); this.refreshRegle503020(); this.refreshPrediction(); this.refreshComparaison(); }
        if (name === 'objectifs') { this.refreshObjectifs(); this.refreshSimulateur(); }
        if (name === 'bilan') { this.refreshNotes(); this.refreshBilanAnnuel(); this.initRapportSelect(); }
        if (name === 'pea') { this.refreshLignesPEA(); this.refreshAllocationPEA(); }
        if (name === 'patrimoine') { this.refreshInflation(); }
    },

    toggleAvance() {
        document.getElementById('avance-panel').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
    },

    // ===================== HEATMAP ANNUELLE =====================
    refreshHeatmap() {
        const now = new Date();
        const annee = now.getFullYear();
        const el = document.getElementById('heatmap-annee');
        if (el) el.textContent = annee;
        const moisLabels = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
        const labels = document.getElementById('heatmap-months-labels');
        const grid = document.getElementById('heatmap-grid');
        if (!labels || !grid) return;
        const totaux = Array(12).fill(0);
        this.data.depenses.forEach(d => {
            const date = new Date(d.date);
            if (date.getFullYear() === annee) totaux[date.getMonth()] += d.montant;
        });
        const max = Math.max(...totaux, 1);
        labels.innerHTML = moisLabels.map(m =>
            `<div style="font-family:'DM Mono',monospace;font-size:0.5rem;color:var(--text-tertiary);text-align:center">${m}</div>`
        ).join('');
        grid.innerHTML = totaux.map((val, i) => {
            const intensity = val / max;
            const isCurrent = i === now.getMonth();
            const alpha = val === 0 ? 0 : (0.1 + intensity * 0.9);
            const bg = val === 0 ? 'var(--bg-secondary)' : `rgba(var(--heatmap-rgb),${alpha.toFixed(2)})`;
            return `<div
                title="${moisLabels[i]}: ${this.formatCurrency(val)}"
                onclick="app.heatmapClick(${i},'${annee}')"
                style="aspect-ratio:1;border-radius:5px;background:${bg};border:${isCurrent ? '2px solid var(--accent-primary)' : '1px solid var(--border-color)'};cursor:pointer;transition:transform .12s"
                onmouseover="this.style.transform='scale(1.2)'"
                onmouseout="this.style.transform='scale(1)'"></div>`;
        }).join('');
        const moisMax = totaux.indexOf(max);
        const legend = document.getElementById('heatmap-legend');
        if (legend && max > 0) legend.textContent = `Mois le + chargÃ© : ${moisLabels[moisMax]} (${this.formatCurrency(max)})`;
    },

    heatmapClick(moisIndex, annee) {
        const moisStr = `${annee}-${String(moisIndex + 1).padStart(2,'0')}`;
        this.switchTab('depenses');
        const sel = document.getElementById('analyse-periode');
        if (sel) { sel.value = 'mois-choisi'; this.toggleAnalyseFilters(); }
        const inp = document.getElementById('analyse-mois');
        if (inp) { inp.value = moisStr; this.analyseDepenses(); }
    },

    // ===================== PRÃ‰DICTION FIN DE MOIS =====================
    refreshPrediction() {
        const now = new Date();
        const jourActuel = now.getDate();
        const dernierJour = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
        const budgetTotal = Object.values(this.data.budgets || {}).reduce((s, v) => s + v, 0);
        const depMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        });
        const totalActuel = depMois.reduce((s, d) => s + d.montant, 0);
        const projete = jourActuel > 0 ? (totalActuel / jourActuel) * dernierJour : 0;
        const g = id => document.getElementById(id);
        if (!g('pred-actuel')) return;
        g('pred-actuel').textContent = this.formatCurrency(totalActuel);
        g('pred-projete').textContent = this.formatCurrency(projete);
        g('pred-budget').textContent = this.formatCurrency(budgetTotal);
        const pctReel = budgetTotal > 0 ? Math.min(100, (totalActuel / budgetTotal) * 100) : 0;
        g('pred-bar-reel').style.width = pctReel + '%';
        g('pred-bar-reel-label').textContent = `${pctReel.toFixed(0)}% â€” j${jourActuel}/${dernierJour}`;
        const pctProj = budgetTotal > 0 ? (projete / budgetTotal) * 100 : 0;
        const over = projete > budgetTotal && budgetTotal > 0;
        g('pred-bar-proj').style.width = Math.min(100, pctProj) + '%';
        g('pred-bar-proj').style.background = over ? 'linear-gradient(90deg,#f44336,#e57373)' : 'linear-gradient(90deg,#ff9800,#ffb74d)';
        g('pred-bar-proj-label').textContent = `${pctProj.toFixed(0)}% projetÃ©`;
        const msg = g('pred-message');
        msg.style.display = 'block';
        if (over) {
            msg.style.cssText += ';background:rgba(244,67,54,0.08);border-left:3px solid var(--danger)';
            msg.innerHTML = `âš ï¸ DÃ©passement probable de <strong>${this.formatCurrency(projete - budgetTotal)}</strong> si tu continues Ã  ce rythme.`;
        } else {
            msg.style.cssText += ';background:rgba(0,200,83,0.08);border-left:3px solid var(--success)';
            msg.innerHTML = `âœ… Projection dans les limites â€” <strong>${this.formatCurrency(budgetTotal - projete)}</strong> de marge en fin de mois.`;
        }
        const badge = g('pred-badge');
        if (badge) {
            badge.textContent = over ? 'âš ï¸ DÃ©passement prÃ©vu' : 'âœ… Dans les limites';
            badge.style.background = over ? 'rgba(244,67,54,0.1)' : 'rgba(0,200,83,0.1)';
            badge.style.color = over ? 'var(--danger)' : 'var(--success)';
        }
    },

    // ===================== COMPARAISON MOIS VS MOIS =====================
    initComparaisonSelects() {
        const moisDispo = [...new Set(this.data.depenses.map(d => d.date.slice(0,7)))].sort().reverse();
        if (moisDispo.length === 0) return;
        // mois-a = mois prÃ©cÃ©dent (rÃ©fÃ©rence), mois-b = mois actuel (comparÃ©)
        const defaults = [moisDispo[1] || moisDispo[0], moisDispo[0]];
        ['comp-mois-a','comp-mois-b'].forEach((id, i) => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const current = sel.value;
            const defaultVal = current || defaults[i];
            sel.innerHTML = moisDispo.map(m => `<option value="${m}" ${m === defaultVal ? 'selected' : ''}>${m}</option>`).join('');
        });
    },

    refreshComparaison() {
        this.initComparaisonSelects();
        const moisA = document.getElementById('comp-mois-a')?.value;
        const moisB = document.getElementById('comp-mois-b')?.value;
        const container = document.getElementById('comparaison-container');
        if (!container) return;
        if (!moisA || !moisB || moisA === moisB) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>SÃ©lectionne deux mois diffÃ©rents</div></div>';
            return;
        }
        const depA = this.data.depenses.filter(d => d.date.startsWith(moisA));
        const depB = this.data.depenses.filter(d => d.date.startsWith(moisB));
        if (depA.length === 0 && depB.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>Pas de donnÃ©es sur ces mois</div></div>';
            return;
        }
        const totA = depA.reduce((s, d) => s + d.montant, 0);
        const totB = depB.reduce((s, d) => s + d.montant, 0);
        const cats = [...new Set([...depA, ...depB].map(d => d.categorie))].sort();
        const catMax = Math.max(...cats.map(cat => {
            const a = depA.filter(d => d.categorie === cat).reduce((s, d) => s + d.montant, 0);
            const b = depB.filter(d => d.categorie === cat).reduce((s, d) => s + d.montant, 0);
            return Math.max(a, b);
        }), 1);

        const diffTotal = totB - totA;
        const pctTotal = totA > 0 ? ((diffTotal / totA) * 100).toFixed(1) : 0;
        const signTotal = diffTotal >= 0 ? '+' : '';
        const colorTotal = diffTotal > 0 ? 'var(--danger)' : diffTotal < 0 ? 'var(--success)' : 'var(--text-secondary)';

        const rows = cats.map(cat => {
            const a = depA.filter(d => d.categorie === cat).reduce((s, d) => s + d.montant, 0);
            const b = depB.filter(d => d.categorie === cat).reduce((s, d) => s + d.montant, 0);
            const diff = b - a;
            const sign = diff > 0 ? '+' : '';
            const diffColor = diff > 0 ? 'var(--danger)' : diff < 0 ? 'var(--success)' : 'var(--text-tertiary)';
            const wA = (a / catMax * 100).toFixed(1);
            const wB = (b / catMax * 100).toFixed(1);
            return `<div style="display:flex;align-items:center;gap:0.75rem;padding:0.45rem 0;border-bottom:1px solid var(--border-color)">
                <span style="font-size:0.78rem;color:var(--text-secondary);min-width:80px;font-family:'Inter',sans-serif">${cat}</span>
                <div style="flex:1;height:20px;background:var(--bg-secondary);border-radius:6px;position:relative;overflow:hidden;box-shadow:inset 2px 2px 4px var(--shadow-light)">
                    <div style="position:absolute;top:2px;bottom:2px;left:0;width:${wA}%;background:rgba(var(--heatmap-rgb),0.55);border-radius:4px;min-width:2px"></div>
                    <div style="position:absolute;top:2px;bottom:2px;left:0;width:${wB}%;background:rgba(var(--heatmap-rgb),0.25);border-radius:4px;min-width:2px;border-left:2px solid var(--bg-secondary)"></div>
                </div>
                <span style="font-family:'DM Mono',monospace;font-size:0.65rem;min-width:48px;text-align:right;font-weight:600;color:${diffColor}">${sign}${this.formatCurrency(Math.abs(diff))}</span>
            </div>`;
        }).join('');

        container.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:0.75rem 1rem;background:var(--bg-secondary);border-radius:14px;margin-bottom:1rem;box-shadow:inset 2px 2px 6px var(--shadow-light),inset -2px -2px 6px var(--shadow-dark)">
                <div style="display:flex;flex-direction:column;gap:0.35rem">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <div style="width:10px;height:10px;border-radius:2px;background:rgba(var(--heatmap-rgb),0.55);flex-shrink:0"></div>
                        <span style="font-size:0.82rem;font-weight:600;color:var(--text-primary)">${moisA}</span>
                        <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-tertiary)">${this.formatCurrency(totA)}</span>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <div style="width:10px;height:10px;border-radius:2px;background:rgba(var(--heatmap-rgb),0.25);flex-shrink:0;border:1px solid rgba(var(--heatmap-rgb),0.4)"></div>
                        <span style="font-size:0.82rem;font-weight:600;color:var(--text-primary)">${moisB}</span>
                        <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-tertiary)">${this.formatCurrency(totB)}</span>
                    </div>
                </div>
                <div style="text-align:right">
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);font-family:'DM Mono',monospace;margin-bottom:0.2rem">Ã‰volution globale</div>
                    <div style="font-family:'Outfit',sans-serif;font-size:1.4rem;font-weight:800;color:${colorTotal};line-height:1">${signTotal}${pctTotal}%</div>
                    <div style="font-family:'DM Mono',monospace;font-size:0.65rem;color:${colorTotal};margin-top:0.1rem">${signTotal}${this.formatCurrency(Math.abs(diffTotal))}</div>
                </div>
            </div>
            ${rows}`;
    },

    // ===================== SIMULATEUR ET SI =====================
    _simHorizon: 10,
    simSetHorizon(ans) {
        this._simHorizon = ans;
        [5, 10, 20, 30].forEach(n => {
            const btn = document.getElementById('sim-' + n);
            if (btn) btn.className = n === ans ? 'btn btn-small' : 'btn btn-small btn-secondary';
        });
        this.refreshSimulateur();
    },
    refreshSimulateur() {
        const epargne = parseFloat(document.getElementById('sim-epargne')?.value) || 300;
        const taux = parseFloat(document.getElementById('sim-taux')?.value) || 6;
        const horizon = this._simHorizon || 10;
        const g = id => document.getElementById(id);
        if (g('sim-epargne-val')) g('sim-epargne-val').textContent = epargne + ' â‚¬';
        if (g('sim-taux-val')) g('sim-taux-val').textContent = taux + '%';
        const r = taux / 100 / 12;
        const n = horizon * 12;
        const capital = r > 0 ? epargne * ((Math.pow(1 + r, n) - 1) / r) : epargne * n;
        const verse = epargne * n;
        const interets = capital - verse;
        if (g('sim-result-capital')) g('sim-result-capital').textContent = this.formatCurrency(capital);
        if (g('sim-result-verse')) g('sim-result-verse').textContent = this.formatCurrency(verse);
        if (g('sim-result-interets')) g('sim-result-interets').textContent = this.formatCurrency(interets);
        const mult = (capital / verse).toFixed(1);
        const conseil = g('sim-conseil');
        if (conseil) conseil.innerHTML = `ğŸ’¡ En ${horizon} ans tu multiplies ta mise par <strong>${mult}x</strong>. Les intÃ©rÃªts reprÃ©sentent <strong>${((interets/capital)*100).toFixed(0)}%</strong> du capital â€” la magie des intÃ©rÃªts composÃ©s.`;
    },

    // ===================== INFLATION PERSO =====================
    initInflationSelects() {
        const annees = [...new Set(this.data.depenses.map(d => new Date(d.date).getFullYear()))].sort().reverse();
        const now = new Date().getFullYear();
        ['infl-annee-a','infl-annee-b'].forEach((id, i) => {
            const sel = document.getElementById(id);
            if (!sel) return;
            sel.innerHTML = annees.map(a => `<option value="${a}" ${a === (i === 0 ? now : now - 1) ? 'selected' : ''}>${a}</option>`).join('');
        });
    },
    refreshInflation() {
        this.initInflationSelects();
        const anneeA = parseInt(document.getElementById('infl-annee-a')?.value);
        const anneeB = parseInt(document.getElementById('infl-annee-b')?.value);
        const container = document.getElementById('inflation-container');
        if (!container) return;
        const depA = this.data.depenses.filter(d => new Date(d.date).getFullYear() === anneeA);
        const depB = this.data.depenses.filter(d => new Date(d.date).getFullYear() === anneeB);
        if (depA.length === 0 || depB.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>Pas assez de donnÃ©es pour ces deux annÃ©es</div></div>';
            return;
        }
        const totA = depA.reduce((s, d) => s + d.montant, 0);
        const totB = depB.reduce((s, d) => s + d.montant, 0);
        const inflGlobale = totB > 0 ? ((totA - totB) / totB * 100) : 0;
        const cats = [...new Set([...depA, ...depB].map(d => d.categorie))];
        const catData = cats.map(cat => {
            const a = depA.filter(d => d.categorie === cat).reduce((s, d) => s + d.montant, 0);
            const b = depB.filter(d => d.categorie === cat).reduce((s, d) => s + d.montant, 0);
            if (b === 0) return null;
            return { cat, a, b, infl: parseFloat(((a - b) / b * 100).toFixed(1)) };
        }).filter(Boolean).sort((a, b) => Math.abs(b.infl) - Math.abs(a.infl)).slice(0, 7);
        const inflColor = inflGlobale > 5 ? 'var(--danger)' : inflGlobale > 2 ? 'var(--warning)' : 'var(--success)';
        const maxAbs = Math.max(...catData.map(c => Math.abs(c.infl)), 1);
        container.innerHTML = `
            <div style="text-align:center;padding:1rem 0">
                <div class="stat-label">Hausse de tes dÃ©penses ${anneeB} â†’ ${anneeA}</div>
                <div style="font-family:'Outfit',sans-serif;font-size:2.8rem;font-weight:800;color:${inflColor};line-height:1.1">${inflGlobale > 0 ? '+' : ''}${inflGlobale.toFixed(1)}%</div>
                <div style="font-size:0.78rem;color:var(--text-tertiary);margin-top:0.2rem">${this.formatCurrency(totB)} â†’ ${this.formatCurrency(totA)}</div>
            </div>
            <div style="display:flex;flex-direction:column;gap:0.5rem;margin-top:0.75rem">
                ${catData.map(c => {
                    const pct = (Math.abs(c.infl) / maxAbs * 100).toFixed(0);
                    const color = c.infl > 5 ? 'rgba(244,67,54,0.5)' : c.infl > 0 ? 'rgba(255,152,0,0.5)' : 'rgba(0,200,83,0.5)';
                    return `<div style="display:flex;align-items:center;gap:0.75rem">
                        <span style="font-size:0.78rem;color:var(--text-secondary);min-width:80px">${c.cat}</span>
                        <div style="flex:1;height:8px;border-radius:100px;background:var(--bg-secondary);overflow:hidden">
                            <div style="width:${pct}%;height:100%;background:${color};border-radius:100px"></div>
                        </div>
                        <span style="font-family:'DM Mono',monospace;font-size:0.72rem;min-width:45px;text-align:right;color:${c.infl > 0 ? 'var(--danger)' : 'var(--success)'}">${c.infl > 0 ? '+' : ''}${c.infl}%</span>
                    </div>`;
                }).join('')}
            </div>`;
    },

    // ===================== BILAN ANNUEL =====================
    initBilanSelect() {
        const annees = [...new Set(this.data.depenses.map(d => new Date(d.date).getFullYear()))].sort().reverse();
        if (annees.length === 0) return;
        const sel = document.getElementById('bilan-annee');
        if (!sel) return;
        const now = new Date().getFullYear();
        sel.innerHTML = annees.map(a => `<option value="${a}" ${a === now ? 'selected' : ''}>${a}</option>`).join('');
    },
    refreshBilanAnnuel() {
        this.initBilanSelect();
        const annee = parseInt(document.getElementById('bilan-annee')?.value) || new Date().getFullYear();
        const container = document.getElementById('bilan-annuel-container');
        if (!container) return;
        const deps = this.data.depenses.filter(d => new Date(d.date).getFullYear() === annee);
        if (deps.length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ…</div><div>Pas de donnÃ©es pour ${annee}</div></div>`;
            return;
        }
        const mL = ['Jan','FÃ©v','Mar','Avr','Mai','Jun','Jul','AoÃ»','Sep','Oct','Nov','DÃ©c'];
        const parMois = Array(12).fill(0);
        deps.forEach(d => parMois[new Date(d.date).getMonth()] += d.montant);
        const total = deps.reduce((s, d) => s + d.montant, 0);
        const salaire = this.data.parametres?.salaire || 0;
        const totalRevenu = salaire * 12;
        const epargne = totalRevenu > 0 ? Math.max(0, totalRevenu - total) : 0;
        const txEpargne = totalRevenu > 0 ? ((epargne / totalRevenu) * 100).toFixed(0) : null;
        const maxMois = Math.max(...parMois, 1);
        const moisMax = parMois.indexOf(Math.max(...parMois));
        const moisSage = parMois.indexOf(Math.min(...parMois.filter(v => v > 0)));
        const parCat = {};
        deps.forEach(d => parCat[d.categorie] = (parCat[d.categorie] || 0) + d.montant);
        const catMax = Object.entries(parCat).sort((a, b) => b[1] - a[1])[0];
        container.innerHTML = `
            <div class="grid grid-3 grid-stats" style="margin-bottom:1.5rem">
                <div class="stat-card stat-card-main"><div class="stat-label">Total dÃ©pensÃ© ${annee}</div><div class="stat-value accent">${this.formatCurrency(total)}</div></div>
                <div class="stat-card stat-card-main"><div class="stat-label">Ã‰pargne estimÃ©e</div><div class="stat-value" style="color:${epargne > 0 ? 'var(--success)' : 'var(--text-primary)'}">${totalRevenu > 0 ? this.formatCurrency(epargne) : 'â€”'}</div></div>
                <div class="stat-card stat-card-main"><div class="stat-label">Taux d'Ã©pargne</div><div class="stat-value accent">${txEpargne !== null ? txEpargne + '%' : 'â€”'}</div></div>
            </div>
            <div class="grid grid-2" style="margin-bottom:1.5rem">
                <div style="background:var(--bg-secondary);border-radius:14px;padding:1rem;border:1px solid var(--border-color)">
                    <div class="stat-label" style="margin-bottom:0.75rem">DÃ©penses mois par mois</div>
                    <div style="display:flex;align-items:flex-end;gap:3px;height:70px">
                        ${parMois.map((v, i) => {
                            const h = Math.max(3, (v / maxMois * 100).toFixed(0));
                            return `<div title="${mL[i]}: ${this.formatCurrency(v)}" style="flex:1;height:${h}%;border-radius:3px 3px 0 0;background:${i === moisMax ? 'var(--danger)' : 'linear-gradient(180deg,var(--accent-gradient-start),var(--accent-gradient-end))'};opacity:0.85;min-height:3px;cursor:default"></div>`;
                        }).join('')}
                    </div>
                </div>
                <div style="display:flex;flex-direction:column;gap:0.5rem">
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:0.75rem;border:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">
                        <span class="stat-label">ğŸ† Mois le + sage</span><strong>${moisSage >= 0 ? mL[moisSage] : 'â€”'}</strong>
                    </div>
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:0.75rem;border:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">
                        <span class="stat-label">ğŸ˜¬ Mois le + chargÃ©</span><strong style="color:var(--danger)">${mL[moisMax]}</strong>
                    </div>
                    <div style="background:var(--bg-secondary);border-radius:12px;padding:0.75rem;border:1px solid var(--border-color);display:flex;justify-content:space-between;align-items:center">
                        <span class="stat-label">ğŸ’¸ CatÃ©gorie principale</span><strong>${catMax ? catMax[0] : 'â€”'}</strong>
                    </div>
                </div>
            </div>
            <div style="padding:1rem;background:linear-gradient(135deg,rgba(63,81,181,0.06),rgba(124,58,237,0.04));border-radius:14px;border:1px solid rgba(63,81,181,0.12);font-style:italic;color:var(--text-secondary);line-height:1.7;font-size:0.9rem">
                ğŸ’¬ <strong>RÃ©sumÃ© ${annee} :</strong> Tu as dÃ©pensÃ© ${this.formatCurrency(total)} au total.${catMax ? ` CatÃ©gorie principale : <strong>${catMax[0]}</strong> (${this.formatCurrency(catMax[1])}).` : ''} ${txEpargne !== null ? `Taux d'Ã©pargne estimÃ© : <strong>${txEpargne}%</strong>.` : 'Renseigne ton salaire dans âš™ pour voir ton taux d\'Ã©pargne.'}
            </div>`;
    },

    // ===================== RAPPORT MENSUEL =====================
    initRapportSelect() {
        const moisDispo = [...new Set(this.data.depenses.map(d => d.date.slice(0,7)))].sort().reverse();
        const sel = document.getElementById('rapport-mois');
        if (!sel) return;
        const now = new Date().toISOString().slice(0,7);
        sel.innerHTML = moisDispo.map(m => `<option value="${m}" ${m === now ? 'selected' : ''}>${m}</option>`).join('');
    },
    genererRapport() {
        const mois = document.getElementById('rapport-mois')?.value;
        const container = document.getElementById('rapport-container');
        if (!container || !mois) return;
        const deps = this.data.depenses.filter(d => d.date.startsWith(mois));
        const total = deps.reduce((s, d) => s + d.montant, 0);
        const budgetTotal = Object.values(this.data.budgets || {}).reduce((s, v) => s + v, 0);
        const salaire = this.data.parametres?.salaire || 0;
        const resteBudget = budgetTotal - total;
        const parCat = {};
        deps.forEach(d => parCat[d.categorie] = (parCat[d.categorie] || 0) + d.montant);
        const catsSorted = Object.entries(parCat).sort((a, b) => b[1] - a[1]);
        const maxCat = catsSorted[0]?.[1] || 1;
        const moisLabel = new Date(mois + '-01').toLocaleDateString('fr-FR', {month:'long',year:'numeric'});
        const obj = this.data.objectifs || [];
        const peaList = this.data.suiviPEA || [];
        const peaLast = peaList.filter(p => p.date.startsWith(mois)).pop() || peaList[peaList.length - 1];
        const epargne = salaire > 0 ? Math.max(0, salaire - total) : null;
        document.getElementById('btn-imprimer').style.display = 'inline-flex';
        container.innerHTML = `
        <div id="rapport-print" style="background:white;border-radius:16px;padding:2rem;border:1px solid var(--border-color)">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;padding-bottom:1rem;border-bottom:2px solid #e8edf2">
                <div>
                    <div style="font-family:'DM Mono',monospace;font-size:0.6rem;letter-spacing:0.15em;text-transform:uppercase;color:#7891ab">Bilan financier</div>
                    <div style="font-family:'Outfit',sans-serif;font-size:1.6rem;font-weight:800;color:#1e3a5f">${moisLabel.charAt(0).toUpperCase()+moisLabel.slice(1)}</div>
                </div>
                <div style="text-align:right">
                    <div style="font-family:'Outfit',sans-serif;font-size:1.8rem;font-weight:800;background:linear-gradient(135deg,#3f51b5,#7c4dff);-webkit-background-clip:text;-webkit-text-fill-color:transparent">${this.formatCurrency(total)}</div>
                    <div style="font-family:'DM Mono',monospace;font-size:0.7rem;color:${resteBudget >= 0 ? '#00c853' : '#f44336'}">${resteBudget >= 0 ? 'âœ…' : 'âš ï¸'} ${resteBudget >= 0 ? '+' : ''}${this.formatCurrency(resteBudget)} vs budget</div>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:repeat(${salaire > 0 ? 4 : 3},1fr);gap:0.75rem;margin-bottom:1.5rem">
                ${[
                    ['DÃ©penses', this.formatCurrency(total), '#1e3a5f'],
                    ['Budget', this.formatCurrency(budgetTotal), '#1e3a5f'],
                    ['Utilisation', budgetTotal > 0 ? ((total/budgetTotal)*100).toFixed(0)+'%' : 'â€”', total > budgetTotal ? '#f44336' : '#1e3a5f'],
                    ...(epargne !== null ? [['Ã‰pargne', this.formatCurrency(epargne), '#00c853']] : [])
                ].map(([l,v,c]) => `<div style="background:#f5f9fc;border-radius:12px;padding:0.75rem;text-align:center">
                    <div style="font-family:'DM Mono',monospace;font-size:0.58rem;text-transform:uppercase;letter-spacing:0.08em;color:#7891ab">${l}</div>
                    <div style="font-family:'Outfit',sans-serif;font-size:1rem;font-weight:700;color:${c}">${v}</div>
                </div>`).join('')}
            </div>
            ${catsSorted.length > 0 ? `<div style="margin-bottom:1.5rem">
                <div style="font-family:'DM Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:#7891ab;margin-bottom:0.75rem">RÃ©partition par catÃ©gorie</div>
                ${catsSorted.map(([cat, val]) => `<div style="margin-bottom:0.5rem">
                    <div style="display:flex;justify-content:space-between;margin-bottom:0.2rem">
                        <span style="font-size:0.85rem;color:#2d3748">${cat}</span>
                        <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:#4a6785">${this.formatCurrency(val)} (${((val/total)*100).toFixed(0)}%)</span>
                    </div>
                    <div style="height:6px;background:#e8edf2;border-radius:100px;overflow:hidden">
                        <div style="width:${((val/maxCat)*100).toFixed(0)}%;height:100%;background:linear-gradient(90deg,#3f51b5,#7c4dff);border-radius:100px"></div>
                    </div>
                </div>`).join('')}
            </div>` : ''}
            ${peaLast ? `<div style="background:#f5f9fc;border-radius:12px;padding:1rem;margin-bottom:1.5rem;border:1px solid #d4e2ed">
                <div style="font-family:'DM Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:#7891ab;margin-bottom:0.5rem">PEA</div>
                <div style="display:flex;justify-content:space-between;font-size:0.85rem">
                    <span>Valeur : <strong>${this.formatCurrency(peaLast.valeur)}</strong></span>
                    <span style="color:${parseFloat(peaLast.performance)>=0?'#00c853':'#f44336'}">Perf : ${peaLast.performance}%</span>
                </div>
            </div>` : ''}
            ${obj.length > 0 ? `<div style="margin-bottom:1.5rem">
                <div style="font-family:'DM Mono',monospace;font-size:0.65rem;text-transform:uppercase;letter-spacing:0.1em;color:#7891ab;margin-bottom:0.75rem">Objectifs en cours</div>
                ${obj.map(o => { const pct = Math.min(100,(o.actuel/o.cible)*100).toFixed(0); return `<div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.5rem">
                    <span style="font-size:1.1rem">${o.emoji}</span>
                    <div style="flex:1">
                        <div style="display:flex;justify-content:space-between;margin-bottom:0.2rem">
                            <span style="font-size:0.85rem">${o.nom}</span>
                            <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:#4a6785">${pct}%</span>
                        </div>
                        <div style="height:5px;background:#e8edf2;border-radius:100px;overflow:hidden">
                            <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,#3f51b5,#7c4dff);border-radius:100px"></div>
                        </div>
                    </div>
                </div>`; }).join('')}
            </div>` : ''}
            <div style="text-align:center;font-family:'DM Mono',monospace;font-size:0.6rem;color:#a0aec0;padding-top:1rem;border-top:1px solid #e8edf2">GÃ©nÃ©rÃ© le ${new Date().toLocaleDateString('fr-FR')} â€” Suivi Financier</div>
        </div>`;
        this.notify('Rapport gÃ©nÃ©rÃ© âœ“', 'success');
    },
    imprimerRapport() {
        const el = document.getElementById('rapport-print');
        if (!el) return;
        const w = window.open('', '_blank');
        w.document.write(`<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Rapport</title>
            <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;700;800&family=DM+Mono&family=Crimson+Pro&display=swap" rel="stylesheet">
            <style>body{margin:1.5rem;font-family:'Crimson Pro',serif}@media print{body{margin:0}}</style>
            </head><body>${el.outerHTML}<script>window.onload=()=>window.print()<\/script></body></html>`);
        w.document.close();
    },

    // ===================== VOYAGES & Ã‰VÃ‰NEMENTS =====================
    toggleSettings() {
        document.getElementById('settings').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('active');
    },

    toggleBudgetsPanel() {
        const panel = document.getElementById('budgets-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    },
    
    toggleComptesPanel() {
        const panel = document.getElementById('comptes-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    },
    
    showModal(title, message, callback) {
        document.getElementById('confirmTitle').textContent = title;
        document.getElementById('confirmBody').textContent = message;
        document.getElementById('confirmModal').classList.add('active');
        document.getElementById('overlay').classList.add('active');
        this.confirmCallback = callback;
    },
    
    closeModal() {
        document.getElementById('confirmModal').classList.remove('active');
        if (!document.getElementById('inputModal').classList.contains('active')) {
            document.getElementById('overlay').classList.remove('active');
        }
        this.confirmCallback = null;
    },
    
    confirmAction() {
        if (this.confirmCallback) {
            this.confirmCallback();
            this.confirmCallback = null;
        }
        this.closeModal();
    },
    
    showInputModal(title, label1, label2, callback) {
        document.getElementById('inputTitle').textContent = title;
        document.getElementById('inputLabel').textContent = label1;
        document.getElementById('inputField').value = '';
        document.getElementById('inputField').placeholder = '';
        
        if (label2) {
            document.getElementById('inputField2Container').style.display = 'block';
            document.getElementById('inputLabel2').textContent = label2;
            document.getElementById('inputField2').value = '';
        } else {
            document.getElementById('inputField2Container').style.display = 'none';
        }
        
        document.getElementById('inputModal').classList.add('active');
        document.getElementById('overlay').classList.add('active');
        this.inputCallback = callback;
        
        setTimeout(() => document.getElementById('inputField').focus(), 100);
    },
    
    closeInputModal() {
        document.getElementById('inputModal').classList.remove('active');
        if (!document.getElementById('confirmModal').classList.contains('active')) {
            document.getElementById('overlay').classList.remove('active');
        }
        this.inputCallback = null;
    },
    
    submitInput() {
        const val1 = document.getElementById('inputField').value.trim();
        const val2 = document.getElementById('inputField2').value.trim();
        
        if (this.inputCallback) {
            this.inputCallback(val1, val2);
        }
        this.closeInputModal();
    },
    
    openAddCategoryModal() {
        this.showInputModal(
            'Nouvelle catÃ©gorie',
            'Nom de la catÃ©gorie',
            'Budget mensuel (â‚¬)',
            (nom, budget) => {
                if (!nom || nom === '') return;
                const nomUpper = nom.toUpperCase();
                if (this.data.budgets[nomUpper]) {
                    this.notify('Cette catÃ©gorie existe dÃ©jÃ ', 'error');
                    return;
                }
                const budgetNum = parseFloat(budget);
                if (!budgetNum || budgetNum < 0) return;
                
                this.data.budgets[nomUpper] = budgetNum;
                this.save();
                this.updateBudgetsUI();
                this.updateCategoriesSelects();
                this.notify('CatÃ©gorie ajoutÃ©e', 'success');
            }
        );
    },
    
    openAddCompteModal() {
        this.showInputModal(
            'Nouveau compte',
            'Nom du compte',
            null,
            (nom) => {
                if (!nom || nom === '') return;
                if (this.data.comptes.includes(nom)) {
                    this.notify('Ce compte existe dÃ©jÃ ', 'error');
                    return;
                }
                this.data.comptes.push(nom);
                this.save();
                this.updateComptesUI();
                this.notify('Compte ajoutÃ©', 'success');
            }
        );
    },
    
    changeTheme() {
        this.data.parametres.theme = document.getElementById('set-theme').value;
        this.applyTheme();
        this.save();
    },

    setZoom(level) {
        const scales = { 80: 0.80, 90: 0.90, 100: 1.00, 110: 1.10 };
        const target = scales[level] || 1;
        const wrapper = document.getElementById('zoom-wrapper');
        if (!wrapper) return;

        // Annule tout RAF en cours
        if (this._zoomRAF) { cancelAnimationFrame(this._zoomRAF); this._zoomRAF = null; }

        // Adapte la largeur immÃ©diatement pour que le layout se recalcule
        // avant l'animation visuelle â†’ jamais de dÃ©bordement
        wrapper.style.width = `${(100 / target).toFixed(4)}%`;
        wrapper.style.transformOrigin = 'top left';
        document.body.style.overflowX = 'hidden';

        // Spring lÃ©ger CSS : petit rebond Ã©lÃ©gant Ã  l'arrivÃ©e, 350ms, GPU
        wrapper.style.transition = 'transform 0.35s cubic-bezier(0.34, 1.56, 0.64, 1)';
        wrapper.style.transform = `scale(${target})`;

        // Sauvegarde + UI boutons
        this.data.parametres.zoom = level;
        this.save();
        document.querySelectorAll('.zoom-btn').forEach(btn => {
            btn.style.background = '';
            btn.style.color = '';
        });
        const activeBtn = document.getElementById('zoom-' + level);
        if (activeBtn) {
            activeBtn.style.background = 'linear-gradient(135deg, var(--accent-gradient-start), var(--accent-gradient-end))';
            activeBtn.style.color = 'white';
        }
    },
    
    applyTheme() {
        const theme = this.data.parametres.theme || 'auto';
        if (theme === 'auto') {
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            document.body.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
        } else {
            document.body.setAttribute('data-theme', theme);
        }
        setTimeout(() => this.refreshCharts(), 100);
    },
    
    updateBudgetsUI() {
        const container = document.getElementById('budgets-container');
        container.innerHTML = Object.keys(this.data.budgets).map(cat => `
            <div class="budget-item">
                <input type="text" class="form-input" value="${cat}" 
                       onblur="app.renommerCategorie('${cat}', this.value)"
                       onkeydown="if(event.key==='Enter') this.blur()"
                       title="Cliquer pour renommer"
                       style="cursor:text">
                <input type="number" class="form-input" value="${this.data.budgets[cat]}" 
                       step="10" onchange="app.updateBudget('${cat}', this.value)">
                <button class="btn btn-small btn-secondary" onclick="app.supprimerCategorieBudget('${cat}')">âœ•</button>
            </div>
        `).join('');
        this.updateBudgetTotal();
    },
    
    updateBudget(cat, value) {
        this.data.budgets[cat] = parseFloat(value) || 0;
        this.save();
        this.updateBudgetTotal();
        this.refreshStatsDepenses();
    },

    renommerCategorie(ancien, nouveau) {
        nouveau = nouveau.trim();
        if (!nouveau || nouveau === ancien) return;
        if (this.data.budgets[nouveau] !== undefined) {
            this.notify('Cette catÃ©gorie existe dÃ©jÃ  !', 'error');
            this.updateBudgetsUI();
            return;
        }
        // CrÃ©er la nouvelle clÃ© avec la valeur de l'ancienne
        const valeur = this.data.budgets[ancien];
        delete this.data.budgets[ancien];
        this.data.budgets[nouveau] = valeur;
        // Renommer dans les dÃ©penses existantes
        this.data.depenses.forEach(d => {
            if (d.categorie === ancien) d.categorie = nouveau;
        });
        this.save();
        this.updateBudgetsUI();
        this.updateCategoriesSelects();
        this.afficherDepenses();
        this.notify('CatÃ©gorie renommÃ©e en "' + nouveau + '"', 'success');
    },
    
    updateBudgetTotal() {
        const total = Object.values(this.data.budgets).reduce((sum, v) => sum + v, 0);
        document.getElementById('budget-total-alloue').textContent = this.formatCurrency(total);
    },
    
    supprimerCategorieBudget(cat) {
        this.showModal(
            'Supprimer la catÃ©gorie',
            'Voulez-vous vraiment supprimer la catÃ©gorie "' + cat + '" ? Les dÃ©penses existantes de cette catÃ©gorie seront conservÃ©es.',
            () => {
                delete this.data.budgets[cat];
                this.save();
                this.updateBudgetsUI();
                this.updateCategoriesSelects();
                this.notify('CatÃ©gorie supprimÃ©e', 'success');
            }
        );
    },
    
    updateCategoriesSelects() {
        const cats = Object.keys(this.data.budgets).sort();
        const depCat = document.getElementById('dep-cat');
        const analyseCat = document.getElementById('analyse-categorie');
        
        depCat.innerHTML = cats.map(c => `<option value="${c}">${c}</option>`).join('');
        analyseCat.innerHTML = '<option value="toutes">Toutes</option>' + 
            cats.map(c => `<option value="${c}">${c}</option>`).join('');
    },
    
    updateComptesUI() {
        const container = document.getElementById('comptes-patrimoine-container');
        container.innerHTML = this.data.comptes.map(compte => `
            <div class="budget-item">
                <input type="text" class="form-input" value="${compte}" 
                       onchange="app.renommerCompte('${compte}', this.value)">
                <button class="btn btn-small btn-secondary" onclick="app.supprimerCompte('${compte}')">âœ•</button>
            </div>
        `).join('');
        this.updatePatInputs();
        this.updatePatTableHeaders();
    },
    
    renommerCompte(ancien, nouveau) {
        if (!nouveau || nouveau.trim() === '') return;
        const index = this.data.comptes.indexOf(ancien);
        if (index === -1) return;
        this.data.comptes[index] = nouveau;
        this.data.patrimoine.forEach(p => {
            if (p[ancien] !== undefined) {
                p[nouveau] = p[ancien];
                delete p[ancien];
            }
        });
        this.save();
        this.updateComptesUI();
        this.afficherPatrimoine();
    },
    
    supprimerCompte(compte) {
        this.showModal(
            'Supprimer le compte',
            'Voulez-vous vraiment supprimer le compte "' + compte + '" ?',
            () => {
                this.data.comptes = this.data.comptes.filter(c => c !== compte);
                this.data.patrimoine.forEach(p => delete p[compte]);
                this.save();
                this.updateComptesUI();
                this.afficherPatrimoine();
                this.notify('Compte supprimÃ©', 'success');
            }
        );
    },
    
    updatePatInputs() {
        const container = document.getElementById('pat-inputs');
        container.innerHTML = this.data.comptes.map(compte => `
            <div class="form-group">
                <label class="form-label">${compte} (â‚¬)</label>
                <input type="number" class="form-input" id="pat-${compte.replace(/\s/g,'')}" 
                       placeholder="0.00" step="0.01">
            </div>
        `).join('');
    },
    
    updatePatTableHeaders() {
        const th = document.getElementById('pat-table-headers');
        th.outerHTML = this.data.comptes.map(c => `<th>${c}</th>`).join('') + '<th id="pat-table-headers" style="display:none"></th>';
    },
    
    ajouterDepense() {
        const cat = document.getElementById('dep-cat').value;
        const montant = parseFloat(document.getElementById('dep-montant').value);
        const date = document.getElementById('dep-date').value;
        const note = document.getElementById('dep-note').value;
        
        if (!montant || montant <= 0) {
            this.notify('Montant invalide', 'error');
            return;
        }
        
        this.data.depenses.push({
            id: Date.now(),
            categorie: cat,
            montant: montant,
            date: date,
            note: note
        });
        
        this.save();
        this.afficherDepenses();
        this.refreshStatsDepenses();
        this.analyseDepenses();
        this.refreshCharts();
        
        document.getElementById('dep-montant').value = '';
        document.getElementById('dep-note').value = '';
        this.notify('DÃ©pense ajoutÃ©e', 'success');
    },
    
    afficherDepenses() {
        const tbody = document.getElementById('table-depenses');
        const btnShowMore = document.getElementById('show-more-depenses');
        const depenses = this.data.depenses.sort((a, b) => b.id - a.id);
        
        if (depenses.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>Aucune dÃ©pense enregistrÃ©e</div></td></tr>';
            if (btnShowMore) btnShowMore.style.display = 'none';
            return;
        }
        
        const limit = this.showMoreState.depenses ? depenses.length : 15;
        const toShow = depenses.slice(0, limit);
        
        tbody.innerHTML = toShow.map(d => `
            <tr>
                <td>${new Date(d.date).toLocaleDateString('fr-FR')}</td>
                <td><span class="category-tag">${d.categorie}</span></td>
                <td>${this.formatCurrency(d.montant)}</td>
                <td>
                    ${d.note || 'â€”'}
                    <button class="btn btn-small btn-secondary" onclick="app.modifierNote('depense', ${d.id})" style="margin-left:0.5rem" title="Modifier la note">âœï¸</button>
                </td>
                <td><button class="btn btn-small btn-secondary" onclick="app.supprimerDepense(${d.id})">âœ•</button></td>
            </tr>
        `).join('');
        
        if (btnShowMore) {
            if (depenses.length > 15) {
                btnShowMore.style.display = 'block';
                btnShowMore.textContent = this.showMoreState.depenses ? 'Afficher moins' : 'Afficher plus (' + (depenses.length - 15) + ' autres)';
            } else {
                btnShowMore.style.display = 'none';
            }
        }
    },
    
    supprimerDepense(id) {
        this.showModal(
            'Supprimer la dÃ©pense',
            'Voulez-vous vraiment supprimer cette dÃ©pense ?',
            () => {
                this.data.depenses = this.data.depenses.filter(d => d.id !== id);
                this.save();
                this.afficherDepenses();
                this.refreshStatsDepenses();
                this.analyseDepenses();
                this.refreshCharts();
                this.notify('DÃ©pense supprimÃ©e', 'success');
            }
        );
    },
    
    refreshStatsDepenses() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        
        const depensesMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });
        
        const totalDepenses = depensesMois.reduce((sum, d) => sum + d.montant, 0);
        const budgetTotal = Object.values(this.data.budgets).reduce((sum, v) => sum + v, 0);
        const restant = budgetTotal - totalDepenses;
        const percent = budgetTotal > 0 ? (totalDepenses / budgetTotal) * 100 : 0;
        
        document.getElementById('s-depenses-mois').textContent = this.formatCurrency(totalDepenses);
        document.getElementById('s-budget-restant').textContent = this.formatCurrency(restant);
        document.getElementById('s-budget-total').textContent = this.formatCurrency(budgetTotal);
        
        const progressBar = document.getElementById('s-progress-global');
        progressBar.style.width = Math.min(percent, 100) + '%';
        progressBar.className = 'progress-fill';
        if (percent >= 100) progressBar.classList.add('danger');
        else if (percent >= 80) progressBar.classList.add('warning');
        
        const depensesParCat = {};
        Object.keys(this.data.budgets).forEach(cat => {
            depensesParCat[cat] = depensesMois.filter(d => d.categorie === cat)
                .reduce((sum, d) => sum + d.montant, 0);
        });
        
        const container = document.getElementById('stats-categories');
        container.innerHTML = Object.keys(this.data.budgets).map(cat => {
            const depense = depensesParCat[cat] || 0;
            const budget = this.data.budgets[cat];
            const percent = budget > 0 ? (depense / budget) * 100 : 0;
            const classe = percent >= 100 ? 'danger' : '';
            const progressClasse = percent >= 100 ? 'danger' : percent >= 80 ? 'warning' : '';
            
            return `
                <div class="stat-card ${classe}">
                    <div class="stat-label">${cat}</div>
                    <div class="stat-value">${this.formatCurrency(depense)}</div>
                    <div style="font-size:0.875rem;color:var(--text-tertiary);margin-top:0.25rem">
                        Budget: ${this.formatCurrency(budget)}
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill ${progressClasse}" style="width:${Math.min(percent,100)}%"></div>
                    </div>
                    <div style="font-size:0.75rem;color:var(--text-tertiary);margin-top:0.25rem">
                        ${percent.toFixed(0)}% utilisÃ©
                    </div>
                </div>
            `;
        }).join('');
    },
    
    toggleAnalyseFilters() {
        const periode = document.getElementById('analyse-periode').value;
        document.getElementById('filter-mois-choisi').style.display = periode === 'mois-choisi' ? 'block' : 'none';
        document.getElementById('filter-annee-choisie').style.display = periode === 'annee-choisie' ? 'block' : 'none';
        document.getElementById('filter-plage-debut').style.display = periode === 'plage' ? 'block' : 'none';
        document.getElementById('filter-plage-fin').style.display = periode === 'plage' ? 'block' : 'none';
        this.analyseDepenses();
    },
    
    analyseDepenses() {
        const periode = document.getElementById('analyse-periode').value;
        const categorie = document.getElementById('analyse-categorie').value;
        
        let depensesFiltrees = [...this.data.depenses];
        const now = new Date();
        
        if (periode === 'mois') {
            depensesFiltrees = depensesFiltrees.filter(d => {
                const date = new Date(d.date);
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            });
        } else if (periode === 'mois-choisi') {
            const mois = document.getElementById('analyse-mois').value;
            if (mois) {
                const [year, month] = mois.split('-');
                depensesFiltrees = depensesFiltrees.filter(d => {
                    const date = new Date(d.date);
                    return date.getMonth() === parseInt(month) - 1 && date.getFullYear() === parseInt(year);
                });
            }
        } else if (periode === 'annee') {
            depensesFiltrees = depensesFiltrees.filter(d => {
                const date = new Date(d.date);
                return date.getFullYear() === now.getFullYear();
            });
        } else if (periode === 'annee-choisie') {
            const annee = parseInt(document.getElementById('analyse-annee').value);
            if (annee) {
                depensesFiltrees = depensesFiltrees.filter(d => {
                    const date = new Date(d.date);
                    return date.getFullYear() === annee;
                });
            }
        } else if (periode === 'plage') {
            const debut = document.getElementById('analyse-debut').value;
            const fin = document.getElementById('analyse-fin').value;
            if (debut && fin) {
                depensesFiltrees = depensesFiltrees.filter(d => d.date >= debut && d.date <= fin);
            }
        }
        
        if (categorie !== 'toutes') {
            depensesFiltrees = depensesFiltrees.filter(d => d.categorie === categorie);
        }
        
        const total = depensesFiltrees.reduce((sum, d) => sum + d.montant, 0);
        const parCat = {};
        depensesFiltrees.forEach(d => {
            parCat[d.categorie] = (parCat[d.categorie] || 0) + d.montant;
        });
        
        let html = `<div style="margin-top:1.5rem">`;
        html += `<h3 style="margin-bottom:1rem">RÃ©sultats de l'analyse</h3>`;
        
        if (periode === 'annee' || periode === 'annee-choisie') {
            html += `<div class="grid grid-2">`;
            html += `<div class="stat-card"><div class="stat-label">Total dÃ©pensÃ©</div><div class="stat-value">${this.formatCurrency(total)}</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Nombre de dÃ©penses</div><div class="stat-value">${depensesFiltrees.length}</div></div>`;
            html += `</div>`;
            
            html += `<h4 style="margin-top:1.5rem;margin-bottom:1rem">Moyenne mensuelle par catÃ©gorie</h4>`;
            html += `<div class="table-container"><table class="table"><thead><tr><th>CatÃ©gorie</th><th>Total annÃ©e</th><th>Moyenne/mois</th></tr></thead><tbody>`;
            Object.keys(parCat).forEach(cat => {
                html += `<tr><td>${cat}</td><td>${this.formatCurrency(parCat[cat])}</td><td>${this.formatCurrency(parCat[cat] / 12)}</td></tr>`;
            });
            html += `</tbody></table></div>`;
        } else {
            html += `<div class="grid grid-2">`;
            html += `<div class="stat-card"><div class="stat-label">Total dÃ©pensÃ©</div><div class="stat-value">${this.formatCurrency(total)}</div></div>`;
            html += `<div class="stat-card"><div class="stat-label">Nombre de dÃ©penses</div><div class="stat-value">${depensesFiltrees.length}</div></div>`;
            html += `</div>`;
            
            if (categorie !== 'toutes') {
                // â”€â”€ LISTE DÃ‰TAILLÃ‰E DES TRANSACTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                const sorted = [...depensesFiltrees].sort((a, b) => new Date(b.date) - new Date(a.date));
                html += `
                <div style="margin-top:1.5rem">
                    <h4 style="margin-bottom:1rem;display:flex;align-items:center;gap:0.5rem">
                        ğŸ“‹ Transactions <span class="category-tag">${categorie}</span>
                        <span style="font-size:0.85rem;font-weight:400;color:var(--text-tertiary);margin-left:auto">${sorted.length} transaction${sorted.length > 1 ? 's' : ''}</span>
                    </h4>
                    <div class="table-container">
                        <table class="table">
                            <thead><tr><th>Date</th><th>Montant</th><th>Note</th><th></th></tr></thead>
                            <tbody>
                                ${sorted.map(d => `
                                <tr>
                                    <td>${new Date(d.date).toLocaleDateString('fr-FR', {day:'2-digit', month:'short', year:'numeric'})}</td>
                                    <td style="font-weight:700;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
                                        ${this.formatCurrency(d.montant)}
                                    </td>
                                    <td style="color:var(--text-secondary)">${d.note || 'â€”'}</td>
                                    <td><button class="btn btn-small btn-secondary" onclick="app.supprimerDepense(${d.id})">âœ•</button></td>
                                </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top:1rem;padding:1rem;background:var(--bg-secondary);border-radius:12px;display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border-color)">
                        <span style="font-weight:600;color:var(--text-secondary)">TOTAL ${categorie.toUpperCase()}</span>
                        <span style="font-size:1.5rem;font-weight:700;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent">
                            ${this.formatCurrency(total)}
                        </span>
                    </div>
                </div>`;
            } else {
                html += `<h4 style="margin-top:1.5rem;margin-bottom:0.75rem;font-size:0.9rem;color:var(--text-secondary)">DÃ©tail par catÃ©gorie <span style="font-size:0.7rem;font-family:'DM Mono',monospace;opacity:0.6">â€” clique sur une ligne pour voir les transactions</span></h4>`;
                const catsSorted = Object.keys(parCat).sort((a,b) => parCat[b] - parCat[a]);
                html += `<div id="cat-accordion" style="display:flex;flex-direction:column;gap:0.5rem">`;
                catsSorted.forEach(cat => {
                    const montant = parCat[cat];
                    const pct = total > 0 ? (montant / total * 100).toFixed(1) : 0;
                    const txCat = depensesFiltrees.filter(d => d.categorie === cat).sort((a,b) => new Date(b.date) - new Date(a.date));
                    const txRows = txCat.map(d => `
                        <div style="display:flex;align-items:center;gap:1rem;padding:0.5rem 0.75rem;border-radius:8px;background:var(--bg-secondary);margin-bottom:4px">
                            <span style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--text-tertiary);min-width:80px">${new Date(d.date).toLocaleDateString('fr-FR',{day:'2-digit',month:'short'})}</span>
                            <span style="font-size:0.82rem;flex:1;color:var(--text-secondary)">${d.note || 'â€”'}</span>
                            <span style="font-family:'DM Mono',monospace;font-size:0.82rem;font-weight:600;color:var(--text-primary)">${this.formatCurrency(d.montant)}</span>
                            <button onclick="app.supprimerDepense(${d.id})" style="background:none;border:none;cursor:pointer;color:var(--text-tertiary);font-size:0.75rem;padding:0 0.25rem" title="Supprimer">âœ•</button>
                        </div>`).join('');
                    html += `
                    <div class="cat-row" style="border-radius:14px;background:var(--bg-card);border:1px solid var(--border-color);overflow:hidden;box-shadow:4px 4px 8px var(--shadow-light),-4px -4px 8px var(--shadow-dark)">
                        <div onclick="app._toggleCatDetail(this)" style="display:flex;align-items:center;gap:1rem;padding:0.85rem 1rem;cursor:pointer;user-select:none">
                            <span class="category-tag" style="min-width:fit-content">${cat}</span>
                            <div style="flex:1;height:6px;background:var(--bg-secondary);border-radius:100px;overflow:hidden;box-shadow:inset 2px 2px 4px var(--shadow-light)">
                                <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--accent-gradient-start),var(--accent-gradient-end));border-radius:100px;transition:width 0.4s ease"></div>
                            </div>
                            <span style="font-family:'DM Mono',monospace;font-size:0.82rem;font-weight:600;color:var(--text-primary);min-width:70px;text-align:right">${this.formatCurrency(montant)}</span>
                            <span style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-tertiary);min-width:36px;text-align:right">${pct}%</span>
                            <span class="cat-chevron" style="font-size:0.75rem;color:var(--text-tertiary);transition:transform 0.25s;margin-left:0.25rem">â–¶</span>
                        </div>
                        <div class="cat-detail" style="display:none;padding:0 1rem 0.75rem">
                            ${txRows}
                            <div style="display:flex;justify-content:space-between;align-items:center;padding:0.6rem 0.75rem;margin-top:4px;border-top:1px solid var(--border-color)">
                                <span style="font-family:'DM Mono',monospace;font-size:0.68rem;text-transform:uppercase;letter-spacing:0.06em;color:var(--text-tertiary)">${txCat.length} transaction${txCat.length > 1 ? 's' : ''}</span>
                                <span style="font-family:'Outfit',sans-serif;font-size:1rem;font-weight:700;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent">${this.formatCurrency(montant)}</span>
                            </div>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
        }
        
        html += `</div>`;
        document.getElementById('analyse-results').innerHTML = html;
    },
    
    _toggleCatDetail(headerEl) {
        const row = headerEl.closest('.cat-row');
        const detail = row.querySelector('.cat-detail');
        const chevron = row.querySelector('.cat-chevron');
        const isOpen = detail.style.display !== 'none';
        // Ferme tous les autres
        document.querySelectorAll('.cat-detail').forEach(d => { d.style.display = 'none'; });
        document.querySelectorAll('.cat-chevron').forEach(c => { c.style.transform = ''; });
        if (!isOpen) {
            detail.style.display = 'block';
            chevron.style.transform = 'rotate(90deg)';
        }
    },

    switchPEAMode(mode) {
        document.querySelectorAll('.card-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        document.getElementById('pea-manuel').style.display = mode === 'manuel' ? 'block' : 'none';
        document.getElementById('pea-import').style.display = mode === 'import' ? 'block' : 'none';
    },
    
    ajouterPEA() {
        const date = document.getElementById('pea-date').value;
        const valeur = parseFloat(document.getElementById('pea-val').value);
        const investi = parseFloat(document.getElementById('pea-inv').value);
        const note = document.getElementById('pea-note').value;
        
        if (!valeur || !investi) {
            this.notify('Remplir tous les champs', 'error');
            return;
        }
        
        const gain = valeur - investi;
        const perf = ((gain / investi) * 100).toFixed(2);
        
        this.data.suiviPEA.push({
            id: Date.now(),
            date: date,
            valeur: valeur,
            investi: investi,
            gainPerte: gain,
            performance: perf,
            note: note
        });
        
        this.save();
        this.afficherPEA();
        this.refreshStatsPEA();
        this.refreshCharts();
        
        document.getElementById('pea-val').value = '';
        document.getElementById('pea-inv').value = '';
        document.getElementById('pea-note').value = '';
        this.notify('PEA enregistrÃ©', 'success');
    },
    
    afficherPEA() {
        const tbody = document.getElementById('table-pea');
        const btnShowMore = document.getElementById('show-more-pea');
        const historique = [...this.data.suiviPEA].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        if (historique.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty-state"><div class="empty-state-icon">ğŸ“ˆ</div><div>Aucune entrÃ©e PEA</div></td></tr>';
            if (btnShowMore) btnShowMore.style.display = 'none';
            return;
        }
        
        const limit = this.showMoreState.pea ? historique.length : 15;
        const toShow = historique.slice(0, limit);
        
        tbody.innerHTML = toShow.map(s => `
            <tr>
                <td>${new Date(s.date).toLocaleDateString('fr-FR')}</td>
                <td>${this.formatCurrency(s.valeur)}</td>
                <td>${this.formatCurrency(s.investi)}</td>
                <td class="${s.gainPerte >= 0 ? 'stat-change positive' : 'stat-change negative'}">
                    ${s.gainPerte >= 0 ? '+' : ''}${this.formatCurrency(s.gainPerte)} (${s.performance}%)
                </td>
                <td>
                    ${s.note || 'â€”'}
                    <button class="btn btn-small btn-secondary" onclick="app.modifierNote('pea', ${s.id})" style="margin-left:0.5rem" title="Modifier la note">âœï¸</button>
                </td>
                <td><button class="btn btn-small btn-secondary" onclick="app.supprimerPEA(${s.id})">âœ•</button></td>
            </tr>
        `).join('');
        
        if (btnShowMore) {
            if (historique.length > 15) {
                btnShowMore.style.display = 'block';
                btnShowMore.textContent = this.showMoreState.pea ? 'Afficher moins' : 'Afficher plus (' + (historique.length - 15) + ' autres)';
            } else {
                btnShowMore.style.display = 'none';
            }
        }
    },
    
    supprimerPEA(id) {
        this.showModal(
            'Supprimer l\'entrÃ©e PEA',
            'Voulez-vous vraiment supprimer cette entrÃ©e PEA ?',
            () => {
                this.data.suiviPEA = this.data.suiviPEA.filter(s => s.id !== id);
                this.save();
                this.afficherPEA();
                this.refreshStatsPEA();
                this.refreshCharts();
                this.notify('EntrÃ©e supprimÃ©e', 'success');
            }
        );
    },
    
    refreshStatsPEA() {
        if (this.data.suiviPEA.length === 0) {
            document.getElementById('pea-valeur').textContent = this.formatCurrency(0);
            document.getElementById('pea-investi').textContent = this.formatCurrency(0);
            document.getElementById('pea-gain').textContent = this.formatCurrency(0);
            document.getElementById('pea-perf').textContent = '0%';
            return;
        }
        
        const sorted = [...this.data.suiviPEA].sort((a, b) => new Date(b.date) - new Date(a.date));
        const dernier = sorted[0];
        
        document.getElementById('pea-valeur').textContent = this.formatCurrency(dernier.valeur);
        document.getElementById('pea-investi').textContent = this.formatCurrency(dernier.investi);
        document.getElementById('pea-gain').textContent = this.formatCurrency(dernier.gainPerte);
        document.getElementById('pea-perf').textContent = dernier.performance + '%';
    },
    
    importPEA(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const text = e.target.result;
                const lines = text.split('\n').filter(l => l.trim());
                const startIndex = lines[0].toLowerCase().includes('date') ? 1 : 0;
                
                let count = 0;
                for (let i = startIndex; i < lines.length; i++) {
                    const [date, valeur, investi] = lines[i].split(/[,;]/);
                    if (date && valeur && investi) {
                        const val = parseFloat(valeur.trim());
                        const inv = parseFloat(investi.trim());
                        const gain = val - inv;
                        
                        this.data.suiviPEA.push({
                            id: Date.now() + i,
                            date: date.trim(),
                            valeur: val,
                            investi: inv,
                            gainPerte: gain,
                            performance: ((gain / inv) * 100).toFixed(2),
                            note: 'Import CSV'
                        });
                        count++;
                    }
                }
                
                this.save();
                this.afficherPEA();
                this.refreshStatsPEA();
                this.refreshCharts();
                this.notify(count + ' entrÃ©e(s) importÃ©e(s)', 'success');
            } catch (err) {
                this.notify('Erreur import CSV', 'error');
            }
        };
        reader.readAsText(file);
    },
    
    ajouterPatrimoine() {
        const mois = document.getElementById('pat-mois').value;
        const values = {};
        let total = 0;
        
        this.data.comptes.forEach(compte => {
            const id = 'pat-' + compte.replace(/\s/g,'');
            const val = parseFloat(document.getElementById(id).value) || 0;
            values[compte] = val;
            total += val;
        });
        
        this.data.patrimoine = this.data.patrimoine.filter(p => p.mois !== mois);
        this.data.patrimoine.push({
            id: Date.now(),
            mois: mois,
            ...values,
            total: total
        });
        
        this.save();
        this.afficherPatrimoine();
        this.refreshStatsPatrimoine();
        this.refreshCharts();
        this.notify('Patrimoine enregistrÃ©', 'success');
    },
    
    afficherPatrimoine() {
        const tbody = document.getElementById('table-patrimoine');
        const btnShowMore = document.getElementById('show-more-patrimoine');
        const historique = this.data.patrimoine.sort((a, b) => b.id - a.id);
        
        if (historique.length === 0) {
            tbody.innerHTML = '<tr><td colspan="' + (this.data.comptes.length + 2) + '" class="empty-state"><div class="empty-state-icon">ğŸ’°</div><div>Aucune entrÃ©e patrimoine</div></td></tr>';
            if (btnShowMore) btnShowMore.style.display = 'none';
            return;
        }
        
        const limit = this.showMoreState.patrimoine ? historique.length : 15;
        const toShow = historique.slice(0, limit);
        
        tbody.innerHTML = toShow.map(p => {
            let html = '<tr>';
            html += `<td>${new Date(p.mois).toLocaleDateString('fr-FR', {year: 'numeric', month: 'long'})}</td>`;
            this.data.comptes.forEach(compte => {
                html += `<td>${this.formatCurrency(p[compte] || 0)}</td>`;
            });
            html += `<td><strong>${this.formatCurrency(p.total)}</strong></td>`;
            html += `<td><button class="btn btn-small btn-secondary" onclick="app.supprimerPatrimoine(${p.id})">âœ•</button></td>`;
            html += '</tr>';
            return html;
        }).join('');
        
        if (btnShowMore) {
            if (historique.length > 15) {
                btnShowMore.style.display = 'block';
                btnShowMore.textContent = this.showMoreState.patrimoine ? 'Afficher moins' : 'Afficher plus (' + (historique.length - 15) + ' autres)';
            } else {
                btnShowMore.style.display = 'none';
            }
        }
    },
    
    supprimerPatrimoine(id) {
        this.showModal(
            'Supprimer l\'entrÃ©e',
            'Voulez-vous vraiment supprimer cette entrÃ©e de patrimoine ?',
            () => {
                this.data.patrimoine = this.data.patrimoine.filter(p => p.id !== id);
                this.save();
                this.afficherPatrimoine();
                this.refreshStatsPatrimoine();
                this.refreshCharts();
                this.notify('EntrÃ©e supprimÃ©e', 'success');
            }
        );
    },
    
    refreshStatsPatrimoine() {
        if (this.data.patrimoine.length === 0) {
            document.getElementById('pat-total').textContent = this.formatCurrency(0);
            document.getElementById('pat-securise').textContent = this.formatCurrency(0);
            document.getElementById('pat-invest').textContent = this.formatCurrency(0);
            return;
        }
        
        const sorted = [...this.data.patrimoine].sort((a, b) => b.mois.localeCompare(a.mois));
        const dernier = sorted[0];
        
        let securise = 0;
        let invest = 0;
        this.data.comptes.forEach(compte => {
            const val = dernier[compte] || 0;
            if (compte.toLowerCase().includes('livret') || compte.toLowerCase().includes('lep')) {
                securise += val;
            } else {
                invest += val;
            }
        });
        
        document.getElementById('pat-total').textContent = this.formatCurrency(dernier.total);
        document.getElementById('pat-securise').textContent = this.formatCurrency(securise);
        document.getElementById('pat-invest').textContent = this.formatCurrency(invest);
    },
    
    calculerPrevisionsPEA() {
        const actuel = parseFloat(document.getElementById('prev-pea-actuel').value) || 0;
        const mensuel = parseFloat(document.getElementById('prev-pea-mensuel').value) || 0;
        const taux = parseFloat(document.getElementById('prev-pea-taux').value) / 100 || 0;
        const annees = parseInt(document.getElementById('prev-pea-annees').value) || 10;
        
        const tauxMensuel = taux / 12;
        const mois = annees * 12;
        
        let valeur = actuel;
        const historiquePrev = [{periode: 0, valeur: actuel, investi: 0}];
        let totalVerse = 0;
        
        for (let i = 1; i <= mois; i++) {
            totalVerse += mensuel;
            valeur = (valeur + mensuel) * (1 + tauxMensuel);
            historiquePrev.push({
                periode: i,
                valeur: valeur,
                investi: actuel + totalVerse
            });
        }
        
        const gains = valeur - (actuel + totalVerse);
        
        document.getElementById('prev-pea-final').textContent = this.formatCurrency(valeur);
        document.getElementById('prev-pea-verse').textContent = this.formatCurrency(actuel + totalVerse);
        document.getElementById('prev-pea-gains').textContent = this.formatCurrency(gains);
        document.getElementById('prev-pea-results').style.display = 'block';
        
        this.calculerProjectionRealiste(historiquePrev, annees);
        this.chartPrevCompare(historiquePrev, annees);
    },
    
    calculerPrevisionsPatrimoine() {
        const actuel = parseFloat(document.getElementById('prev-pat-actuel').value) || 0;
        const mensuel = parseFloat(document.getElementById('prev-pat-mensuel').value) || 0;
        const taux = parseFloat(document.getElementById('prev-pat-taux').value) / 100 || 0;
        const annees = parseInt(document.getElementById('prev-pat-annees').value) || 10;
        
        const tauxMensuel = taux / 12;
        const mois = annees * 12;
        
        let valeur = actuel;
        const historique = [{mois: 0, valeur: actuel}];
        let totalEpargne = 0;
        
        for (let i = 1; i <= mois; i++) {
            totalEpargne += mensuel;
            valeur = (valeur + mensuel) * (1 + tauxMensuel);
            historique.push({mois: i, valeur: valeur});
        }
        
        const interets = valeur - (actuel + totalEpargne);
        
        document.getElementById('prev-pat-final').textContent = this.formatCurrency(valeur);
        document.getElementById('prev-pat-epargne').textContent = this.formatCurrency(actuel + totalEpargne);
        document.getElementById('prev-pat-interets').textContent = this.formatCurrency(interets);
        document.getElementById('prev-pat-results').style.display = 'block';
        
        this.chartPrevPat(historique, annees);
        this.chartCompare();
    },
    
    genererLignes() {
        const n = parseInt(document.getElementById('calc-lignes').value) || 3;
        const tbody = document.getElementById('calc-body');
        
        tbody.innerHTML = Array.from({length: n}, (_, i) => `
            <tr>
                <td><input type="text" class="table-input" id="cn-${i}" placeholder="Action"></td>
                <td><input type="number" class="table-input" id="ca-${i}" value="${i === 0 ? 40 : 30}" min="0" max="100" onchange="app.calculer()"></td>
                <td id="cb-${i}">0 â‚¬</td>
                <td><input type="number" class="table-input" id="cc-${i}" placeholder="0.00" step="0.01" onchange="app.calculer()"></td>
                <td id="cq-${i}">0</td>
                <td id="ci-${i}">0 â‚¬</td>
                <td id="cr-${i}">0 â‚¬</td>
            </tr>
        `).join('');
    },
    
    calculer() {
        const budget = parseFloat(document.getElementById('calc-budget').value) || 0;
        const n = parseInt(document.getElementById('calc-lignes').value) || 3;
        
        let totalInvesti = 0;
        
        for (let i = 0; i < n; i++) {
            const alloc = parseFloat(document.getElementById('ca-' + i).value) || 0;
            const cours = parseFloat(document.getElementById('cc-' + i).value) || 0;
            
            const budgetLigne = (budget * alloc) / 100;
            const quantite = cours > 0 ? Math.floor(budgetLigne / cours) : 0;
            const investi = quantite * cours;
            const reste = budgetLigne - investi;
            
            document.getElementById('cb-' + i).textContent = this.formatCurrency(budgetLigne);
            document.getElementById('cq-' + i).textContent = quantite;
            document.getElementById('ci-' + i).textContent = this.formatCurrency(investi);
            document.getElementById('cr-' + i).textContent = this.formatCurrency(reste);
            
            totalInvesti += investi;
        }
        
        document.getElementById('calc-total').textContent = this.formatCurrency(budget);
        document.getElementById('calc-investi').textContent = this.formatCurrency(totalInvesti);
        document.getElementById('calc-reste').textContent = this.formatCurrency(budget - totalInvesti);
    },
    
    allocation(type) {
        const allocations = {
            conservateur: [60, 30, 10],
            equilibre: [50, 30, 20],
            dynamique: [40, 40, 20],
            agressif: [30, 30, 40]
        };
        
        const alloc = allocations[type];
        document.getElementById('calc-lignes').value = alloc.length;
        this.genererLignes();
        
        alloc.forEach((val, i) => {
            document.getElementById('ca-' + i).value = val;
        });
        
        this.calculer();
        this.notify('Allocation ' + type + ' appliquÃ©e', 'success');
    },
    
    refreshDashboard() {
        const patrimoineTotal = this.data.patrimoine.length > 0 ? 
            [...this.data.patrimoine].sort((a, b) => b.mois.localeCompare(a.mois))[0].total : 0;
        
        const now = new Date();
        const depensesMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }).reduce((sum, d) => sum + d.montant, 0);
        
        const peaActuel = this.data.suiviPEA.length > 0 ? 
            [...this.data.suiviPEA].sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;
        
        document.getElementById('d-patrimoine').textContent = this.formatCurrency(patrimoineTotal);
        document.getElementById('d-depenses').textContent = this.formatCurrency(depensesMois);
        document.getElementById('d-pea').textContent = peaActuel ? peaActuel.performance + '%' : '0%';
        
        if (peaActuel) {
            const elem = document.getElementById('d-pea-gain');
            elem.textContent = (peaActuel.gainPerte >= 0 ? '+' : '') + this.formatCurrency(peaActuel.gainPerte);
            elem.className = 'stat-change ' + (peaActuel.gainPerte >= 0 ? 'positive' : 'negative');
        }
        
        if (this.data.patrimoine.length > 1) {
            const sorted = [...this.data.patrimoine].sort((a, b) => b.mois.localeCompare(a.mois));
            const precedent = sorted[1];
            const diff = patrimoineTotal - precedent.total;
            const pct = ((diff / precedent.total) * 100).toFixed(2);
            const elem = document.getElementById('d-patrimoine-ch');
            elem.textContent = (diff >= 0 ? '+' : '') + this.formatCurrency(diff) + ' (' + pct + '%)';
            elem.className = 'stat-change ' + (diff >= 0 ? 'positive' : 'negative');
        }
        
        this.refreshCharts();
        this.refreshVueRapide();
        this.refreshAlertes();
    },
    

    isDarkMode() {
        return document.body.getAttribute('data-theme') === 'dark';
    },

    getChartColors() {
        if (this.isDarkMode()) {
            return {
                // Ligne C - Aurora (Vert + Cyan)
                primary:   '#4ade80',  // Vert Ã©meraude
                secondary: '#67e8f9',  // Cyan glacÃ©
                tertiary:  '#a855f7',  // Violet Aurora
                quaternary:'#38bdf8',  // Bleu ciel
                success:   '#4ade80',
                info:      '#67e8f9',
                gridColor: 'rgba(56,189,248,0.07)',
                tickColor: '#7aaac8',
                legendColor:'#e0f2fe',
                bg1: (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                    g.addColorStop(0,'rgba(74,222,128,0.35)');
                    g.addColorStop(1,'rgba(74,222,128,0)');
                    return g;
                },
                bg2: 'rgba(103,232,249,0.15)',
                bg3: (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                    g.addColorStop(0,'rgba(168,85,247,0.3)');
                    g.addColorStop(1,'rgba(168,85,247,0)');
                    return g;
                }
            };
        } else {
            return {
                primary:   '#3f51b5',
                secondary: '#ff9800',
                tertiary:  '#5c6bc0',
                quaternary:'#00c853',
                success:   '#00c853',
                info:      '#0891b2',
                gridColor: 'rgba(0,0,0,0.05)',
                tickColor: '#7891ab',
                legendColor:'#1e3a5f',
                bg1: (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                    g.addColorStop(0,'rgba(63,81,181,0.3)');
                    g.addColorStop(1,'rgba(63,81,181,0)');
                    return g;
                },
                bg2: 'rgba(255,152,0,0.1)',
                bg3: (ctx) => {
                    const g = ctx.chart.ctx.createLinearGradient(0,0,0,300);
                    g.addColorStop(0,'rgba(92,107,192,0.3)');
                    g.addColorStop(1,'rgba(92,107,192,0)');
                    return g;
                }
            };
        }
    },

    getChartScaleOptions() {
        const c = this.getChartColors();
        return {
            x: { ticks: { color: c.tickColor }, grid: { color: c.gridColor } },
            y: { ticks: { color: c.tickColor }, grid: { color: c.gridColor } }
        };
    },

    getChartLegendOptions() {
        const c = this.getChartColors();
        return { position: 'top', labels: { color: c.legendColor, font: { family: 'Inter' } } };
    },
    refreshCharts() {
        this.chartPatrimoine();
        this.chartRepartition();
        this.chartDepensesBudget();
        this.chartPEA();
        this.chartPatEv();
    },
    
    chartPatrimoine() {
        const data = [...this.data.patrimoine].sort((a, b) => a.mois.localeCompare(b.mois));
        const labels = data.map(p => new Date(p.mois).toLocaleDateString('fr-FR', {month: 'short', year: '2-digit'}));
        const values = data.map(p => p.total);
        const c = this.getChartColors();
        if (this.charts.pat) this.charts.pat.destroy();
        const ctx = document.getElementById('chart-patrimoine').getContext('2d');
        this.charts.pat = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'Patrimoine',
                    data: values,
                    borderColor: c.primary,
                    backgroundColor: c.bg1,
                    fill: true, tension: 0.4, borderWidth: 3
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: this.getChartScaleOptions()
            }
        });
    },
    
    chartRepartition() {
        if (this.data.patrimoine.length === 0) return;
        const dernier = [...this.data.patrimoine].sort((a, b) => b.mois.localeCompare(a.mois))[0];
        const labels = [];
        const values = [];
        this.data.comptes.forEach(compte => {
            const val = dernier[compte] || 0;
            if (val > 0) { labels.push(compte); values.push(val); }
        });
        // Couleurs nÃ©on par dÃ©faut si pas de couleur personnalisÃ©e
        const defaultDarkColors = ['#ff00ff','#00ffff','#ff6600','#00ff88','#ffff00','#ff3366'];
        const defaultLightColors = ['#3f51b5','#5c6bc0','#00c853','#ff9800','#f44336','#0891b2'];
        const bgColors = labels.map((label, i) => {
            if (this.data.categorieColors && this.data.categorieColors[label]) {
                return this.data.categorieColors[label];
            }
            return this.isDarkMode() ? defaultDarkColors[i % defaultDarkColors.length] : defaultLightColors[i % defaultLightColors.length];
        });
        if (this.charts.rep) this.charts.rep.destroy();
        const ctx = document.getElementById('chart-repartition').getContext('2d');
        this.charts.rep = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: bgColors, borderWidth: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, cutout: '70%',
                plugins: {
                    legend: this.getChartLegendOptions(),
                    tooltip: { callbacks: { label: function(ctx) {
                        const total = ctx.dataset.data.reduce((a,b) => a+b, 0);
                        return ctx.label + ': ' + ((ctx.parsed/total)*100).toFixed(1) + '%';
                    }}}
                }
            }
        });
    },

    ouvrirCouleursCategoriesDonut() {
        if (!this.data.categorieColors) this.data.categorieColors = {};
        const dark = this.isDarkMode();

        // Palettes selon le thÃ¨me
        const palette = dark ? [
            '#4ade80','#67e8f9','#a855f7','#fbbf24','#f472b6','#38bdf8',
            '#fb923c','#34d399','#818cf8','#f87171','#00ffff','#ff00ff',
            '#ffff00','#00ff88','#ff6600','#ff3366','#c084fc','#86efac'
        ] : [
            '#3f51b5','#00c853','#ff9800','#f44336','#0891b2','#5c6bc0',
            '#8bc34a','#ff5722','#9c27b0','#00bcd4','#e91e63','#4caf50',
            '#ffc107','#2196f3','#673ab7','#009688','#ff4081','#1565c0'
        ];

        let colorModal = document.getElementById('colorModal');
        if (!colorModal) {
            colorModal = document.createElement('div');
            colorModal.id = 'colorModal';
            colorModal.className = 'modal';
            colorModal.style.cssText = 'z-index:2000;border-radius:20px;max-width:520px;';
            document.body.appendChild(colorModal);
        }

        colorModal.innerHTML = `
            <div class="modal-header">
                <h2 class="modal-title" style="font-family:'Outfit',sans-serif">ğŸ¨ Couleurs des catÃ©gories</h2>
            </div>
            <div class="modal-body" style="max-height:70vh;overflow-y:auto">
                <p style="margin-bottom:1.25rem;color:var(--text-secondary);font-size:0.9rem">
                    Clique sur une pastille pour choisir parmi la palette ou utilise le sÃ©lecteur personnalisÃ©.
                </p>
                ${this.data.comptes.map((compte, i) => {
                    const currentColor = (this.data.categorieColors[compte]) || palette[i % palette.length];
                    return `
                    <div style="margin-bottom:1.25rem;padding:1rem;background:var(--bg-primary);border-radius:14px;border:1px solid var(--border-color)">
                        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:0.75rem">
                            <div id="preview-${i}" style="width:28px;height:28px;border-radius:50%;background:${currentColor};border:2px solid var(--border-color);flex-shrink:0"></div>
                            <span style="font-weight:700;font-size:1rem">${compte}</span>
                            <input type="color" id="color-compte-${i}" value="${currentColor}"
                                style="margin-left:auto;width:40px;height:32px;border:none;border-radius:8px;cursor:pointer;background:none;padding:2px"
                                oninput="document.getElementById('preview-${i}').style.background=this.value;document.getElementById('hex-${i}').textContent=this.value">
                        </div>
                        <div style="display:flex;flex-wrap:wrap;gap:0.4rem;margin-bottom:0.5rem">
                            ${palette.map(color => `
                                <div onclick="
                                    document.getElementById('color-compte-${i}').value='${color}';
                                    document.getElementById('preview-${i}').style.background='${color}';
                                    document.getElementById('hex-${i}').textContent='${color}'
                                " style="width:24px;height:24px;border-radius:6px;background:${color};cursor:pointer;border:2px solid transparent;transition:transform 0.15s;flex-shrink:0"
                                   onmouseover="this.style.transform='scale(1.2)';this.style.border='2px solid white'"
                                   onmouseout="this.style.transform='scale(1)';this.style.border='2px solid transparent'"
                                   title="${color}"></div>
                            `).join('')}
                        </div>
                        <div style="font-size:0.75rem;color:var(--text-tertiary)" id="hex-${i}">${currentColor}</div>
                    </div>`;
                }).join('')}
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="
                    document.getElementById('colorModal').classList.remove('active');
                    document.getElementById('overlay').classList.remove('active');
                ">Annuler</button>
                <button class="btn btn-primary" onclick="app.sauvegarderCouleursCategoriesDonut()">âœ… Appliquer</button>
            </div>
        `;

        colorModal.classList.add('active');
        document.getElementById('overlay').classList.add('active');

        document.getElementById('overlay').onclick = () => {
            colorModal.classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
            document.getElementById('overlay').onclick = null;
        };
    },

    sauvegarderCouleursCategoriesDonut() {
        if (!this.data.categorieColors) this.data.categorieColors = {};
        this.data.comptes.forEach((compte, i) => {
            const input = document.getElementById('color-compte-' + i);
            if (input) this.data.categorieColors[compte] = input.value;
        });
        this.save();
        // Fermer le modal couleurs
        const colorModal = document.getElementById('colorModal');
        if (colorModal) colorModal.classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        document.getElementById('overlay').onclick = null;
        this.chartRepartition();
        this.notify('Couleurs mises Ã  jour !', 'success');
    },
    
    chartDepensesBudget() {
        const now = new Date();
        const depenses = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        });
        const categories = Object.keys(this.data.budgets);
        const reel = categories.map(cat => depenses.filter(d => d.categorie === cat).reduce((sum, d) => sum + d.montant, 0));
        const budget = categories.map(cat => this.data.budgets[cat]);
        if (this.charts.depBudget) this.charts.depBudget.destroy();
        const ctx = document.getElementById('chart-depenses-budget').getContext('2d');
        this.charts.depBudget = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: categories,
                datasets: [
                    {
                        label: 'DÃ©pensÃ©',
                        data: reel,
                        backgroundColor: (context) => {
                            const chartCtx = context.chart.ctx;
                            const g = chartCtx.createLinearGradient(0, 0, 0, 400);
                            if (this.isDarkMode()) {
                                // Mix Sunset + Violet-Cyan : Or â†’ Violet â†’ Cyan
                                g.addColorStop(0, '#fbbf24');
                                g.addColorStop(0.5, '#a855f7');
                                g.addColorStop(1, '#38bdf8');
                            } else {
                                g.addColorStop(0, '#3f51b5');
                                g.addColorStop(1, '#7c4dff');
                            }
                            return g;
                        },
                        borderRadius: 20, borderSkipped: false
                    },
                    {
                        label: 'Budget',
                        data: budget,
                        backgroundColor: this.isDarkMode() ? 'rgba(56,189,248,0.12)' : '#d4e2ed',
                        borderRadius: 20, borderSkipped: false
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: this.getChartLegendOptions() },
                scales: this.getChartScaleOptions()
            }
        });
    },
    
    chartPEA() {
        const data = [...this.data.suiviPEA].sort((a, b) => new Date(a.date) - new Date(b.date));
        const labels = data.map(s => new Date(s.date).toLocaleDateString('fr-FR', {month: 'short', day: 'numeric'}));
        const valeurs = data.map(s => s.valeur);
        const investis = data.map(s => s.investi);
        const c = this.getChartColors();
        if (this.charts.pea) this.charts.pea.destroy();
        const ctx = document.getElementById('chart-pea').getContext('2d');
        this.charts.pea = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [
                    {
                        label: 'Valeur PEA',
                        data: valeurs,
                        borderColor: c.primary,
                        backgroundColor: c.bg1,
                        tension: 0.4, fill: true, borderWidth: 3
                    },
                    {
                        label: 'Investi',
                        data: investis,
                        borderColor: c.secondary,
                        backgroundColor: c.bg2,
                        tension: 0.4, fill: true, borderWidth: 2, borderDash: [5,5]
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: this.getChartLegendOptions() },
                scales: this.getChartScaleOptions()
            }
        });
    },
    
    chartPatEv() {
        const data = [...this.data.patrimoine].sort((a, b) => a.mois.localeCompare(b.mois));
        const labels = data.map(p => new Date(p.mois).toLocaleDateString('fr-FR', {month: 'short'}));
        const darkColors = ['#4ade80','#67e8f9','#a855f7','#fbbf24','#f472b6','#38bdf8'];
        const lightColors = ['#3f51b5', '#5c6bc0', '#00c853', '#ff9800', '#f44336', '#0891b2'];
        const colors = this.isDarkMode() ? darkColors : lightColors;
        const datasets = this.data.comptes.map((compte, i) => ({
            label: compte,
            data: data.map(p => p[compte] || 0),
            borderColor: colors[i % colors.length],
            backgroundColor: colors[i % colors.length] + '55',
            tension: 0.4,
            fill: true,
            borderWidth: 2
        }));
        if (this.charts.patEv) this.charts.patEv.destroy();
        const ctx = document.getElementById('chart-pat-evol').getContext('2d');
        this.charts.patEv = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: this.getChartLegendOptions() },
                scales: {
                    x: { ...this.getChartScaleOptions().x, stacked: true },
                    y: { ...this.getChartScaleOptions().y, stacked: true }
                }
            }
        });
    },
    
    chartPrevPEA(historique, annees) {
        const labels = [];
        const valeurs = [];
        const investis = [];
        
        for (let i = 0; i <= annees * 12; i += 6) {
            const h = historique[i];
            labels.push('Mois ' + i);
            valeurs.push(h.valeur);
            investis.push(h.investi);
        }
        
        if (this.charts.prevPea) this.charts.prevPea.destroy();
        
        const ctx = document.getElementById('chart-prev-pea').getContext('2d');
        this.charts.prevPea = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Valeur projetÃ©e',
                        data: valeurs,
                        borderColor: '#15803d',
                        backgroundColor: '#15803d20',
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Total investi',
                        data: investis,
                        borderColor: '#ca8a04',
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'top' } }
            }
        });
    },
    
    chartPrevPat(historique, annees) {
        const labels = [];
        const valeurs = [];
        
        for (let i = 0; i <= annees * 12; i += 6) {
            const h = historique[i];
            labels.push('Mois ' + i);
            valeurs.push(h.valeur);
        }
        
        if (this.charts.prevPat) this.charts.prevPat.destroy();
        
        const ctx = document.getElementById('chart-prev-pat').getContext('2d');
        this.charts.prevPat = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Patrimoine projetÃ©',
                    data: valeurs,
                    borderColor: '#0c4a6e',
                    backgroundColor: '#0c4a6e20',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    },
    
    chartCompare() {
        const patReel = [...this.data.patrimoine].sort((a, b) => a.mois.localeCompare(b.mois));
        
        if (this.charts.compare) this.charts.compare.destroy();
        
        const ctx = document.getElementById('chart-compare').getContext('2d');
        this.charts.compare = new Chart(ctx, {
            type: 'line',
            data: {
                labels: patReel.map(p => new Date(p.mois).toLocaleDateString('fr-FR', {month: 'short', year: '2-digit'})),
                datasets: [{
                    label: 'Patrimoine rÃ©el',
                    data: patReel.map(p => p.total),
                    borderColor: '#0c4a6e',
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Comparaison avec les donnÃ©es rÃ©elles'
                    }
                }
            }
        });
    },
    
    refresh() {
        this.afficherDepenses();
        this.refreshStatsDepenses();
        this.afficherPEA();
        this.refreshStatsPEA();
        this.afficherPatrimoine();
        this.refreshStatsPatrimoine();
        this.analyseDepenses();
        this.refreshDashboard();
    },
    
    saveSettings() {
        const salaire = parseFloat(document.getElementById('set-salaire').value) || 0;
        this.data.parametres.salaire = salaire;
        const gsUrl = (document.getElementById('set-gsheets-url')?.value || '').trim();
        this.data.parametres.googleSheetsUrl = gsUrl;
        this.save();
        // RafraÃ®chir tout ce qui dÃ©pend du salaire
        this.refreshVueRapide();
        this.refreshAlertes();
        this.refreshRegle503020();
        this.toggleSettings();
        this.notify('ParamÃ¨tres sauvegardÃ©s âœ“', 'success');
    },
    
    toggleShowMore(type) {
        this.showMoreState[type] = !this.showMoreState[type];
        if (type === 'depenses') this.afficherDepenses();
        if (type === 'pea') this.afficherPEA();
        if (type === 'patrimoine') this.afficherPatrimoine();
    },
    
    toggleBudgetsPanel() {
        const panel = document.getElementById('budgets-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    },
    
    toggleComptesPanel() {
        const panel = document.getElementById('comptes-panel');
        panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
    },
    
    modifierNote(type, id) {
        let item;
        if (type === 'depense') {
            item = this.data.depenses.find(d => d.id === id);
        } else if (type === 'pea') {
            item = this.data.suiviPEA.find(p => p.id === id);
        }
        
        if (!item) return;
        
        this.showInputModal(
            'Modifier la note',
            'Nouvelle note',
            null,
            (nouvelleNote) => {
                item.note = nouvelleNote;
                this.save();
                if (type === 'depense') this.afficherDepenses();
                if (type === 'pea') this.afficherPEA();
                this.notify('Note modifiÃ©e', 'success');
            }
        );
        
        setTimeout(() => {
            document.getElementById('inputField').value = item.note || '';
        }, 100);
    },
    
    vuePrevision: 'annee',
    
    chargerScenario() {
        const select = document.getElementById('select-scenario');
        const id = select.value;
        
        if (!id) {
            document.getElementById('prev-scenario-nom').value = '';
            document.getElementById('prev-pea-actuel').value = '';
            document.getElementById('prev-pea-mensuel').value = '';
            document.getElementById('prev-pea-taux').value = '';
            document.getElementById('prev-pea-annees').value = '';
            return;
        }
        
        const scenario = this.data.scenarios.find(s => s.id == id);
        if (!scenario) return;
        
        document.getElementById('prev-scenario-nom').value = scenario.nom;
        document.getElementById('prev-pea-actuel').value = scenario.actuel;
        document.getElementById('prev-pea-mensuel').value = scenario.mensuel;
        document.getElementById('prev-pea-taux').value = scenario.taux;
        document.getElementById('prev-pea-annees').value = scenario.annees;
    },
    
    sauvegarderScenario() {
        const nom = document.getElementById('prev-scenario-nom').value.trim();
        if (!nom) {
            this.notify('Nom du scÃ©nario requis', 'error');
            return;
        }
        
        const scenario = {
            id: Date.now(),
            nom: nom,
            actuel: parseFloat(document.getElementById('prev-pea-actuel').value) || 0,
            mensuel: parseFloat(document.getElementById('prev-pea-mensuel').value) || 0,
            taux: parseFloat(document.getElementById('prev-pea-taux').value) || 0,
            annees: parseInt(document.getElementById('prev-pea-annees').value) || 10
        };
        
        const select = document.getElementById('select-scenario');
        const existingId = select.value;
        
        if (existingId) {
            const index = this.data.scenarios.findIndex(s => s.id == existingId);
            if (index !== -1) {
                scenario.id = parseInt(existingId);
                this.data.scenarios[index] = scenario;
            }
        } else {
            this.data.scenarios.push(scenario);
        }
        
        this.save();
        this.updateScenariosSelect();
        this.notify('ScÃ©nario sauvegardÃ©', 'success');
    },
    
    supprimerScenario() {
        const select = document.getElementById('select-scenario');
        const id = select.value;
        
        if (!id) {
            this.notify('Aucun scÃ©nario sÃ©lectionnÃ©', 'error');
            return;
        }
        
        this.showModal(
            'Supprimer le scÃ©nario',
            'Voulez-vous vraiment supprimer ce scÃ©nario ?',
            () => {
                this.data.scenarios = this.data.scenarios.filter(s => s.id != id);
                this.save();
                this.updateScenariosSelect();
                this.chargerScenario();
                this.notify('ScÃ©nario supprimÃ©', 'success');
            }
        );
    },
    
    updateScenariosSelect() {
        const select = document.getElementById('select-scenario');
        if (!select) return;
        select.innerHTML = '<option value="">-- Nouveau scÃ©nario --</option>' +
            this.data.scenarios.map(s => `<option value="${s.id}">${s.nom}</option>`).join('');
    },
    
    switchVuePrevision(vue) {
        this.vuePrevision = vue;
        document.getElementById('btn-vue-annee').className = vue === 'annee' ? 'btn btn-small' : 'btn btn-small btn-secondary';
        document.getElementById('btn-vue-mois').className = vue === 'mois' ? 'btn btn-small' : 'btn btn-small btn-secondary';
        this.calculerPrevisionsPEA();
    },
    
    calculerProjectionRealiste(historiquePrev, annees) {
        if (this.data.suiviPEA.length < 2) {
            document.getElementById('perf-moyenne').textContent = 'N/A';
            document.getElementById('proj-realiste').textContent = 'N/A';
            document.getElementById('ecart-objectif').textContent = 'N/A';
            return;
        }
        
        const sorted = [...this.data.suiviPEA].sort((a, b) => new Date(a.date) - new Date(b.date));
        let totalPerf = 0;
        let count = 0;
        
        for (let i = 1; i < sorted.length; i++) {
            const perf = ((sorted[i].valeur - sorted[i-1].valeur) / sorted[i-1].valeur) * 100;
            totalPerf += perf;
            count++;
        }
        
        const perfMoyenne = totalPerf / count;
        document.getElementById('perf-moyenne').textContent = perfMoyenne.toFixed(2) + '%';
        
        const actuel = parseFloat(document.getElementById('prev-pea-actuel').value) || 0;
        const mensuel = parseFloat(document.getElementById('prev-pea-mensuel').value) || 0;
        const tauxReel = (perfMoyenne / 100) / 12;
        const mois = annees * 12;
        
        let valeurReel = actuel;
        const historiqueReel = [{periode: 0, valeur: actuel}];
        
        for (let i = 1; i <= mois; i++) {
            valeurReel = (valeurReel + mensuel) * (1 + tauxReel);
            historiqueReel.push({periode: i, valeur: valeurReel});
        }
        
        document.getElementById('proj-realiste').textContent = this.formatCurrency(valeurReel);
        
        const objectif = historiquePrev[historiquePrev.length - 1].valeur;
        const ecart = valeurReel - objectif;
        const ecartElem = document.getElementById('ecart-objectif');
        ecartElem.textContent = (ecart >= 0 ? '+' : '') + this.formatCurrency(ecart);
        ecartElem.className = 'stat-value ' + (ecart >= 0 ? 'stat-change positive' : 'stat-change negative');
        
        this.chartProjRealiste(historiqueReel, historiquePrev, annees);
    },
    
    chartPrevCompare(historiquePrev, annees) {
        const peaReel = [...this.data.suiviPEA].sort((a, b) => new Date(a.date) - new Date(b.date));
        
        let labels, dataPrev, dataReel;
        
        if (this.vuePrevision === 'annee') {
            labels = [];
            dataPrev = [];
            dataReel = [];
            
            for (let i = 0; i <= annees; i++) {
                labels.push('AnnÃ©e ' + i);
                const idx = i * 12;
                dataPrev.push(historiquePrev[idx] ? historiquePrev[idx].valeur : null);
                
                if (peaReel.length > 0 && i === 0) {
                    dataReel.push(peaReel[peaReel.length - 1].valeur);
                } else {
                    dataReel.push(null);
                }
            }
        } else {
            labels = [];
            dataPrev = [];
            dataReel = [];
            
            const totalMois = annees * 12;
            for (let i = 0; i <= totalMois; i++) {
                labels.push('Mois ' + i);
                dataPrev.push(historiquePrev[i] ? historiquePrev[i].valeur : null);
                
                if (peaReel.length > 0 && i === 0) {
                    dataReel.push(peaReel[peaReel.length - 1].valeur);
                } else {
                    dataReel.push(null);
                }
            }
        }
        
        if (this.charts.prevCompare) this.charts.prevCompare.destroy();
        
        const ctx = document.getElementById('chart-prev-compare').getContext('2d');
        this.charts.prevCompare = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Objectif (PrÃ©visionnel)',
                        data: dataPrev,
                        borderColor: '#3f51b5',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(63, 81, 181, 0.3)');
                            gradient.addColorStop(1, 'rgba(63, 81, 181, 0)');
                            return gradient;
                        },
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'PEA RÃ©el',
                        data: dataReel,
                        borderColor: '#00c853',
                        backgroundColor: 'rgba(0, 200, 83, 0.2)',
                        tension: 0.4,
                        pointRadius: 6,
                        pointBackgroundColor: '#00c853',
                        pointBorderColor: '#fff',
                        pointBorderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'ÃŠtes-vous sur la bonne voie ?'
                    }
                }
            }
        });
    },
    
    chartProjRealiste(historiqueReel, historiquePrev, annees) {
        let labels, dataReel, dataPrev;
        
        if (this.vuePrevision === 'annee') {
            labels = [];
            dataReel = [];
            dataPrev = [];
            
            for (let i = 0; i <= annees; i++) {
                labels.push('AnnÃ©e ' + i);
                const idx = i * 12;
                dataReel.push(historiqueReel[idx] ? historiqueReel[idx].valeur : null);
                dataPrev.push(historiquePrev[idx] ? historiquePrev[idx].valeur : null);
            }
        } else {
            labels = [];
            dataReel = [];
            dataPrev = [];
            
            const totalMois = annees * 12;
            for (let i = 0; i <= totalMois; i++) {
                labels.push('Mois ' + i);
                dataReel.push(historiqueReel[i] ? historiqueReel[i].valeur : null);
                dataPrev.push(historiquePrev[i] ? historiquePrev[i].valeur : null);
            }
        }
        
        if (this.charts.projRealiste) this.charts.projRealiste.destroy();
        
        const ctx = document.getElementById('chart-proj-realiste').getContext('2d');
        this.charts.projRealiste = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Projection avec vos performances',
                        data: dataReel,
                        borderColor: '#ff9800',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(255, 152, 0, 0.3)');
                            gradient.addColorStop(1, 'rgba(255, 152, 0, 0)');
                            return gradient;
                        },
                        tension: 0.4,
                        fill: true,
                        borderWidth: 3
                    },
                    {
                        label: 'Objectif',
                        data: dataPrev,
                        borderColor: '#3f51b5',
                        borderDash: [5, 5],
                        tension: 0.4,
                        borderWidth: 2
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'top' },
                    title: {
                        display: true,
                        text: 'Projection basÃ©e sur vos performances passÃ©es'
                    }
                }
            }
        });
    },
    
    chargerModele() {
        const select = document.getElementById('select-modele');
        const id = select.value;
        
        if (!id) {
            document.getElementById('calc-nom-modele').value = '';
            document.getElementById('calc-lignes').value = 3;
            this.genererLignes();
            return;
        }
        
        const modele = this.data.modeles.find(m => m.id == id);
        if (!modele) return;
        
        document.getElementById('calc-nom-modele').value = modele.nom;
        document.getElementById('calc-lignes').value = modele.lignes.length;
        
        this.genererLignes();
        
        setTimeout(() => {
            modele.lignes.forEach((ligne, i) => {
                document.getElementById('cn-' + i).value = ligne.nom;
                document.getElementById('ca-' + i).value = ligne.alloc;
                document.getElementById('cc-' + i).value = ligne.cours;
            });
            this.calculer();
        }, 100);
    },
    
    sauvegarderModele() {
        const nom = document.getElementById('calc-nom-modele').value.trim();
        if (!nom) {
            this.notify('Nom du modÃ¨le requis', 'error');
            return;
        }
        
        const n = parseInt(document.getElementById('calc-lignes').value) || 3;
        const lignes = [];
        
        for (let i = 0; i < n; i++) {
            lignes.push({
                nom: document.getElementById('cn-' + i).value || '',
                alloc: parseFloat(document.getElementById('ca-' + i).value) || 0,
                cours: parseFloat(document.getElementById('cc-' + i).value) || 0
            });
        }
        
        const modele = {
            id: Date.now(),
            nom: nom,
            lignes: lignes
        };
        
        const select = document.getElementById('select-modele');
        const existingId = select.value;
        
        if (existingId) {
            const index = this.data.modeles.findIndex(m => m.id == existingId);
            if (index !== -1) {
                modele.id = parseInt(existingId);
                this.data.modeles[index] = modele;
            }
        } else {
            this.data.modeles.push(modele);
        }
        
        this.save();
        this.updateModelesSelect();
        this.notify('ModÃ¨le sauvegardÃ©', 'success');
    },
    
    supprimerModele() {
        const select = document.getElementById('select-modele');
        const id = select.value;
        
        if (!id) {
            this.notify('Aucun modÃ¨le sÃ©lectionnÃ©', 'error');
            return;
        }
        
        this.showModal(
            'Supprimer le modÃ¨le',
            'Voulez-vous vraiment supprimer ce modÃ¨le ?',
            () => {
                this.data.modeles = this.data.modeles.filter(m => m.id != id);
                this.save();
                this.updateModelesSelect();
                this.chargerModele();
                this.notify('ModÃ¨le supprimÃ©', 'success');
            }
        );
    },
    
    updateModelesSelect() {
        const select = document.getElementById('select-modele');
        if (!select) return;
        select.innerHTML = '<option value="">-- Nouveau modÃ¨le --</option>' +
            this.data.modeles.map(m => `<option value="${m.id}">${m.nom}</option>`).join('');
    },
    
    confirmReset() {
        this.showModal(
            'RÃ©initialiser toutes les donnÃ©es',
            'ÃŠtes-vous sÃ»r de vouloir rÃ©initialiser TOUTES les donnÃ©es ? Cette action est irrÃ©versible.',
            () => {
                localStorage.clear();
                location.reload();
            }
        );
    },
    
    // ===================== SCORE FINANCIER =====================
    refreshScore() {
        const now = new Date();
        const depensesMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }).reduce((sum, d) => sum + d.montant, 0);
        const budgetTotal = Object.values(this.data.budgets).reduce((s, v) => s + v, 0);
        const salaire = this.data.parametres.salaire || 0;
        const revenu = salaire > 0 ? salaire : (budgetTotal > 0 ? budgetTotal * 1.25 : 2000);
        const revenuLabel = salaire > 0 ? 'salaire rÃ©el' : 'estimation';
        const peaActuel = this.data.suiviPEA.length > 0 ?
            [...this.data.suiviPEA].sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;

        let score = 0;
        const items = [];

        // Taux d'Ã©pargne (max 25pts)
        const tauxEpargne = revenu > 0 ? ((revenu - depensesMois) / revenu) * 100 : 0;
        const scoreEpargne = Math.min(25, Math.max(0, tauxEpargne * 1.25));
        score += scoreEpargne;
        items.push({ label: `Taux d'Ã©pargne (${revenuLabel})`, val: tauxEpargne.toFixed(0) + '%', cls: tauxEpargne >= 20 ? 'positive' : tauxEpargne >= 10 ? 'warning' : 'negative' });

        // Budget respectÃ© (max 25pts)
        const budgetPct = budgetTotal > 0 ? (depensesMois / budgetTotal) * 100 : 100;
        const scoreBudget = Math.min(25, Math.max(0, (100 - budgetPct) * 0.5));
        score += scoreBudget;
        items.push({ label: 'Budget respectÃ©', val: budgetPct.toFixed(0) + '%', cls: budgetPct <= 80 ? 'positive' : budgetPct <= 100 ? 'warning' : 'negative' });

        // PEA actif (max 25pts)
        if (peaActuel) {
            const scorePEA = Math.min(25, Math.max(0, peaActuel.valeur / 1000));
            score += scorePEA;
            items.push({ label: 'Investissement PEA', val: peaActuel.performance + '%', cls: parseFloat(peaActuel.performance) >= 0 ? 'positive' : 'negative' });
        } else {
            items.push({ label: 'Investissement PEA', val: 'Inactif', cls: 'negative' });
        }

        // Objectifs (max 25pts)
        if (this.data.objectifs.length > 0) {
            const avgProg = this.data.objectifs.reduce((s, o) => s + Math.min(100, (o.actuel / o.cible) * 100), 0) / this.data.objectifs.length;
            score += Math.min(25, avgProg * 0.25);
            items.push({ label: 'Objectifs', val: avgProg.toFixed(0) + '%', cls: avgProg >= 50 ? 'positive' : 'warning' });
        } else {
            items.push({ label: 'Objectifs dÃ©finis', val: 'Aucun', cls: 'negative' });
        }

        const finalScore = Math.round(Math.min(100, score));
        document.getElementById('score-num').textContent = finalScore;
        const arc = document.getElementById('score-arc');
        const circumference = 289;
        arc.style.strokeDashoffset = circumference - (circumference * finalScore / 100);
        arc.style.transition = 'stroke-dashoffset 1s cubic-bezier(0.4,0,0.2,1)';

        document.getElementById('score-details').innerHTML = items.map(item => `
            <div style="display:flex;justify-content:space-between;padding:0.3rem 0;border-bottom:1px solid var(--border-color);font-size:0.8rem;">
                <span style="color:var(--text-secondary)">${item.label}</span>
                <span class="stat-change ${item.cls}" style="font-size:0.78rem">${item.val}</span>
            </div>
        `).join('');
    },

    // ===================== VUE RAPIDE =====================
    refreshVueRapide() {
        const now = new Date();
        const patrimoineActuel = this.data.patrimoine.length > 0 ?
            [...this.data.patrimoine].sort((a, b) => b.mois.localeCompare(a.mois))[0] : null;
        const depensesMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        }).reduce((sum, d) => sum + d.montant, 0);
        const budgetTotal = Object.values(this.data.budgets).reduce((s, v) => s + v, 0);
        const budgetRestant = budgetTotal - depensesMois;
        const peaActuel = this.data.suiviPEA.length > 0 ?
            [...this.data.suiviPEA].sort((a, b) => new Date(b.date) - new Date(a.date))[0] : null;
        const objEnRetard = this.data.objectifs.filter(o => {
            if (!o.dateTarget) return false;
            const moisRestants = (new Date(o.dateTarget) - now) / (1000 * 60 * 60 * 24 * 30);
            const mensuelNecessaire = moisRestants > 0 ? (o.cible - o.actuel) / moisRestants : Infinity;
            return mensuelNecessaire > 1000;
        }).length;

        const grid = document.getElementById('vue-rapide-grid');
        if (!grid) return;
        grid.innerHTML = [
            { icon: 'ğŸ’°', label: 'Patrimoine', val: patrimoineActuel ? this.formatCurrency(patrimoineActuel.total) : 'â€”', sub: '', cls: 'positive' },
            { icon: 'ğŸ“‰', label: 'DÃ©penses mois', val: this.formatCurrency(depensesMois), sub: budgetTotal > 0 ? (depensesMois/budgetTotal*100).toFixed(0)+'% du budget' : '', cls: depensesMois > budgetTotal ? 'negative' : 'positive' },
            { icon: 'ğŸ“ˆ', label: 'PEA', val: peaActuel ? this.formatCurrency(peaActuel.valeur) : 'â€”', sub: peaActuel ? (parseFloat(peaActuel.performance) >= 0 ? '+' : '') + peaActuel.performance + '%' : '', cls: peaActuel && peaActuel.gainPerte >= 0 ? 'positive' : 'negative' },
            { icon: 'ğŸ¯', label: 'Objectifs', val: this.data.objectifs.length + ' actif(s)', sub: objEnRetard > 0 ? objEnRetard + ' en retard' : 'Tout est OK', cls: objEnRetard > 0 ? 'negative' : 'positive' },
            { icon: 'ğŸ’³', label: 'Budget restant', val: this.formatCurrency(budgetRestant), sub: '', cls: budgetRestant >= 0 ? 'positive' : 'negative' },
            { icon: 'ğŸ”„', label: 'RÃ©currences', val: this.formatCurrency(this.data.recurrences.filter(r => r.actif).reduce((s, r) => s + r.montant, 0)) + '/mois', sub: this.data.recurrences.filter(r => r.actif).length + ' actif(s)', cls: '' }
        ].map(item => `
            <div class="stat-card" style="text-align:left;padding:0.85rem;display:flex;align-items:center;gap:0.75rem">
                <div style="font-size:1.3rem">${item.icon}</div>
                <div>
                    <div style="font-size:0.65rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-tertiary);margin-bottom:0.15rem">${item.label}</div>
                    <div style="font-weight:700;font-size:0.95rem;color:var(--text-primary)">${item.val}</div>
                    ${item.sub ? `<div class="stat-change ${item.cls}" style="font-size:0.72rem">${item.sub}</div>` : ''}
                </div>
            </div>
        `).join('');
    },

    // ===================== ALERTES INTELLIGENTES =====================
    refreshAlertes() {
        const now = new Date();
        const currentMonth = now.getMonth();
        const currentYear = now.getFullYear();
        const prevMonth = currentMonth === 0 ? 11 : currentMonth - 1;
        const prevYear = currentMonth === 0 ? currentYear - 1 : currentYear;

        const depMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
        });
        const depMoisPrev = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === prevMonth && date.getFullYear() === prevYear;
        });

        const parCatMois = {};
        const parCatPrev = {};
        depMois.forEach(d => { parCatMois[d.categorie] = (parCatMois[d.categorie] || 0) + d.montant; });
        depMoisPrev.forEach(d => { parCatPrev[d.categorie] = (parCatPrev[d.categorie] || 0) + d.montant; });

        const alertes = [];
        const salaire = this.data.parametres.salaire || 0;

        // Alerte si salaire non renseignÃ©
        if (salaire === 0) {
            alertes.push({ type: 'warning', icon: 'ğŸ’¡', msg: `Renseignez votre <strong>salaire mensuel</strong> dans les âš™ ParamÃ¨tres pour des analyses plus prÃ©cises.` });
        }

        // Taux d'effort (dÃ©penses / salaire) si salaire connu
        if (salaire > 0) {
            const totalMois = depMois.reduce((s, d) => s + d.montant, 0);
            const taux = (totalMois / salaire) * 100;
            if (taux > 90) {
                alertes.push({ type: 'danger', icon: 'ğŸš¨', msg: `Vous dÃ©pensez <strong>${taux.toFixed(0)}% de votre salaire</strong> ce mois â€” il ne reste que ${this.formatCurrency(salaire - totalMois)}.` });
            } else if (taux > 75) {
                alertes.push({ type: 'warning', icon: 'âš ï¸', msg: `Taux d'effort Ã©levÃ© : <strong>${taux.toFixed(0)}% du salaire</strong> dÃ©pensÃ© ce mois.` });
            } else {
                alertes.push({ type: 'success', icon: 'âœ…', msg: `Bonne maÃ®trise : ${taux.toFixed(0)}% du salaire dÃ©pensÃ© â€” <strong>${this.formatCurrency(salaire - totalMois)} Ã©pargnÃ©s</strong> ce mois.` });
            }
        }

        // DÃ©passements de budget
        Object.keys(this.data.budgets).forEach(cat => {
            const dep = parCatMois[cat] || 0;
            const budget = this.data.budgets[cat];
            if (dep > budget) {
                alertes.push({ type: 'danger', icon: 'ğŸš¨', msg: `Budget <strong>${cat}</strong> dÃ©passÃ© : ${this.formatCurrency(dep)} / ${this.formatCurrency(budget)}` });
            } else if (dep > budget * 0.85) {
                alertes.push({ type: 'warning', icon: 'âš ï¸', msg: `Budget <strong>${cat}</strong> bientÃ´t atteint : ${this.formatCurrency(dep)} / ${this.formatCurrency(budget)} (${(dep/budget*100).toFixed(0)}%)` });
            }
        });

        // DÃ©penses inhabituelles vs mois prÃ©cÃ©dent
        Object.keys(parCatMois).forEach(cat => {
            const prev = parCatPrev[cat];
            const mois = parCatMois[cat];
            if (prev && prev > 0) {
                const variation = ((mois - prev) / prev) * 100;
                if (variation > 50 && mois > 50) {
                    alertes.push({ type: 'warning', icon: 'ğŸ“¦', msg: `<strong>${cat}</strong> en hausse de ${variation.toFixed(0)}% vs mois dernier (${this.formatCurrency(mois)} vs ${this.formatCurrency(prev)})` });
                }
            }
        });

        // Bonne nouvelle : une catÃ©gorie sous budget
        let bonnes = 0;
        Object.keys(this.data.budgets).forEach(cat => {
            const dep = parCatMois[cat] || 0;
            if (dep > 0 && dep < this.data.budgets[cat] * 0.7) bonnes++;
        });
        if (bonnes > 0) {
            alertes.push({ type: 'success', icon: 'âœ…', msg: `<strong>${bonnes} catÃ©gorie(s)</strong> bien en dessous du budget â€” bravo !` });
        }

        const container = document.getElementById('alertes-container');
        if (!container) return;
        if (alertes.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âœ…</div><div>Aucune anomalie dÃ©tectÃ©e</div></div>';
            return;
        }
        container.innerHTML = alertes.map(a => `
            <div style="display:flex;gap:0.75rem;align-items:flex-start;padding:0.75rem 1rem;border-radius:10px;margin-bottom:0.5rem;
                background:var(--bg-secondary);border-left:3px solid var(--${a.type === 'danger' ? 'danger' : a.type === 'warning' ? 'warning' : 'success'})">
                <span style="font-size:1.1rem;flex-shrink:0">${a.icon}</span>
                <span style="font-size:0.82rem;color:var(--text-primary);line-height:1.4">${a.msg}</span>
            </div>
        `).join('');
    },

    // ===================== RÃˆGLE 50/30/20 =====================
    refreshRegle503020() {
        const now = new Date();
        const depMois = this.data.depenses.filter(d => {
            const date = new Date(d.date);
            return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
        });
        const totalDepenses = depMois.reduce((s, d) => s + d.montant, 0);
        const salaire = this.data.parametres.salaire || 0;
        // Base de calcul : salaire rÃ©el si dispo, sinon total dÃ©penses
        const base = salaire > 0 ? salaire : totalDepenses;
        if (base === 0) return;

        const besoinsKeys = ['MANGER', 'CARBU', 'TRANSPORT', 'LOYER', 'SANTE', 'FACTURE', 'ABONNEMENT'];
        const enviesKeys = ['LOISIR', 'BAR', 'VETEMENT', 'SHOPPING', 'RESTAURANT', 'SORTIE'];

        let besoins = 0, envies = 0;
        depMois.forEach(d => {
            const cat = d.categorie.toUpperCase();
            if (besoinsKeys.some(k => cat.includes(k))) besoins += d.montant;
            else if (enviesKeys.some(k => cat.includes(k))) envies += d.montant;
            else besoins += d.montant * 0.5, envies += d.montant * 0.5;
        });

        // Si salaire connu, l'Ã©pargne = ce qui n'est pas dÃ©pensÃ©
        const epargne = salaire > 0 ? Math.max(0, salaire - totalDepenses) : 0;

        const pBesoins = Math.round((besoins / base) * 100);
        const pEnvies = Math.round((envies / base) * 100);
        const pEpargne = salaire > 0 ? Math.round((epargne / salaire) * 100) : Math.max(0, 100 - pBesoins - pEnvies);
        const subtitle = salaire > 0 ? `sur ${this.formatCurrency(salaire)}/mois` : 'estimation sur dÃ©penses';

        const bar = document.getElementById('bar-503020');
        if (bar) {
            bar.innerHTML = `
                <div style="width:${pBesoins}%;background:rgba(63,81,181,0.4);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--accent-primary);font-weight:600;min-width:2rem">${pBesoins}%</div>
                <div style="width:${pEnvies}%;background:rgba(92,107,192,0.4);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--accent-secondary);font-weight:600;min-width:2rem">${pEnvies}%</div>
                <div style="flex:1;background:rgba(0,200,83,0.25);display:flex;align-items:center;justify-content:center;font-size:0.7rem;color:var(--success);font-weight:600;min-width:1.5rem">${pEpargne}%</div>
            `;
        }

        const comp = document.getElementById('comparaison-503020');
        if (comp) {
            const mkCol = (label, ideal, reel, good) => {
                const cls = good ? 'positive' : 'negative';
                return `<div class="stat-card" style="padding:0.75rem">
                    <div class="stat-label">${label}</div>
                    <div style="font-size:0.7rem;color:var(--text-tertiary)">cible ${ideal}%</div>
                    <div class="stat-change ${cls}" style="font-size:1rem;font-weight:700;margin-top:0.25rem">${reel}%</div>
                </div>`;
            };
            comp.innerHTML =
                mkCol('Besoins', 50, pBesoins, pBesoins <= 55) +
                mkCol('Envies', 30, pEnvies, pEnvies <= 33) +
                mkCol('Ã‰pargne', 20, pEpargne, pEpargne >= 15);
        }

        // Mettre Ã  jour le sous-titre
        const subtitleEl = document.querySelector('#comparaison-503020')?.previousElementSibling?.previousElementSibling;
        const titleEl = document.querySelector('[id="bar-503020"]')?.previousElementSibling;
        if (titleEl) titleEl.textContent = `Ce mois â€” ${subtitle}`;
    },

    // ===================== RÃ‰CURRENCES =====================
    ouvrirAjoutRecurrence() {
        // Modale manuelle inline
        let modal = document.getElementById('recurrenceModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'recurrenceModal';
            modal.className = 'modal';
            modal.style.borderRadius = '20px';
            document.body.appendChild(modal);
        }
        modal.innerHTML = `
            <div class="modal-header"><h2 class="modal-title">ğŸ”„ Nouvelle rÃ©currence</h2></div>
            <div class="modal-body">
                <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="rec-nom" placeholder="Ex: Loyer, Netflix..."></div>
                <div class="form-group"><label class="form-label">Emoji</label>
                    <div class="emoji-picker-wrap">
                        <button type="button" class="emoji-preview-btn" onclick="app.openEmojiPicker('rec-emoji', this)">ğŸ </button>
                        <input type="text" class="form-input" id="rec-emoji" placeholder="ğŸ " style="display:none">
                    </div>
                </div>
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Montant (â‚¬)</label><input type="number" class="form-input" id="rec-montant" placeholder="0" step="0.01"></div>
                    <div class="form-group"><label class="form-label">Jour du mois</label><input type="number" class="form-input" id="rec-jour" placeholder="1" min="1" max="31"></div>
                </div>
                <div class="form-group"><label class="form-label">FrÃ©quence</label>
                    <select class="form-select" id="rec-freq"><option value="mensuel">Mensuel</option><option value="trimestriel">Trimestriel</option><option value="annuel">Annuel</option></select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('recurrenceModal').classList.remove('active');document.getElementById('overlay').classList.remove('active')">Annuler</button>
                <button class="btn" onclick="app.ajouterRecurrence()">+ Ajouter</button>
            </div>
        `;
        modal.classList.add('active');
        document.getElementById('overlay').classList.add('active');
    },

    ajouterRecurrence() {
        const nom = document.getElementById('rec-nom').value.trim();
        const emojiInput = document.getElementById('rec-emoji');
        const emojiBtn = emojiInput.closest('.emoji-picker-wrap')?.querySelector('.emoji-preview-btn');
        const emoji = emojiInput.value.trim() || (emojiBtn ? emojiBtn.textContent.trim() : '') || 'ğŸ’³';
        const montant = parseFloat(document.getElementById('rec-montant').value);
        const jour = parseInt(document.getElementById('rec-jour').value) || 1;
        const freq = document.getElementById('rec-freq').value;
        if (!nom || !montant) { this.notify('Remplir nom et montant', 'error'); return; }
        this.data.recurrences.push({ id: Date.now(), nom, emoji, montant, jour, freq, actif: true });
        this.save();
        this.refreshRecurrences();
        document.getElementById('recurrenceModal').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        this.notify('RÃ©currence ajoutÃ©e', 'success');
    },

    supprimerRecurrence(id) {
        this.data.recurrences = this.data.recurrences.filter(r => r.id !== id);
        this.save();
        this.refreshRecurrences();
        this.notify('RÃ©currence supprimÃ©e', 'success');
    },

    refreshRecurrences() {
        const container = document.getElementById('recurrences-list');
        if (!container) return;
        const recs = this.data.recurrences;
        if (recs.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”„</div><div>Aucune rÃ©currence dÃ©finie</div></div>';
            const tot = document.getElementById('recurrences-total-wrap');
            if (tot) tot.style.display = 'none';
            return;
        }
        const now = new Date();
        const today = now.getDate();
        container.innerHTML = recs.map(r => {
            const jours = r.jour > today ? r.jour - today : 30 - today + r.jour;
            return `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:0.65rem 0.85rem;background:var(--bg-secondary);border-radius:10px;margin-bottom:0.5rem;border:1px solid var(--border-color)">
                <div style="display:flex;align-items:center;gap:0.75rem">
                    <div style="width:8px;height:8px;border-radius:50%;background:${r.actif ? 'var(--success)' : 'var(--text-tertiary)'};box-shadow:${r.actif ? '0 0 6px var(--success)' : 'none'}"></div>
                    <span style="font-size:1.1rem">${r.emoji}</span>
                    <div>
                        <div style="font-size:0.85rem;font-weight:600">${r.nom}</div>
                        <div style="font-size:0.7rem;color:var(--text-tertiary)">${r.freq} Â· le ${r.jour}</div>
                    </div>
                </div>
                <div style="display:flex;align-items:center;gap:1rem">
                    <div style="text-align:right">
                        <div style="font-family:'DM Mono',monospace;font-size:0.9rem;font-weight:600;color:var(--danger)">âˆ’${this.formatCurrency(r.montant)}</div>
                        <div style="font-size:0.65rem;color:var(--text-tertiary)">Dans ${jours} jours</div>
                    </div>
                    <button class="btn btn-small btn-secondary" onclick="app.supprimerRecurrence(${r.id})">âœ•</button>
                </div>
            </div>`;
        }).join('');
        const total = recs.filter(r => r.actif).reduce((s, r) => s + r.montant, 0);
        const totWrap = document.getElementById('recurrences-total-wrap');
        if (totWrap) { totWrap.style.display = 'flex'; }
        const totEl = document.getElementById('recurrences-total');
        if (totEl) totEl.textContent = this.formatCurrency(total);
    },

    // ===================== OBJECTIFS =====================
    ouvrirAjoutObjectif() {
        let modal = document.getElementById('objectifModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'objectifModal';
            modal.className = 'modal';
            modal.style.borderRadius = '20px';
            document.body.appendChild(modal);
        }
        modal.innerHTML = `
            <div class="modal-header"><h2 class="modal-title">ğŸ¯ Nouvel objectif</h2></div>
            <div class="modal-body">
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Nom</label><input type="text" class="form-input" id="obj-nom" placeholder="Voyage Japon..."></div>
                    <div class="form-group"><label class="form-label">Emoji</label>
                        <div class="emoji-picker-wrap">
                            <button type="button" class="emoji-preview-btn" onclick="app.openEmojiPicker('obj-emoji', this)">ğŸ¯</button>
                            <input type="text" class="form-input" id="obj-emoji" placeholder="ğŸ¯" style="display:none">
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Montant cible (â‚¬)</label><input type="number" class="form-input" id="obj-cible" placeholder="3500" step="100"></div>
                    <div class="form-group"><label class="form-label">DÃ©jÃ  Ã©pargnÃ© (â‚¬)</label><input type="number" class="form-input" id="obj-actuel" placeholder="0" step="100"></div>
                </div>
                <div class="form-group"><label class="form-label">Date cible</label><input type="month" class="form-input" id="obj-date"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('objectifModal').classList.remove('active');document.getElementById('overlay').classList.remove('active')">Annuler</button>
                <button class="btn" onclick="app.ajouterObjectif()">+ Ajouter</button>
            </div>
        `;
        modal.classList.add('active');
        document.getElementById('overlay').classList.add('active');
    },

    ajouterObjectif() {
        const nom = document.getElementById('obj-nom').value.trim();
        const emojiInput = document.getElementById('obj-emoji');
        const emojiBtn = emojiInput.closest('.emoji-picker-wrap')?.querySelector('.emoji-preview-btn');
        const emoji = emojiInput.value.trim() || (emojiBtn ? emojiBtn.textContent.trim() : '') || 'ğŸ¯';
        const cible = parseFloat(document.getElementById('obj-cible').value);
        const actuel = parseFloat(document.getElementById('obj-actuel').value) || 0;
        const dateTarget = document.getElementById('obj-date').value;
        if (!nom || !cible) { this.notify('Remplir nom et cible', 'error'); return; }
        this.data.objectifs.push({ id: Date.now(), nom, emoji, cible, actuel, dateTarget });
        this.save();
        this.refreshObjectifs();
        document.getElementById('objectifModal').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        this.notify('Objectif ajoutÃ©', 'success');
    },

    mettreAJourObjectif(id, nouvelActuel) {
        const obj = this.data.objectifs.find(o => o.id === id);
        if (obj) { obj.actuel = parseFloat(nouvelActuel) || 0; this.save(); this.refreshObjectifs(); }
    },

    supprimerObjectif(id) {
        this.showModal('Supprimer l\'objectif', 'Voulez-vous vraiment supprimer cet objectif ?', () => {
            this.data.objectifs = this.data.objectifs.filter(o => o.id !== id);
            this.save();
            this.refreshObjectifs();
            this.notify('Objectif supprimÃ©', 'success');
        });
    },

    refreshObjectifs() {
        const list = document.getElementById('objectifs-list');
        const calcCard = document.getElementById('objectifs-calcul-card');
        if (!list) return;
        const objs = this.data.objectifs;
        const now = new Date();

        document.getElementById('obj-count').textContent = objs.length;
        document.getElementById('obj-total-cible').textContent = this.formatCurrency(objs.reduce((s, o) => s + o.cible, 0));

        if (objs.length === 0) {
            list.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ¯</div><div>Aucun objectif dÃ©fini</div></div>';
            if (calcCard) calcCard.style.display = 'none';
            document.getElementById('obj-mensuel-total').textContent = '0 â‚¬';
            return;
        }

        let totalMensuel = 0;
        let calcHtml = '';

        list.innerHTML = objs.map(o => {
            const pct = Math.min(100, (o.actuel / o.cible) * 100);
            const moisRestants = o.dateTarget ? Math.max(1, Math.ceil((new Date(o.dateTarget + '-01') - now) / (1000 * 60 * 60 * 24 * 30))) : 12;
            const mensuel = Math.ceil((o.cible - o.actuel) / moisRestants);
            totalMensuel += Math.max(0, mensuel);

            const dateLabel = o.dateTarget ? new Date(o.dateTarget + '-01').toLocaleDateString('fr-FR', {month:'long', year:'numeric'}) : 'Pas de date';
            const progressCls = pct >= 100 ? 'success' : pct >= 60 ? '' : pct >= 30 ? 'warning' : 'danger';

            calcHtml += `
                <div style="display:flex;justify-content:space-between;align-items:center;padding:0.65rem 0.85rem;background:var(--bg-secondary);border-radius:10px;margin-bottom:0.5rem;border:1px solid var(--border-color)">
                    <div><span style="font-size:0.9rem">${o.emoji}</span> <strong>${o.nom}</strong>
                        <div style="font-size:0.72rem;color:var(--text-tertiary)">${dateLabel} Â· ${moisRestants} mois</div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-family:'DM Mono',monospace;font-size:0.9rem;font-weight:700;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));-webkit-background-clip:text;-webkit-text-fill-color:transparent">${this.formatCurrency(Math.max(0, mensuel))}/mois</div>
                        <div style="font-size:0.68rem;color:var(--text-tertiary)">Reste ${this.formatCurrency(Math.max(0, o.cible - o.actuel))}</div>
                    </div>
                </div>
            `;

            return `
            <div class="card" style="margin-bottom:1rem;padding:1.25rem">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:0.75rem">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-size:1.3rem">${o.emoji}</span>
                        <div>
                            <div style="font-weight:700;font-size:0.95rem">${o.nom}</div>
                            <div style="font-size:0.72rem;color:var(--text-tertiary)">${dateLabel} Â· ${moisRestants} mois restants</div>
                        </div>
                    </div>
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-family:'DM Mono',monospace;font-size:0.82rem;color:var(--text-secondary)">${this.formatCurrency(o.actuel)} / ${this.formatCurrency(o.cible)}</span>
                        <button class="btn btn-small btn-secondary" onclick="app.supprimerObjectif(${o.id})">âœ•</button>
                    </div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${progressCls}" style="width:${pct}%"></div>
                </div>
                <div style="display:flex;justify-content:space-between;margin-top:0.5rem;font-size:0.78rem;color:var(--text-tertiary)">
                    <span>${pct.toFixed(0)}% atteint</span>
                    <span>Ã‰pargner <strong>${this.formatCurrency(Math.max(0,mensuel))}/mois</strong></span>
                </div>
                <div style="margin-top:0.75rem;display:flex;gap:0.5rem;align-items:center">
                    <input type="number" class="form-input" placeholder="Mettre Ã  jour le montant" step="50" style="flex:1"
                        onchange="app.mettreAJourObjectif(${o.id}, this.value)">
                </div>
            </div>`;
        }).join('');

        if (calcCard) {
            calcCard.style.display = 'block';
            document.getElementById('objectifs-calcul').innerHTML = calcHtml;
            document.getElementById('obj-grand-total').textContent = this.formatCurrency(totalMensuel);
        }
        document.getElementById('obj-mensuel-total').textContent = this.formatCurrency(totalMensuel);
    },

    // ===================== NOTES =====================
    ajouterNote() {
        const mois = document.getElementById('note-mois').value;
        const texte = document.getElementById('note-texte').value.trim();
        const tag = document.getElementById('note-tag').value;
        if (!mois || !texte) { this.notify('Remplir mois et note', 'error'); return; }
        this.data.notes.push({ id: Date.now(), mois, texte, tag });
        this.save();
        this.refreshNotes();
        document.getElementById('note-texte').value = '';
        this.notify('Note enregistrÃ©e', 'success');
    },

    supprimerNote(id) {
        this.data.notes = this.data.notes.filter(n => n.id !== id);
        this.save();
        this.refreshNotes();
        this.notify('Note supprimÃ©e', 'success');
    },

    refreshNotes() {
        const container = document.getElementById('notes-list');
        if (!container) return;
        const notes = [...this.data.notes].sort((a, b) => b.mois.localeCompare(a.mois));
        if (notes.length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“</div><div>Aucune note enregistrÃ©e</div></div>';
            return;
        }
        const tagColors = {
            'GÃ©nÃ©ral': 'var(--accent-primary)',
            'DÃ©pense exceptionnelle': 'var(--warning)',
            'Revenu exceptionnel': 'var(--success)',
            'Ã‰vÃ©nement important': 'var(--accent-secondary)',
            'Objectif atteint ğŸ‰': 'var(--success)'
        };
        container.innerHTML = notes.map(n => {
            const color = tagColors[n.tag] || 'var(--accent-primary)';
            const dateLabel = new Date(n.mois + '-01').toLocaleDateString('fr-FR', {month:'long', year:'numeric'});
            return `
            <div style="background:var(--bg-secondary);border-radius:12px;padding:1rem 1.25rem;margin-bottom:0.75rem;border-left:3px solid ${color};border:1px solid var(--border-color);border-left:3px solid ${color}">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.5rem">
                    <div style="display:flex;align-items:center;gap:0.5rem">
                        <span style="font-family:'DM Mono',monospace;font-size:0.78rem;color:${color};font-weight:600">${dateLabel}</span>
                        <span style="font-size:0.65rem;padding:0.15rem 0.5rem;border-radius:4px;background:${color}22;color:${color}">${n.tag}</span>
                    </div>
                    <button class="btn btn-small btn-secondary" onclick="app.supprimerNote(${n.id})">âœ•</button>
                </div>
                <div style="font-size:0.85rem;color:var(--text-secondary);line-height:1.5">${n.texte}</div>
            </div>`;
        }).join('');
    },

    // ===================== LIGNES PEA & PRU =====================
    ouvrirAjoutLignePEA() {
        let modal = document.getElementById('lignePEAModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'lignePEAModal';
            modal.className = 'modal';
            modal.style.borderRadius = '20px';
            document.body.appendChild(modal);
        }
        modal.innerHTML = `
            <div class="modal-header"><h2 class="modal-title">ğŸ“ˆ Nouvelle ligne PEA</h2></div>
            <div class="modal-body">
                <div class="grid grid-2">
                    <div class="form-group"><label class="form-label">Nom du titre</label><input type="text" class="form-input" id="lpea-nom" placeholder="MSCI World"></div>
                    <div class="form-group"><label class="form-label">ISIN</label><input type="text" class="form-input" id="lpea-isin" placeholder="IE00B4L5Y983" style="font-family:'DM Mono',monospace;letter-spacing:0.04em"></div>
                    <div class="form-group"><label class="form-label">Nombre de parts</label><input type="number" class="form-input" id="lpea-parts" placeholder="10" step="1"></div>
                    <div class="form-group"><label class="form-label">PRU (â‚¬ / part)</label><input type="number" class="form-input" id="lpea-pru" placeholder="0.00" step="0.01"></div>
                </div>
                <p style="font-size:0.72rem;color:var(--text-tertiary);font-family:'DM Mono',monospace;margin-top:0.5rem">ğŸ’¡ Saisis l'ISIN (ex: <strong>IE00B4L5Y983</strong>) ou directement le ticker Yahoo Finance (ex: <strong>MWRD.PA</strong>). Le cours sera rÃ©cupÃ©rÃ© automatiquement via ğŸ”„ Actualiser.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('lignePEAModal').classList.remove('active');document.getElementById('overlay').classList.remove('active')">Annuler</button>
                <button class="btn" onclick="app.ajouterLignePEA()">+ Ajouter</button>
            </div>
        `;
        modal.classList.add('active');
        document.getElementById('overlay').classList.add('active');
    },

    ajouterLignePEA() {
        const nom = document.getElementById('lpea-nom').value.trim();
        const isin = document.getElementById('lpea-isin').value.trim().toUpperCase();
        const parts = parseFloat(document.getElementById('lpea-parts').value) || 0;
        const pru = parseFloat(document.getElementById('lpea-pru').value) || 0;
        if (!nom || !parts) { this.notify('Remplir nom et parts', 'error'); return; }
        this.data.lignesPEA.push({ id: Date.now(), nom, isin, ticker: '', parts, pru, valeurActuelle: pru });
        this.save();
        this.refreshLignesPEA();
        this.refreshAllocationPEA();
        this.chartPEA();
        document.getElementById('lignePEAModal').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        this.notify('Ligne PEA ajoutÃ©e â€” clique sur ğŸ”„ Actualiser pour rÃ©cupÃ©rer le cours', 'success');
    },

    supprimerLignePEA(id) {
        this.data.lignesPEA = this.data.lignesPEA.filter(l => l.id !== id);
        this.save();
        this.refreshLignesPEA();
        this.refreshAllocationPEA();
        this.chartPEA();
        this.notify('Ligne supprimÃ©e', 'success');
    },

    refreshLignesPEA() {
        const tbody = document.getElementById('tbody-lignes-pea');
        if (!tbody) return;
        const lignes = this.data.lignesPEA;
        if (lignes.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="empty-state"><div class="empty-state-icon">ğŸ“ˆ</div><div>Ajouter vos lignes PEA</div></td></tr>';
            document.getElementById('pv-latente-total').textContent = this.formatCurrency(0);
            return;
        }
        let pvTotal = 0;
        tbody.innerHTML = lignes.map(l => {
            const valeurTotale = l.parts * (l.valeurActuelle || l.pru);
            const investi = l.parts * l.pru;
            const pv = valeurTotale - investi;
            const pvPct = investi > 0 ? ((pv / investi) * 100).toFixed(1) : 0;
            pvTotal += pv;
            const isinDisplay = l.isin || l.ticker || 'â€”';
            return `
            <tr>
                <td><strong>${l.nom}</strong></td>
                <td style="font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-tertiary)">${isinDisplay}</td>
                <td style="font-family:'DM Mono',monospace">${l.parts}</td>
                <td style="font-family:'DM Mono',monospace">${this.formatCurrency(l.pru)}</td>
                <td style="font-family:'DM Mono',monospace">${this.formatCurrency(l.valeurActuelle || l.pru)}</td>
                <td style="font-family:'DM Mono',monospace">${this.formatCurrency(investi)}</td>
                <td class="stat-change ${pv >= 0 ? 'positive' : 'negative'}" style="font-family:'DM Mono',monospace">${pv >= 0 ? '+' : ''}${pvPct}%</td>
                <td><button class="btn btn-small btn-secondary" onclick="app.supprimerLignePEA(${l.id})">âœ•</button></td>
            </tr>`;
        }).join('');
        document.getElementById('pv-latente-total').textContent = (pvTotal >= 0 ? '+' : '') + this.formatCurrency(pvTotal);
    },

    // ===================== ACTUALISATION COURS PEA â€” GOOGLE SHEETS =====================
    async actualiserCoursPEA() {
        const lignes = this.data.lignesPEA;
        if (lignes.length === 0) {
            this.notify('Ajoute des lignes PEA en premier', 'error');
            return;
        }

        const sheetUrl = (this.data.parametres.googleSheetsUrl || '').trim();
        if (!sheetUrl) {
            this.notify('URL Google Sheets manquante â€” ouvre les âš™ ParamÃ¨tres', 'error');
            app.ouvrirGuideGSheets();
            return;
        }

        const btn  = document.getElementById('btn-actualiser-pea');
        const icon = document.getElementById('actualiser-icon');
        if (btn)  btn.disabled = true;
        if (icon) icon.textContent = 'â³';
        this.notify('Lecture du Google Sheetâ€¦', 'info');

        try {
            // Google Sheets publiÃ©s en CSV = CORS natif, aucun proxy nÃ©cessaire
            const r = await Promise.race([
                fetch(sheetUrl),
                new Promise((_, rej) => setTimeout(() => rej(new Error('Timeout â€” vÃ©rifie que le Sheet est bien publiÃ©')), 10000))
            ]);
            if (!r.ok) throw new Error(`Erreur HTTP ${r.status} â€” le Sheet est-il publiÃ© en accÃ¨s public ?`);

            const csv = await r.text();
            const rows = csv.trim().split(String.fromCharCode(10)).map(row =>
                row.split(',').map(cell => cell.trim().replace(/^"|"$/g, ''))
            );

            // DÃ©tecte si la premiÃ¨re ligne est un header (contient du texte non-numÃ©rique)
            const firstRowIsHeader = isNaN(parseFloat(rows[0]?.[1]));
            const dataRows = firstRowIsHeader ? rows.slice(1) : rows;

            if (dataRows.length === 0) throw new Error('Le Google Sheet semble vide');

            // Construit un dictionnaire : identifiant (ISIN ou nom, insensible Ã  la casse) â†’ prix
            const prixMap = {};
            dataRows.forEach(row => {
                if (row.length < 2) return;
                const key   = (row[0] || '').trim().toUpperCase();
                const prix  = parseFloat((row[1] || '').replace(',', '.'));
                if (key && !isNaN(prix) && prix > 0) prixMap[key] = prix;
            });

            if (Object.keys(prixMap).length === 0)
                throw new Error('Aucun cours trouvÃ© dans le Sheet â€” vÃ©rifie le format (colonne A = ISIN, colonne B = prix)');

            // Match chaque ligne PEA avec le Sheet (par ISIN ou par nom)
            let mises = 0, nonTrouves = [];
            lignes.forEach(l => {
                const isinKey = (l.isin || '').trim().toUpperCase();
                const nomKey  = (l.nom  || '').trim().toUpperCase();
                const prix = prixMap[isinKey] ?? prixMap[nomKey] ?? null;
                if (prix !== null) {
                    l.valeurActuelle = prix;
                    mises++;
                } else {
                    nonTrouves.push(l.nom);
                }
            });

            if (mises === 0)
                throw new Error(`Aucune correspondance trouvÃ©e. VÃ©rifie que les ISIN du Sheet (${Object.keys(prixMap).join(', ')}) correspondent Ã  tes lignes PEA.`);

            // EntrÃ©e automatique dans l'historique PEA
            const totalValeur  = lignes.reduce((s, l) => s + (l.parts * (l.valeurActuelle || l.pru)), 0);
            const totalInvesti = lignes.reduce((s, l) => s + (l.parts * l.pru), 0);
            const gain = totalValeur - totalInvesti;
            const perf = totalInvesti > 0 ? ((gain / totalInvesti) * 100).toFixed(2) : '0';
            const today = new Date().toISOString().split('T')[0];
            const entry = { id: Date.now(), date: today, valeur: totalValeur, investi: totalInvesti,
                            gainPerte: gain, performance: perf, note: 'ğŸ”„ Google Sheets' };
            const idx = this.data.suiviPEA.findIndex(p => p.date === today);
            if (idx >= 0) this.data.suiviPEA[idx] = entry; else this.data.suiviPEA.push(entry);

            this.save();
            this.refreshLignesPEA();
            this.refreshStatsPEA();
            this.afficherPEA();
            this.chartPEA();
            this.refreshAllocationPEA();

            const warn = nonTrouves.length > 0 ? ` âš ï¸ Non trouvÃ©s : ${nonTrouves.join(', ')}` : '';
            this.notify(`âœ… ${mises} cours mis Ã  jour â€” PEA : ${this.formatCurrency(totalValeur)}${warn}`, 'success');

        } catch(err) {
            this.notify(`âŒ ${err.message}`, 'error');
            console.error('Actualisation PEA (GSheets):', err);
        } finally {
            if (btn)  btn.disabled = false;
            if (icon) icon.textContent = 'ğŸ”„';
        }
    },

    // â”€â”€â”€ Guide Google Sheets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ouvrirGuideGSheets() {
        let modal = document.getElementById('gsheetsGuideModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'gsheetsGuideModal';
            modal.className = 'modal';
            modal.style.cssText = 'border-radius:20px;max-width:560px;width:calc(100% - 2rem);max-height:90vh;overflow-y:auto';
            document.body.appendChild(modal);
        }

        // GÃ©nÃ¨re les formules pour les lignes PEA existantes
        const lignes = this.data.lignesPEA;
        const exIsin = lignes.length > 0 ? lignes[0].isin || 'FR001400U5Q4' : 'FR001400U5Q4';
        const exNom  = lignes.length > 0 ? lignes[0].nom  || 'Amundi PEA Monde' : 'Amundi PEA Monde';

        const templateRows = lignes.length > 0
            ? lignes.map(l => `<tr style="border-bottom:1px solid var(--border-color)">
                <td style="padding:0.4rem 0.6rem;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--text-primary)">${l.isin || l.nom}</td>
                <td style="padding:0.4rem 0.6rem;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--success)">=GOOGLEFINANCE("${l.isin || l.nom}","price")</td>
              </tr>`).join('')
            : `<tr><td style="padding:0.4rem 0.6rem;font-family:'DM Mono',monospace;font-size:0.72rem">${exIsin}</td>
               <td style="padding:0.4rem 0.6rem;font-family:'DM Mono',monospace;font-size:0.72rem;color:var(--success)">=GOOGLEFINANCE("${exIsin}","price")</td></tr>`;

        modal.innerHTML = `
            <div class="modal-header">
                <h2 class="modal-title">ğŸ“Š Configurer Google Sheets</h2>
            </div>
            <div class="modal-body" style="padding-top:0.5rem">

                <!-- Ã‰tapes -->
                <div style="display:flex;flex-direction:column;gap:1rem">

                    <div style="display:flex;gap:0.75rem;align-items:flex-start">
                        <div style="min-width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8rem;flex-shrink:0">1</div>
                        <div>
                            <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.25rem">CrÃ©e un nouveau Google Sheet</div>
                            <a href="https://sheets.new" target="_blank" style="display:inline-flex;align-items:center;gap:0.4rem;padding:0.35rem 0.75rem;background:var(--bg-secondary);border-radius:8px;color:var(--accent-primary);text-decoration:none;font-size:0.8rem;font-weight:600;border:1px solid var(--border-color)">
                                ğŸ”— Ouvrir sheets.new
                            </a>
                        </div>
                    </div>

                    <div style="display:flex;gap:0.75rem;align-items:flex-start">
                        <div style="min-width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8rem;flex-shrink:0">2</div>
                        <div style="width:100%">
                            <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.5rem">Remplis le sheet avec tes ISIN</div>
                            <div style="font-size:0.78rem;color:var(--text-secondary);margin-bottom:0.5rem">Colonne A = ISIN Â· Colonne B = formule GOOGLEFINANCE</div>
                            <div style="background:var(--bg-secondary);border-radius:10px;overflow:hidden;border:1px solid var(--border-color)">
                                <div style="display:flex;padding:0.35rem 0.6rem;background:rgba(var(--heatmap-rgb),0.1);font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--text-tertiary);font-weight:600;gap:2rem">
                                    <span style="min-width:140px">A â€” ISIN</span><span>B â€” Formule prix</span>
                                </div>
                                <table style="width:100%;border-collapse:collapse">${templateRows}</table>
                            </div>
                            <div style="margin-top:0.5rem;font-size:0.72rem;color:var(--text-tertiary)">
                                ğŸ’¡ GOOGLEFINANCE reconnaÃ®t les ISIN directement â€” pas besoin de ticker.
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:0.75rem;align-items:flex-start">
                        <div style="min-width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8rem;flex-shrink:0">3</div>
                        <div>
                            <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.25rem">Publie le sheet en CSV</div>
                            <div style="font-size:0.78rem;color:var(--text-secondary);line-height:1.7">
                                <strong>Fichier</strong> â†’ <strong>Partager</strong> â†’ <strong>Publier sur le web</strong><br>
                                â†’ SÃ©lectionne <strong>Feuille 1</strong> et format <strong>Valeurs sÃ©parÃ©es par des virgules (.csv)</strong><br>
                                â†’ Clique <strong>Publier</strong> â†’ Copie l'URL gÃ©nÃ©rÃ©e
                            </div>
                        </div>
                    </div>

                    <div style="display:flex;gap:0.75rem;align-items:flex-start">
                        <div style="min-width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,var(--accent-gradient-start),var(--accent-gradient-end));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:0.8rem;flex-shrink:0">4</div>
                        <div style="width:100%">
                            <div style="font-weight:700;font-size:0.9rem;margin-bottom:0.4rem">Colle l'URL dans les ParamÃ¨tres</div>
                            <div style="display:flex;gap:0.5rem">
                                <input type="text" id="guide-gsheets-url" placeholder="https://docs.google.com/spreadsheets/d/..." class="form-input" style="font-size:0.72rem;font-family:'DM Mono',monospace;flex:1">
                                <button class="btn btn-small" onclick="app._saveGsheetsUrlFromGuide()">Sauvegarder</button>
                            </div>
                        </div>
                    </div>

                </div>

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('gsheetsGuideModal').classList.remove('active');document.getElementById('overlay').classList.remove('active')">Fermer</button>
                <button class="btn" onclick="app._saveGsheetsUrlFromGuide();app.actualiserCoursPEA()">ğŸ”„ Tester maintenant</button>
            </div>`;

        modal.classList.add('active');
        document.getElementById('overlay').classList.add('active');
        document.getElementById('overlay').onclick = () => {
            modal.classList.remove('active');
            document.getElementById('overlay').classList.remove('active');
        };
        // PrÃ©-rempli si URL dÃ©jÃ  connue
        const inp = document.getElementById('guide-gsheets-url');
        if (inp && this.data.parametres.googleSheetsUrl) inp.value = this.data.parametres.googleSheetsUrl;
    },

    _saveGsheetsUrlFromGuide() {
        const url = (document.getElementById('guide-gsheets-url')?.value || '').trim();
        if (!url) { this.notify('Colle une URL', 'error'); return; }
        this.data.parametres.googleSheetsUrl = url;
        // Sync dans settings panel aussi
        const inp2 = document.getElementById('set-gsheets-url');
        if (inp2) inp2.value = url;
        this.save();
        document.getElementById('gsheetsGuideModal').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        this.notify('URL Google Sheets sauvegardÃ©e âœ“', 'success');
    },


    ouvrirAllocationCible() {
        let modal = document.getElementById('allocModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'allocModal';
            modal.className = 'modal';
            modal.style.borderRadius = '20px';
            document.body.appendChild(modal);
        }
        const noms = this.data.lignesPEA.map(l => l.nom);
        const existing = this.data.allocationCible;
        modal.innerHTML = `
            <div class="modal-header"><h2 class="modal-title">ğŸ¯ Allocation Cible (%)</h2></div>
            <div class="modal-body">
                <p style="font-size:0.82rem;color:var(--text-secondary);margin-bottom:1rem">DÃ©finissez le % cible pour chaque ligne de votre portefeuille</p>
                ${noms.length === 0 ? '<p style="color:var(--text-tertiary)">Ajoutez d\'abord des lignes PEA</p>' : noms.map(nom => `
                    <div class="form-group" style="display:flex;align-items:center;gap:1rem">
                        <label class="form-label" style="flex:1;margin:0">${nom}</label>
                        <input type="number" class="form-input" id="alloc-${nom.replace(/\s/g,'_')}" value="${existing[nom] || ''}" placeholder="0" step="5" style="width:100px">
                        <span style="font-size:0.85rem;color:var(--text-tertiary)">%</span>
                    </div>
                `).join('')}
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="document.getElementById('allocModal').classList.remove('active');document.getElementById('overlay').classList.remove('active')">Annuler</button>
                <button class="btn" onclick="app.sauvegarderAllocationCible()">âœ… Sauvegarder</button>
            </div>
        `;
        modal.classList.add('active');
        document.getElementById('overlay').classList.add('active');
    },

    sauvegarderAllocationCible() {
        this.data.lignesPEA.forEach(l => {
            const input = document.getElementById('alloc-' + l.nom.replace(/\s/g,'_'));
            if (input) this.data.allocationCible[l.nom] = parseFloat(input.value) || 0;
        });
        this.save();
        document.getElementById('allocModal').classList.remove('active');
        document.getElementById('overlay').classList.remove('active');
        this.refreshAllocationPEA();
        this.notify('Allocation sauvegardÃ©e', 'success');
    },

    refreshAllocationPEA() {
        const container = document.getElementById('allocation-container');
        if (!container) return;
        const lignes = this.data.lignesPEA;
        const cibles = this.data.allocationCible;
        if (lignes.length === 0 || Object.keys(cibles).length === 0) {
            container.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><div>Configurer l\'allocation cible via le bouton âš™</div></div>';
            return;
        }
        const totalVal = lignes.reduce((s, l) => s + l.parts * l.valeurActuelle, 0);
        if (totalVal === 0) { container.innerHTML = '<div class="empty-state"><div>Valeur totale = 0â‚¬</div></div>'; return; }
        container.innerHTML = lignes.map(l => {
            const valeurTotale = l.parts * l.valeurActuelle;
            const reel = totalVal > 0 ? (valeurTotale / totalVal * 100).toFixed(1) : 0;
            const cible = cibles[l.nom] || 0;
            const ecart = (parseFloat(reel) - cible).toFixed(1);
            const ecartCls = Math.abs(ecart) <= 3 ? 'positive' : ecart > 0 ? 'negative' : 'warning';
            return `
            <div style="margin-bottom:1rem">
                <div style="display:flex;justify-content:space-between;margin-bottom:0.3rem;font-size:0.82rem">
                    <span style="font-weight:600">${l.nom}</span>
                    <span style="font-family:'DM Mono',monospace;color:var(--text-secondary)">cible ${cible}% Â· rÃ©el ${reel}%</span>
                </div>
                <div style="height:10px;background:var(--bg-secondary);border-radius:6px;position:relative;overflow:hidden">
                    <div style="height:100%;width:${Math.min(100,cible)}%;background:var(--border-color);position:absolute;left:0;top:0;border-radius:6px;"></div>
                    <div style="height:100%;width:${Math.min(100,parseFloat(reel))}%;background:linear-gradient(90deg,var(--accent-gradient-start),var(--accent-gradient-end));position:absolute;left:0;top:0;border-radius:6px;opacity:0.8;transition:width 0.5s ease;"></div>
                </div>
                <div style="text-align:right;margin-top:0.25rem">
                    <span class="stat-change ${ecartCls}" style="font-size:0.72rem">${ecart > 0 ? '+' : ''}${ecart}%</span>
                </div>
            </div>`;
        }).join('') + `<div style="padding:0.75rem;background:var(--bg-secondary);border-radius:10px;font-size:0.8rem;color:var(--text-secondary);margin-top:0.5rem;border:1px solid var(--border-color)">
            ğŸ’¡ RÃ©Ã©quilibrez lors de votre prochain versement pour optimiser votre allocation
        </div>`;
    },

    // ===================== PROJECTION RETRAITE =====================
    calculerRetraite() {
        const age = parseInt(document.getElementById('ret-age').value) || 28;
        const ageCible = parseInt(document.getElementById('ret-age-cible').value) || 65;
        const epargne = parseFloat(document.getElementById('ret-epargne').value) || 0;
        const taux = parseFloat(document.getElementById('ret-taux').value) / 100 || 0.06;
        const annees = Math.max(1, ageCible - age);
        const patrimoineActuel = this.data.patrimoine.length > 0 ?
            [...this.data.patrimoine].sort((a, b) => b.mois.localeCompare(a.mois))[0].total : 0;

        const calculer = (t) => {
            const tm = t / 12;
            const mois = annees * 12;
            let val = patrimoineActuel;
            for (let i = 0; i < mois; i++) {
                val = (val + epargne) * (1 + tm);
            }
            return val;
        };

        const realiste = calculer(taux);
        const optimiste = calculer(taux + 0.02);
        const basse = calculer(Math.max(0, taux - 0.02));

        document.getElementById('ret-optimiste').textContent = this.formatCurrency(optimiste);
        document.getElementById('ret-realiste').textContent = this.formatCurrency(realiste);
        document.getElementById('ret-basse').textContent = this.formatCurrency(basse);
        document.getElementById('retraite-results').style.display = 'block';

        const mensuelNecessaire = 500000 > realiste ?
            Math.ceil((500000 - patrimoineActuel) / ((Math.pow(1 + taux/12, annees*12) - 1) / (taux/12) || 1)) : 0;
        document.getElementById('ret-conseil').innerHTML = `
            <strong>ğŸ’¡ Conseil :</strong> Avec votre patrimoine actuel de <strong>${this.formatCurrency(patrimoineActuel)}</strong> et 
            ${epargne > 0 ? `une Ã©pargne de <strong>${this.formatCurrency(epargne)}/mois</strong>` : 'aucune Ã©pargne mensuelle'}, 
            vous accumuleriez environ <strong>${this.formatCurrency(realiste)}</strong> Ã  ${ageCible} ans.
            ${mensuelNecessaire > 0 && mensuelNecessaire > epargne ? `Pour atteindre <strong>500 000 â‚¬</strong>, il faudrait Ã©pargner <strong>${this.formatCurrency(mensuelNecessaire)}/mois</strong>.` : mensuelNecessaire === 0 ? 'ğŸ‰ Vous Ãªtes en bonne voie pour dÃ©passer 500 000 â‚¬ !' : ''}
        `;
    },

    // ===================== EMOJI PICKER =====================
    _emojiData: {
        'ğŸ˜€ Smileys': ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜†','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ™ƒ','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜','ğŸ˜œ','ğŸ¤ª','ğŸ¤¨','ğŸ§','ğŸ¤“','ğŸ˜','ğŸ¤©','ğŸ¥³','ğŸ˜','ğŸ˜’','ğŸ˜','ğŸ˜”','ğŸ˜Ÿ','ğŸ˜•','ğŸ™','â˜¹ï¸','ğŸ˜£','ğŸ˜–','ğŸ˜«','ğŸ˜©','ğŸ¥º','ğŸ˜¢','ğŸ˜­','ğŸ˜¤','ğŸ˜ ','ğŸ˜¡','ğŸ¤¬','ğŸ¤¯','ğŸ˜³','ğŸ¥µ','ğŸ¥¶','ğŸ˜±','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜“','ğŸ¤—','ğŸ¤”','ğŸ¤­','ğŸ¤«','ğŸ¤¥','ğŸ˜¶','ğŸ˜','ğŸ˜‘','ğŸ˜¬','ğŸ™„','ğŸ˜¯','ğŸ˜¦','ğŸ˜§','ğŸ˜®','ğŸ˜²','ğŸ¥±','ğŸ˜´','ğŸ¤¤','ğŸ˜ª','ğŸ˜µ','ğŸ¤','ğŸ¥´','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ˜·','ğŸ¤’','ğŸ¤•'],
        'ğŸ‘‹ Gestes': ['ğŸ‘‹','ğŸ¤š','ğŸ–','âœ‹','ğŸ––','ğŸ‘Œ','ğŸ¤Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª','ğŸ¦¾','ğŸ¦¿','ğŸ¦µ','ğŸ¦¶','ğŸ‘‚','ğŸ¦»','ğŸ‘ƒ','ğŸ§ ','ğŸ‘€','ğŸ‘','ğŸ‘…','ğŸ‘„'],
        'ğŸ‘¨ Personnes': ['ğŸ‘¶','ğŸ§’','ğŸ‘¦','ğŸ‘§','ğŸ§‘','ğŸ‘±','ğŸ‘¨','ğŸ§”','ğŸ‘©','ğŸ§“','ğŸ‘´','ğŸ‘µ','ğŸ™','ğŸ™','ğŸ™…','ğŸ™†','ğŸ’','ğŸ™‹','ğŸ§','ğŸ™‡','ğŸ¤¦','ğŸ¤·','ğŸ‘®','ğŸ•µ','ğŸ’‚','ğŸ¥·','ğŸ‘·','ğŸ¤´','ğŸ‘¸','ğŸ‘°','ğŸ¤µ','ğŸ…','ğŸ¤¶','ğŸ§™','ğŸ§š','ğŸ§›','ğŸ§œ','ğŸ§','ğŸ§','ğŸ§Ÿ','ğŸ§Œ','ğŸ’†','ğŸ’‡','ğŸš¶','ğŸ§','ğŸ§','ğŸƒ','ğŸ’ƒ','ğŸ•º','ğŸ§–','ğŸ›€','ğŸ§—','ğŸ‡','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ§˜'],
        'ğŸ¶ Animaux': ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸœ','ğŸ¦Ÿ','ğŸ¦—','ğŸ•·','ğŸ¦‚','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“','ğŸ¦','ğŸ¦§','ğŸ¦£','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸ¦¬','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸ¦®','ğŸ•â€ğŸ¦º','ğŸˆ','ğŸˆâ€â¬›','ğŸª¶','ğŸ“','ğŸ¦ƒ','ğŸ¦¤','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Š','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦«','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿','ğŸ¦”'],
        'ğŸ Nourriture': ['ğŸ','ğŸŠ','ğŸ‹','ğŸ‡','ğŸ“','ğŸ«','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸ…','ğŸ†','ğŸ¥‘','ğŸ¥¦','ğŸ¥¬','ğŸ¥’','ğŸŒ¶','ğŸ«‘','ğŸ§„','ğŸ§…','ğŸ¥”','ğŸ ','ğŸ¥','ğŸ¥–','ğŸ','ğŸ¥¨','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ§ˆ','ğŸ¥','ğŸ§‡','ğŸ¥“','ğŸ¥©','ğŸ—','ğŸ–','ğŸ¦´','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸ«“','ğŸ¥ª','ğŸ¥™','ğŸ§†','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥—','ğŸ¥˜','ğŸ«•','ğŸ¥«','ğŸ','ğŸœ','ğŸ²','ğŸ›','ğŸ£','ğŸ±','ğŸ¥Ÿ','ğŸ¦ª','ğŸ¤','ğŸ™','ğŸš','ğŸ˜','ğŸ¥','ğŸ¥®','ğŸ¢','ğŸ§','ğŸ°','ğŸ‚','ğŸ®','ğŸ­','ğŸ¬','ğŸ«','ğŸ¿','ğŸ©','ğŸª','ğŸŒ°','ğŸ¥œ','ğŸ¯','ğŸ§ƒ','ğŸ¥¤','ğŸ§‹','â˜•','ğŸµ','ğŸ§‰','ğŸº','ğŸ»','ğŸ¥‚','ğŸ·','ğŸ¥ƒ','ğŸ¸','ğŸ¹','ğŸ§Š'],
        'âš½ Sport': ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸªƒ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸','ğŸ¥Œ','ğŸ¿','â›·','ğŸ‚','ğŸª‚','ğŸ‹','ğŸ¤¼','ğŸ¤¸','â›¹','ğŸ¤º','ğŸ¤¾','ğŸŒ','ğŸ‡','ğŸ§˜','ğŸ„','ğŸŠ','ğŸ¤½','ğŸš£','ğŸ§—','ğŸšµ','ğŸš´','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–','ğŸ—','ğŸ«','ğŸŸ','ğŸª'],
        'ğŸš— Transport': ['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸ','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸ','ğŸ›µ','ğŸš²','ğŸ›´','ğŸ›¹','ğŸ›¼','ğŸš','ğŸ›£','ğŸ›¤','â›½','ğŸš¨','ğŸš¥','ğŸš¦','ğŸ›‘','ğŸš§','âš“','ğŸ›Ÿ','â›µ','ğŸš¤','ğŸ›¥','ğŸ›³','â›´','ğŸš¢','âœˆï¸','ğŸ›©','ğŸ›«','ğŸ›¬','ğŸª‚','ğŸ’º','ğŸš','ğŸšŸ','ğŸš ','ğŸš¡','ğŸ›°','ğŸš€','ğŸ›¸','ğŸš‚','ğŸšƒ','ğŸš„','ğŸš…','ğŸš†','ğŸš‡','ğŸšˆ','ğŸš‰','ğŸšŠ','ğŸš','ğŸš','ğŸš‹','ğŸš','ğŸ›º'],
        'ğŸ  Maison': ['ğŸ ','ğŸ¡','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ§','ğŸ¨','ğŸ©','ğŸª','ğŸ«','ğŸ¬','ğŸ­','ğŸ¯','ğŸ°','ğŸ’’','ğŸ—¼','ğŸ—½','â›ª','ğŸ•Œ','ğŸ›•','ğŸ•','â›©','ğŸ•‹','â›²','â›º','ğŸŒ','ğŸŒƒ','ğŸ™','ğŸŒ„','ğŸŒ…','ğŸŒ†','ğŸŒ‡','ğŸŒ‰','â™¨ï¸','ğŸ ','ğŸ¡','ğŸ¢','ğŸ’ˆ','ğŸª','ğŸ›–'],
        'ğŸ’¡ Objets': ['ğŸ’¡','ğŸ”¦','ğŸ•¯','ğŸª”','ğŸ§±','ğŸª','ğŸªŸ','ğŸ›‹','ğŸª‘','ğŸš½','ğŸª ','ğŸš¿','ğŸ›','ğŸ§´','ğŸ§·','ğŸ§¹','ğŸ§º','ğŸ§»','ğŸª£','ğŸ§¼','ğŸ«§','ğŸª¥','ğŸ§½','ğŸª¤','ğŸª’','ğŸ§¹','ğŸ›’','ğŸšª','ğŸª¤','ğŸ§²','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ©¹','ğŸ©º','ğŸ©»','ğŸ©¼','ğŸ©º','ğŸ”¬','ğŸ”­','ğŸ§¬','ğŸ¦ ','ğŸ§«','ğŸ§ª','ğŸŒ¡','ğŸ§²','ğŸªœ','ğŸ§°','ğŸ”§','ğŸ”¨','âš’','ğŸ› ','â›','ğŸªš','ğŸ”©','ğŸª›','ğŸ”—','â›“','ğŸª','ğŸ§²','ğŸ’°','ğŸ’´','ğŸ’µ','ğŸ’¶','ğŸ’·','ğŸ’¸','ğŸ’³','ğŸª™','ğŸ’¹','âœ‰ï¸','ğŸ“§','ğŸ“¨','ğŸ“©','ğŸ“ª','ğŸ“«','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ—³','âœï¸','âœ’ï¸','ğŸ–‹','ğŸ–Š','ğŸ“','ğŸ“','ğŸ“‚','ğŸ—‚','ğŸ“…','ğŸ“†','ğŸ—’','ğŸ—“','ğŸ“‡','ğŸ“ˆ','ğŸ“‰','ğŸ“Š','ğŸ“‹','ğŸ“Œ','ğŸ“','ğŸ—º','ğŸ“','ğŸ“','âœ‚ï¸','ğŸ—ƒ','ğŸ—„','ğŸ—‘','ğŸ”’','ğŸ”“','ğŸ”','ğŸ”','ğŸ”‘','ğŸ—','ğŸ”¨','ğŸª“','â›','âš’','ğŸ› ','ğŸ—¡','âš”ï¸','ğŸ›¡','ğŸªƒ','ğŸ¹','ğŸª¤','ğŸ”§','ğŸª›','ğŸ”©','âš™ï¸','ğŸ—œ','âš–ï¸','ğŸ¦¯','ğŸ”—','â›“','ğŸª','ğŸ§²','ğŸªœ'],
        'ğŸŒŸ Symboles': ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰','â˜¸ï¸','ğŸ”¯','ğŸª¯','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”','âš›ï¸','ğŸ‰‘','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸','ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¯','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤','ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸ›—','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','âš§','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”£','â„¹ï¸','ğŸ”¤','ğŸ”¡','ğŸ” ','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ†’','ğŸ†•','ğŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ”¢','âï¸','â–¶ï¸','â¸','â¹','âº','â­','â®','â©','âª','â«','â¬','â—€ï¸','ğŸ”¼','ğŸ”½','â¡ï¸','â¬…ï¸','â¬†ï¸','â¬‡ï¸','â†—ï¸','â†˜ï¸','â†™ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†©ï¸','â†ªï¸','â¤´ï¸','â¤µï¸','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ”„','ğŸ”ƒ','ğŸµ','ğŸ¶','â•','â–','â—','âœ–ï¸','â™¾','ğŸ’²','ğŸ’±','â„¢ï¸','Â©ï¸','Â®ï¸','ã€°ï¸','â°','â¿','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”','ğŸ”œ','âœ”ï¸','â˜‘ï¸','ğŸ”˜','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”º','ğŸ”»','ğŸ”·','ğŸ”¶','ğŸ”¹','ğŸ”¸','ğŸ”²','ğŸ”³','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸ”ˆ','ğŸ”‡','ğŸ”‰','ğŸ”Š','ğŸ””','ğŸ”•','ğŸ“£','ğŸ“¢','ğŸ‘â€ğŸ—¨','ğŸ’¬','ğŸ’­','ğŸ—¯'],
        'ğŸŒˆ Nature': ['ğŸŒ¸','ğŸŒº','ğŸŒ»','ğŸŒ¹','ğŸ¥€','ğŸŒ·','ğŸŒ±','ğŸŒ²','ğŸŒ³','ğŸŒ´','ğŸŒµ','ğŸ‹','ğŸ','ğŸ€','ğŸ','ğŸ‚','ğŸƒ','ğŸª´','ğŸª·','ğŸ’','ğŸŒ¾','ğŸ„','ğŸš','ğŸª¸','ğŸª¨','ğŸŒŠ','ğŸ’§','ğŸ’¦','ğŸŒ§','ğŸŒ©','ğŸŒ¨','â„ï¸','ğŸŒ¬','ğŸŒ€','ğŸŒˆ','ğŸŒ‚','â˜‚ï¸','â˜”','â›±','âš¡','â„ï¸','ğŸ”¥','ğŸ’§','ğŸŒŠ','ğŸŒ','ğŸŒ','ğŸŒ','ğŸŒ','ğŸª','ğŸ’«','â­','ğŸŒŸ','âœ¨','âš¡','â˜„ï¸','ğŸ’¥','ğŸ”¥','ğŸŒª','ğŸŒˆ','ğŸŒ¤','â›…','ğŸŒ¥','â˜ï¸','ğŸŒ¦','ğŸŒ§','â›ˆ','ğŸŒ©','ğŸŒ¨','â„ï¸','â˜ƒï¸','â›„','ğŸŒ¬','ğŸ’¨','ğŸ’§','ğŸ’¦','ğŸŒŠ'],
        'ğŸ‰ FÃªtes': ['ğŸ‰','ğŸŠ','ğŸˆ','ğŸ','ğŸ€','ğŸ—','ğŸŸ','ğŸ«','ğŸ–','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸƒ','ğŸ„','ğŸ†','ğŸ‡','ğŸ§¨','âœ¨','ğŸ‹','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ§§','ğŸ€','ğŸ','ğŸ—','ğŸŸ','ğŸ«','ğŸ ','ğŸ¡','ğŸ¢','ğŸª','ğŸ¤¹','ğŸ­','ğŸ©°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸµ','ğŸ¶','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸª•','ğŸ¥','ğŸª˜','ğŸ®','ğŸ•¹','ğŸ²','ğŸ§©','ğŸ§¸','ğŸª†','â™ ï¸','â™¥ï¸','â™¦ï¸','â™£ï¸','â™Ÿ','ğŸƒ','ğŸ€„','ğŸ´'],
        'ğŸ’¼ Travail': ['ğŸ’¼','ğŸ“','ğŸ“‚','ğŸ—‚','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ“‹','ğŸ“Œ','ğŸ“','ğŸ“','ğŸ–‡','ğŸ“','ğŸ“','âœ‚ï¸','ğŸ—ƒ','ğŸ—„','ğŸ—‘','ğŸ’¡','ğŸ”¦','ğŸ–Š','ğŸ–‹','âœ’ï¸','ğŸ“','ğŸ’»','ğŸ–¥','ğŸ–¨','âŒ¨ï¸','ğŸ–±','ğŸ–²','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ§®','ğŸ“±','â˜ï¸','ğŸ“','ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½','ğŸ','ğŸ“¡','ğŸ”‹','ğŸª«','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯','ğŸª”','ğŸ§±','ğŸ”®','ğŸª„','ğŸ§¿','ğŸª¬','ğŸ§¸','ğŸ­','ğŸ¨'],
    },
    _emojiTarget: null,
    _emojiAllFlat: null,

    initEmojiPicker() {
        const picker = document.getElementById('emojiPicker');
        const catTabs = document.getElementById('emoji-cat-tabs');
        const grid = document.getElementById('emoji-grid');

        // Flatten all emojis for search
        this._emojiAllFlat = Object.values(this._emojiData).flat();

        // Build category tabs
        const cats = Object.keys(this._emojiData);
        catTabs.innerHTML = cats.map((cat, i) => {
            const icon = cat.split(' ')[0];
            return `<button class="emoji-cat-btn ${i === 0 ? 'active' : ''}" onclick="app.emojiShowCat('${cat}', this)" title="${cat}">${icon}</button>`;
        }).join('');

        // Show first category
        this.emojiShowCat(cats[0], catTabs.firstElementChild);

        // Close on outside click
        document.addEventListener('click', (e) => {
            if (!picker.contains(e.target) && !e.target.classList.contains('emoji-preview-btn')) {
                picker.classList.remove('open');
            }
        });
    },

    emojiShowCat(cat, btn) {
        document.querySelectorAll('.emoji-cat-btn').forEach(b => b.classList.remove('active'));
        if (btn) btn.classList.add('active');
        const emojis = this._emojiData[cat] || [];
        this.emojiRenderGrid(emojis);
    },

    _emojiKeywords: {
        // Smileys
        'ğŸ˜€':'sourire content heureux','ğŸ˜‚':'rire larmes','ğŸ˜':'amour coeur yeux','ğŸ˜':'cool lunettes','ğŸ˜­':'pleurer triste','ğŸ˜¡':'colÃ¨re fÃ¢chÃ©','ğŸ¤”':'rÃ©flÃ©chir question','ğŸ˜´':'dormir sommeil','ğŸ¤¢':'malade nausÃ©e','ğŸ¤§':'rhume Ã©ternuer','ğŸ˜·':'masque malade',
        // Objets courants
        'ğŸ ':'maison home logement','ğŸ¡':'maison jardin','ğŸ¢':'bureau immeuble travail','ğŸ¥':'hÃ´pital mÃ©decin santÃ©','ğŸ¦':'banque argent','ğŸª':'magasin boutique','ğŸ«':'Ã©cole universitÃ©','ğŸš—':'voiture auto vÃ©hicule','ğŸš•':'taxi voiture','ğŸš™':'SUV voiture','ğŸš²':'vÃ©lo cyclisme','ğŸ›µ':'scooter moto','ğŸ':'moto','âœˆï¸':'avion voyage vol','ğŸš‚':'train','ğŸšŒ':'bus transport','âš“':'ancre bateau','ğŸš€':'fusÃ©e espace','ğŸ›¸':'ovni vaisseau',
        // Nourriture
        'ğŸ':'pomme fruit','ğŸŠ':'orange fruit','ğŸ‹':'citron','ğŸ‡':'raisin fruit','ğŸ“':'fraise fruit','ğŸ•':'pizza','ğŸ”':'burger hamburger','ğŸŸ':'frites','ğŸŒ®':'taco','ğŸœ':'ramen nouilles','ğŸ£':'sushi japonais','ğŸº':'biÃ¨re alcool','ğŸ·':'vin alcool rouge','â˜•':'cafÃ© thÃ© boisson','ğŸ§ƒ':'jus boisson',
        // Nature
        'ğŸŒ¸':'fleur cerisier','ğŸŒº':'fleur hibiscus','ğŸŒ»':'tournesol fleur','ğŸŒ¹':'rose fleur','ğŸŒ±':'plante pousse','ğŸŒ²':'arbre forÃªt','ğŸŒ´':'palmier tropical','ğŸŒµ':'cactus dÃ©sert','ğŸ€':'trÃ¨fle chance','â„ï¸':'neige froid hiver','ğŸ”¥':'feu flamme chaud','ğŸ’§':'eau goutte','ğŸŒŠ':'vague mer ocean','ğŸŒˆ':'arc-en-ciel','â­':'Ã©toile','ğŸŒ™':'lune nuit','â˜€ï¸':'soleil journÃ©e',
        // Animaux
        'ğŸ¶':'chien animal','ğŸ±':'chat animal','ğŸ­':'souris animal','ğŸ°':'lapin animal','ğŸ»':'ours animal','ğŸ¼':'panda animal','ğŸ¦Š':'renard animal','ğŸ¯':'tigre animal','ğŸ¦':'lion animal','ğŸ®':'vache animal','ğŸ·':'cochon animal','ğŸ¸':'grenouille animal','ğŸ ':'poisson mer','ğŸ¬':'dauphin mer','ğŸ¦‹':'papillon insecte','ğŸ':'abeille insecte',
        // Sport
        'âš½':'foot football sport','ğŸ€':'basket basketball sport','ğŸ¾':'tennis sport','ğŸŠ':'natation nager sport','ğŸš´':'cyclisme vÃ©lo sport','ğŸ†':'trophÃ©e victoire gagnant','ğŸ¥‡':'mÃ©daille or premier','ğŸ¯':'cible objectif but',
        // Travail & argent
        'ğŸ’¼':'travail bureau mallette','ğŸ’»':'ordinateur pc travail','ğŸ“±':'tÃ©lÃ©phone mobile','ğŸ’°':'argent monnaie sac','ğŸ’µ':'billet argent dollar','ğŸ’³':'carte crÃ©dit paiement','ğŸ’¸':'argent dÃ©pense payer','ğŸ“Š':'graphique stats donnÃ©es','ğŸ“ˆ':'hausse croissance','ğŸ“‰':'baisse perte','ğŸ§':'distributeur ATM','ğŸ’¹':'bourse finance','ğŸ“':'note Ã©crire liste','ğŸ“…':'calendrier date','âœ‰ï¸':'email lettre message','ğŸ“':'tÃ©lÃ©phone appel',
        // SantÃ©
        'ğŸ’Š':'mÃ©dicament pilule santÃ©','ğŸ’‰':'vaccin injection santÃ©','ğŸ©º':'mÃ©decin docteur santÃ©','ğŸ‹':'musculation gym sport','ğŸ§˜':'yoga mÃ©ditation',
        // FÃªtes & Ã©motions
        'ğŸ‰':'fÃªte anniversaire cÃ©lÃ©bration','ğŸŠ':'fÃªte confetti','ğŸ':'cadeau prÃ©sent','ğŸ‚':'gÃ¢teau anniversaire','ğŸ„':'noÃ«l sapin','â¤ï¸':'amour coeur','ğŸ’”':'coeur brisÃ©','ğŸ’¯':'cent parfait','âœ…':'validÃ© ok oui','âŒ':'non croix annuler','âš ï¸':'attention danger alerte','ğŸ””':'notification cloche alerte','ğŸ”•':'silencieux muet',
        // Maison & vie
        'ğŸ›’':'courses shopping chariot','ğŸ§¹':'mÃ©nage nettoyer','ğŸ§º':'linge lavage','ğŸ›':'bain douche','ğŸš¿':'douche','ğŸª´':'plante intÃ©rieur','ğŸ›‹':'canapÃ© salon','ğŸª‘':'chaise','ğŸšª':'porte','ğŸ’¡':'lampe idÃ©e lumiÃ¨re','ğŸ”‘':'clÃ© porte','ğŸ”’':'serrure sÃ©curitÃ©',
        // RÃ©currences typiques
        'ğŸ“º':'tÃ©lÃ© streaming Netflix','ğŸµ':'musique Spotify abonnement','ğŸŒ':'internet box wifi','ğŸ ':'loyer logement maison','ğŸ’ˆ':'coiffeur salon','ğŸš¿':'eau facture','âš¡':'Ã©lectricitÃ© facture','ğŸ”¥':'gaz facture chauffage','ğŸ“¦':'abonnement livraison colis','ğŸšŒ':'transport abonnement',
    },

    emojiSearch(query) {
        const picker = document.getElementById('emojiPicker');
        if (!query.trim()) {
            const firstCat = Object.keys(this._emojiData)[0];
            this.emojiShowCat(firstCat, document.querySelector('.emoji-cat-btn'));
            document.querySelectorAll('.emoji-cat-btn').forEach(b => b.style.opacity = '');
            return;
        }
        // DÃ©sactiver les onglets catÃ©gorie visuellement
        document.querySelectorAll('.emoji-cat-btn').forEach(b => {
            b.classList.remove('active');
            b.style.opacity = '0.3';
        });
        const q = query.toLowerCase().trim();
        const all = this._emojiAllFlat;
        // 1. Recherche par mots-clÃ©s franÃ§ais
        const byKeyword = all.filter(e => {
            const kw = this._emojiKeywords[e] || '';
            return kw.toLowerCase().includes(q);
        });
        // 2. Recherche dans les noms de catÃ©gories
        const byCat = [];
        Object.entries(this._emojiData).forEach(([cat, emojis]) => {
            if (cat.toLowerCase().includes(q)) byCat.push(...emojis);
        });
        // Fusionner sans doublons
        const results = [...new Set([...byKeyword, ...byCat])];
        this.emojiRenderGrid(results.length > 0 ? results : []);
        if (results.length === 0) {
            document.getElementById('emoji-grid').innerHTML = `<div style="grid-column:1/-1;text-align:center;padding:1rem;color:var(--text-tertiary);font-size:0.8rem">Aucun rÃ©sultat pour "${query}"</div>`;
        }
    },

    emojiRenderGrid(emojis) {
        const grid = document.getElementById('emoji-grid');
        grid.innerHTML = emojis.map(e =>
            `<button class="emoji-btn" onclick="app.emojiSelect('${e}')" title="${e}">${e}</button>`
        ).join('');
    },

    openEmojiPicker(targetInputId, btn) {
        this._emojiTarget = targetInputId;
        const picker = document.getElementById('emojiPicker');
        const rect = btn.getBoundingClientRect();
        // Position above or below the button
        const spaceBelow = window.innerHeight - rect.bottom;
        picker.style.left = Math.min(rect.left, window.innerWidth - 330) + 'px';
        if (spaceBelow > 400) {
            picker.style.top = (rect.bottom + 6) + 'px';
            picker.style.bottom = 'auto';
        } else {
            picker.style.bottom = (window.innerHeight - rect.top + 6) + 'px';
            picker.style.top = 'auto';
        }
        document.getElementById('emoji-search').value = '';
        const firstCat = Object.keys(this._emojiData)[0];
        this.emojiShowCat(firstCat, document.querySelector('.emoji-cat-btn'));
        picker.classList.toggle('open');
    },

    emojiSelect(emoji) {
        if (this._emojiTarget) {
            const input = document.getElementById(this._emojiTarget);
            if (input) {
                input.value = emoji;
                // Update the preview button
                const btn = input.closest('.emoji-picker-wrap')?.querySelector('.emoji-preview-btn');
                if (btn) btn.textContent = emoji;
            }
        }
        document.getElementById('emojiPicker').classList.remove('open');
    },

    notify(msg, type = 'success') {
        const notif = document.createElement('div');
        notif.className = 'notification ' + type;
        notif.textContent = msg;
        document.body.appendChild(notif);
        setTimeout(() => notif.remove(), 3000);
    }
};

document.addEventListener('DOMContentLoaded', () => {
    app.init();

    // Alerte si on ferme la page sans avoir sauvegardÃ©
    window.addEventListener('beforeunload', (e) => {
        const lastSave = app.data?.parametres?.lastBackup;
        const lastChange = app._lastChange;
        if (lastChange && (!lastSave || lastChange > lastSave)) {
            e.preventDefault();
            e.returnValue = 'Avez-vous enregistrÃ© vos modifications ?';
            return 'Avez-vous enregistrÃ© vos modifications ?';
        }
    });
});
</script>
</body>
</html>
